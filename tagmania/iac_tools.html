<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>tagmania.iac_tools API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../tagmania.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;tagmania</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#ClusterSet">ClusterSet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ClusterSet.__init__">ClusterSet</a>
                        </li>
                        <li>
                                <a class="variable" href="#ClusterSet.AUTOMATION_KEY">AUTOMATION_KEY</a>
                        </li>
                        <li>
                                <a class="variable" href="#ClusterSet.cluster_names">cluster_names</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_cluster_filter">get_cluster_filter</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_instances">get_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_deployed_clusters">get_deployed_clusters</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_deployed_cluster_names">get_deployed_cluster_names</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_running_instances">get_running_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_running_clusters">get_running_clusters</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_stopped_instances">get_stopped_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_stopped_clusters">get_stopped_clusters</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.start_instances">start_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.stop_instances">stop_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.tag_instances">tag_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.untag_instances">untag_instances</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_volumes">get_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_kubernetes_volumes">get_kubernetes_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_restored_volumes">get_restored_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.attach_volumes">attach_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.create_volumes">create_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.delete_volumes">delete_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.delete_kubernetes_volumes">delete_kubernetes_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.detach_volumes">detach_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.tag_volumes">tag_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.untag_volumes">untag_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.wait_for_volumes">wait_for_volumes</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_snapshots">get_snapshots</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.create_snapshots">create_snapshots</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.delete_snapshots">delete_snapshots</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.tag_snapshots">tag_snapshots</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.untag_snapshots">untag_snapshots</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.get_subnet">get_subnet</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.tag_subnet">tag_subnet</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.untag_subnet">untag_subnet</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.stop_instances_targeted">stop_instances_targeted</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.start_instances_targeted">start_instances_targeted</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.detach_volumes_targeted">detach_volumes_targeted</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.delete_volumes_targeted">delete_volumes_targeted</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.create_volumes_targeted">create_volumes_targeted</a>
                        </li>
                        <li>
                                <a class="function" href="#ClusterSet.attach_volumes_targeted">attach_volumes_targeted</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TagSet">TagSet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TagSet.__init__">TagSet</a>
                        </li>
                        <li>
                                <a class="function" href="#TagSet.add">add</a>
                        </li>
                        <li>
                                <a class="function" href="#TagSet.get">get</a>
                        </li>
                        <li>
                                <a class="function" href="#TagSet.to_list">to_list</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FilterSet">FilterSet</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FilterSet.__init__">FilterSet</a>
                        </li>
                        <li>
                                <a class="function" href="#FilterSet.add">add</a>
                        </li>
                        <li>
                                <a class="function" href="#FilterSet.get">get</a>
                        </li>
                        <li>
                                <a class="function" href="#FilterSet.to_list">to_list</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../tagmania.html">tagmania</a><wbr>.iac_tools    </h1>

                        <div class="docstring"><p>Infrastructure as Code (IAC) Tools for AWS Resource Management.</p>

<p>This module provides the core infrastructure tools for managing AWS resources
through tag-based operations. It includes classes for cluster management,
resource filtering, and tag operations.</p>

<p>Core Components:
    - ClusterSet: Manages collections of EC2 instances based on cluster tags
    - TagSet: Handles tag operations on AWS resources
    - FilterSet: Manages AWS resource filtering based on tags
    - Utilities: Helper functions for AWS operations</p>

<p>The tools in this module provide the foundation for all cluster operations with
built-in safety limits and automation tracking to ensure only managed resources
are modified.</p>
</div>

                        <input id="mod-iac_tools-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-iac_tools-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos"> 1</span></a><span class="sd">&quot;&quot;&quot;Infrastructure as Code (IAC) Tools for AWS Resource Management.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos"> 2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos"> 3</span></a><span class="sd">This module provides the core infrastructure tools for managing AWS resources</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos"> 4</span></a><span class="sd">through tag-based operations. It includes classes for cluster management,</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos"> 5</span></a><span class="sd">resource filtering, and tag operations.</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos"> 6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos"> 7</span></a><span class="sd">Core Components:</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos"> 8</span></a><span class="sd">    - ClusterSet: Manages collections of EC2 instances based on cluster tags</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos"> 9</span></a><span class="sd">    - TagSet: Handles tag operations on AWS resources</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">10</span></a><span class="sd">    - FilterSet: Manages AWS resource filtering based on tags</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">11</span></a><span class="sd">    - Utilities: Helper functions for AWS operations</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos">13</span></a><span class="sd">The tools in this module provide the foundation for all cluster operations with</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">14</span></a><span class="sd">built-in safety limits and automation tracking to ensure only managed resources</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">15</span></a><span class="sd">are modified.</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">16</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos">18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.clusterset</span><span class="w"> </span><span class="kn">import</span> <span class="n">ClusterSet</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.tagset</span><span class="w"> </span><span class="kn">import</span> <span class="n">TagSet</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.filterset</span><span class="w"> </span><span class="kn">import</span> <span class="n">FilterSet</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">22</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ClusterSet&quot;</span><span class="p">,</span> <span class="s2">&quot;TagSet&quot;</span><span class="p">,</span> <span class="s2">&quot;FilterSet&quot;</span><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="ClusterSet">
                            <input id="ClusterSet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ClusterSet</span>:

                <label class="view-source-button" for="ClusterSet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet-54"><a href="#ClusterSet-54"><span class="linenos">  54</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ClusterSet</span><span class="p">:</span>
</span><span id="ClusterSet-55"><a href="#ClusterSet-55"><span class="linenos">  55</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages collections of EC2 instances based on cluster tags.</span>
</span><span id="ClusterSet-56"><a href="#ClusterSet-56"><span class="linenos">  56</span></a>
</span><span id="ClusterSet-57"><a href="#ClusterSet-57"><span class="linenos">  57</span></a><span class="sd">    The ClusterSet class provides comprehensive cluster management functionality</span>
</span><span id="ClusterSet-58"><a href="#ClusterSet-58"><span class="linenos">  58</span></a><span class="sd">    including instance lifecycle management, volume operations, and snapshot</span>
</span><span id="ClusterSet-59"><a href="#ClusterSet-59"><span class="linenos">  59</span></a><span class="sd">    management. It uses tag-based resource identification to ensure operations</span>
</span><span id="ClusterSet-60"><a href="#ClusterSet-60"><span class="linenos">  60</span></a><span class="sd">    only affect intended resources.</span>
</span><span id="ClusterSet-61"><a href="#ClusterSet-61"><span class="linenos">  61</span></a>
</span><span id="ClusterSet-62"><a href="#ClusterSet-62"><span class="linenos">  62</span></a><span class="sd">    Attributes:</span>
</span><span id="ClusterSet-63"><a href="#ClusterSet-63"><span class="linenos">  63</span></a><span class="sd">        cluster_names: The name(s) of the cluster(s) being managed</span>
</span><span id="ClusterSet-64"><a href="#ClusterSet-64"><span class="linenos">  64</span></a><span class="sd">        _MAX_ITEMS: Safety limit for collection operations (150)</span>
</span><span id="ClusterSet-65"><a href="#ClusterSet-65"><span class="linenos">  65</span></a><span class="sd">        AUTOMATION_KEY: Key used to track managed resources (&#39;SNAPSHOT_MANAGER&#39;)</span>
</span><span id="ClusterSet-66"><a href="#ClusterSet-66"><span class="linenos">  66</span></a>
</span><span id="ClusterSet-67"><a href="#ClusterSet-67"><span class="linenos">  67</span></a><span class="sd">    Note:</span>
</span><span id="ClusterSet-68"><a href="#ClusterSet-68"><span class="linenos">  68</span></a><span class="sd">        All operations rely on the &quot;Cluster&quot; tag to identify cluster membership.</span>
</span><span id="ClusterSet-69"><a href="#ClusterSet-69"><span class="linenos">  69</span></a><span class="sd">        The class includes built-in safety features to prevent accidental</span>
</span><span id="ClusterSet-70"><a href="#ClusterSet-70"><span class="linenos">  70</span></a><span class="sd">        modification of unmanaged resources.</span>
</span><span id="ClusterSet-71"><a href="#ClusterSet-71"><span class="linenos">  71</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ClusterSet-72"><a href="#ClusterSet-72"><span class="linenos">  72</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster_names</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ClusterSet-73"><a href="#ClusterSet-73"><span class="linenos">  73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize ClusterSet for managing one or more clusters.</span>
</span><span id="ClusterSet-74"><a href="#ClusterSet-74"><span class="linenos">  74</span></a>
</span><span id="ClusterSet-75"><a href="#ClusterSet-75"><span class="linenos">  75</span></a><span class="sd">        Creates a new ClusterSet instance for managing EC2 instances and related</span>
</span><span id="ClusterSet-76"><a href="#ClusterSet-76"><span class="linenos">  76</span></a><span class="sd">        resources (volumes, snapshots) for the specified cluster(s). Sets up</span>
</span><span id="ClusterSet-77"><a href="#ClusterSet-77"><span class="linenos">  77</span></a><span class="sd">        AWS connectivity and initializes safety limits and automation tracking.</span>
</span><span id="ClusterSet-78"><a href="#ClusterSet-78"><span class="linenos">  78</span></a>
</span><span id="ClusterSet-79"><a href="#ClusterSet-79"><span class="linenos">  79</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-80"><a href="#ClusterSet-80"><span class="linenos">  80</span></a><span class="sd">            cluster_names: The name of a cluster (str) or list of cluster names (list).</span>
</span><span id="ClusterSet-81"><a href="#ClusterSet-81"><span class="linenos">  81</span></a><span class="sd">                         Must match the &quot;Cluster&quot; tag value on EC2 instances.</span>
</span><span id="ClusterSet-82"><a href="#ClusterSet-82"><span class="linenos">  82</span></a><span class="sd">            profile: AWS profile name to use for authentication (optional).</span>
</span><span id="ClusterSet-83"><a href="#ClusterSet-83"><span class="linenos">  83</span></a><span class="sd">                    If None, uses default AWS credentials chain.</span>
</span><span id="ClusterSet-84"><a href="#ClusterSet-84"><span class="linenos">  84</span></a>
</span><span id="ClusterSet-85"><a href="#ClusterSet-85"><span class="linenos">  85</span></a><span class="sd">        Example:</span>
</span><span id="ClusterSet-86"><a href="#ClusterSet-86"><span class="linenos">  86</span></a><span class="sd">            ```python</span>
</span><span id="ClusterSet-87"><a href="#ClusterSet-87"><span class="linenos">  87</span></a><span class="sd">            # Single cluster</span>
</span><span id="ClusterSet-88"><a href="#ClusterSet-88"><span class="linenos">  88</span></a><span class="sd">            cluster = ClusterSet(&#39;production-web&#39;)</span>
</span><span id="ClusterSet-89"><a href="#ClusterSet-89"><span class="linenos">  89</span></a>
</span><span id="ClusterSet-90"><a href="#ClusterSet-90"><span class="linenos">  90</span></a><span class="sd">            # Multiple clusters</span>
</span><span id="ClusterSet-91"><a href="#ClusterSet-91"><span class="linenos">  91</span></a><span class="sd">            clusters = ClusterSet([&#39;prod-web&#39;, &#39;prod-api&#39;])</span>
</span><span id="ClusterSet-92"><a href="#ClusterSet-92"><span class="linenos">  92</span></a>
</span><span id="ClusterSet-93"><a href="#ClusterSet-93"><span class="linenos">  93</span></a><span class="sd">            # With specific AWS profile</span>
</span><span id="ClusterSet-94"><a href="#ClusterSet-94"><span class="linenos">  94</span></a><span class="sd">            cluster = ClusterSet(&#39;staging&#39;, profile=&#39;dev-account&#39;)</span>
</span><span id="ClusterSet-95"><a href="#ClusterSet-95"><span class="linenos">  95</span></a><span class="sd">            ```</span>
</span><span id="ClusterSet-96"><a href="#ClusterSet-96"><span class="linenos">  96</span></a>
</span><span id="ClusterSet-97"><a href="#ClusterSet-97"><span class="linenos">  97</span></a><span class="sd">        Note:</span>
</span><span id="ClusterSet-98"><a href="#ClusterSet-98"><span class="linenos">  98</span></a><span class="sd">            The cluster names must exactly match the &quot;Cluster&quot; tag values</span>
</span><span id="ClusterSet-99"><a href="#ClusterSet-99"><span class="linenos">  99</span></a><span class="sd">            on your EC2 instances for operations to work correctly.</span>
</span><span id="ClusterSet-100"><a href="#ClusterSet-100"><span class="linenos"> 100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-101"><a href="#ClusterSet-101"><span class="linenos"> 101</span></a>        <span class="c1"># Collections operate lazily. Turning a collection into a list can cause</span>
</span><span id="ClusterSet-102"><a href="#ClusterSet-102"><span class="linenos"> 102</span></a>        <span class="c1"># performance issues if the collection is very large. Although this is</span>
</span><span id="ClusterSet-103"><a href="#ClusterSet-103"><span class="linenos"> 103</span></a>        <span class="c1"># unlikely in our environment, we protect against this by setting an</span>
</span><span id="ClusterSet-104"><a href="#ClusterSet-104"><span class="linenos"> 104</span></a>        <span class="c1"># upper bound on the number of items from the collection that can be</span>
</span><span id="ClusterSet-105"><a href="#ClusterSet-105"><span class="linenos"> 105</span></a>        <span class="c1"># placed in the list. If the number of items in the collection exceed</span>
</span><span id="ClusterSet-106"><a href="#ClusterSet-106"><span class="linenos"> 106</span></a>        <span class="c1"># this upper bound, then those items will not be processed. If this</span>
</span><span id="ClusterSet-107"><a href="#ClusterSet-107"><span class="linenos"> 107</span></a>        <span class="c1"># happens, then it can be addressed by increasing this value.</span>
</span><span id="ClusterSet-108"><a href="#ClusterSet-108"><span class="linenos"> 108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span> <span class="o">=</span> <span class="mi">150</span>
</span><span id="ClusterSet-109"><a href="#ClusterSet-109"><span class="linenos"> 109</span></a>
</span><span id="ClusterSet-110"><a href="#ClusterSet-110"><span class="linenos"> 110</span></a>        <span class="c1"># Used to ensure we don&#39;t clobber anything we don&#39;t make</span>
</span><span id="ClusterSet-111"><a href="#ClusterSet-111"><span class="linenos"> 111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span> <span class="o">=</span> <span class="s1">&#39;SNAPSHOT_MANAGER&#39;</span>
</span><span id="ClusterSet-112"><a href="#ClusterSet-112"><span class="linenos"> 112</span></a>
</span><span id="ClusterSet-113"><a href="#ClusterSet-113"><span class="linenos"> 113</span></a>        <span class="c1"># cluster_names can be a string &#39;aws-dev5&#39; or a list [&#39;aws-dev1&#39;, &#39;aws-dev2&#39;, etc...]</span>
</span><span id="ClusterSet-114"><a href="#ClusterSet-114"><span class="linenos"> 114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span> <span class="o">=</span> <span class="n">cluster_names</span>
</span><span id="ClusterSet-115"><a href="#ClusterSet-115"><span class="linenos"> 115</span></a>
</span><span id="ClusterSet-116"><a href="#ClusterSet-116"><span class="linenos"> 116</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cluster_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ClusterSet-117"><a href="#ClusterSet-117"><span class="linenos"> 117</span></a>            <span class="n">cluster_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">]</span>
</span><span id="ClusterSet-118"><a href="#ClusterSet-118"><span class="linenos"> 118</span></a>
</span><span id="ClusterSet-119"><a href="#ClusterSet-119"><span class="linenos"> 119</span></a>        <span class="c1"># Use this as a starting point to build filters that only return</span>
</span><span id="ClusterSet-120"><a href="#ClusterSet-120"><span class="linenos"> 120</span></a>        <span class="c1"># resources associated with this cluster. Use the &#39;get_cluster_filter&#39;</span>
</span><span id="ClusterSet-121"><a href="#ClusterSet-121"><span class="linenos"> 121</span></a>        <span class="c1"># method to get a copy of it rather than doing direct assignment.</span>
</span><span id="ClusterSet-122"><a href="#ClusterSet-122"><span class="linenos"> 122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_filter</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ClusterSet-123"><a href="#ClusterSet-123"><span class="linenos"> 123</span></a>            <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="n">cluster_names</span><span class="p">},</span>
</span><span id="ClusterSet-124"><a href="#ClusterSet-124"><span class="linenos"> 124</span></a>        <span class="p">]</span>
</span><span id="ClusterSet-125"><a href="#ClusterSet-125"><span class="linenos"> 125</span></a>
</span><span id="ClusterSet-126"><a href="#ClusterSet-126"><span class="linenos"> 126</span></a>        <span class="c1"># Set up logging</span>
</span><span id="ClusterSet-127"><a href="#ClusterSet-127"><span class="linenos"> 127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;tagmania&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-128"><a href="#ClusterSet-128"><span class="linenos"> 128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="ClusterSet-129"><a href="#ClusterSet-129"><span class="linenos"> 129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging initialized.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-130"><a href="#ClusterSet-130"><span class="linenos"> 130</span></a>
</span><span id="ClusterSet-131"><a href="#ClusterSet-131"><span class="linenos"> 131</span></a>        <span class="c1"># Create a boto3 session using the specified profile if provided.</span>
</span><span id="ClusterSet-132"><a href="#ClusterSet-132"><span class="linenos"> 132</span></a>        <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
</span><span id="ClusterSet-133"><a href="#ClusterSet-133"><span class="linenos"> 133</span></a>            <span class="n">aws_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile</span><span class="p">)</span>
</span><span id="ClusterSet-134"><a href="#ClusterSet-134"><span class="linenos"> 134</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using AWS profile: </span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-135"><a href="#ClusterSet-135"><span class="linenos"> 135</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-136"><a href="#ClusterSet-136"><span class="linenos"> 136</span></a>            <span class="n">aws_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span><span id="ClusterSet-137"><a href="#ClusterSet-137"><span class="linenos"> 137</span></a>
</span><span id="ClusterSet-138"><a href="#ClusterSet-138"><span class="linenos"> 138</span></a>        <span class="c1"># Create EC2 resource and client from the session.</span>
</span><span id="ClusterSet-139"><a href="#ClusterSet-139"><span class="linenos"> 139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span> <span class="o">=</span> <span class="n">aws_session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-140"><a href="#ClusterSet-140"><span class="linenos"> 140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span> <span class="o">=</span> <span class="n">aws_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-141"><a href="#ClusterSet-141"><span class="linenos"> 141</span></a>
</span><span id="ClusterSet-142"><a href="#ClusterSet-142"><span class="linenos"> 142</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cluster_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-143"><a href="#ClusterSet-143"><span class="linenos"> 143</span></a>        <span class="c1"># Return a copy to defend against modifications</span>
</span><span id="ClusterSet-144"><a href="#ClusterSet-144"><span class="linenos"> 144</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_filter</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="ClusterSet-145"><a href="#ClusterSet-145"><span class="linenos"> 145</span></a>
</span><span id="ClusterSet-146"><a href="#ClusterSet-146"><span class="linenos"> 146</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-147"><a href="#ClusterSet-147"><span class="linenos"> 147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all EC2 instances belonging to this cluster set.</span>
</span><span id="ClusterSet-148"><a href="#ClusterSet-148"><span class="linenos"> 148</span></a>
</span><span id="ClusterSet-149"><a href="#ClusterSet-149"><span class="linenos"> 149</span></a><span class="sd">        Retrieves all EC2 instances that have a &quot;Cluster&quot; tag matching any of the</span>
</span><span id="ClusterSet-150"><a href="#ClusterSet-150"><span class="linenos"> 150</span></a><span class="sd">        cluster names specified during initialization. The instances are filtered</span>
</span><span id="ClusterSet-151"><a href="#ClusterSet-151"><span class="linenos"> 151</span></a><span class="sd">        using the cluster filter and limited by the safety maximum (_MAX_ITEMS).</span>
</span><span id="ClusterSet-152"><a href="#ClusterSet-152"><span class="linenos"> 152</span></a>
</span><span id="ClusterSet-153"><a href="#ClusterSet-153"><span class="linenos"> 153</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-154"><a href="#ClusterSet-154"><span class="linenos"> 154</span></a><span class="sd">            list: List of EC2 instance objects from boto3. Each instance object</span>
</span><span id="ClusterSet-155"><a href="#ClusterSet-155"><span class="linenos"> 155</span></a><span class="sd">                 contains all AWS instance metadata including ID, state, tags, etc.</span>
</span><span id="ClusterSet-156"><a href="#ClusterSet-156"><span class="linenos"> 156</span></a>
</span><span id="ClusterSet-157"><a href="#ClusterSet-157"><span class="linenos"> 157</span></a><span class="sd">        Example:</span>
</span><span id="ClusterSet-158"><a href="#ClusterSet-158"><span class="linenos"> 158</span></a><span class="sd">            ```python</span>
</span><span id="ClusterSet-159"><a href="#ClusterSet-159"><span class="linenos"> 159</span></a><span class="sd">            cluster = ClusterSet(&#39;production-web&#39;)</span>
</span><span id="ClusterSet-160"><a href="#ClusterSet-160"><span class="linenos"> 160</span></a><span class="sd">            instances = cluster.get_instances()</span>
</span><span id="ClusterSet-161"><a href="#ClusterSet-161"><span class="linenos"> 161</span></a><span class="sd">            for instance in instances:</span>
</span><span id="ClusterSet-162"><a href="#ClusterSet-162"><span class="linenos"> 162</span></a><span class="sd">                print(f&quot;Instance {instance.id} is {instance.state[&#39;Name&#39;]}&quot;)</span>
</span><span id="ClusterSet-163"><a href="#ClusterSet-163"><span class="linenos"> 163</span></a><span class="sd">            ```</span>
</span><span id="ClusterSet-164"><a href="#ClusterSet-164"><span class="linenos"> 164</span></a>
</span><span id="ClusterSet-165"><a href="#ClusterSet-165"><span class="linenos"> 165</span></a><span class="sd">        Note:</span>
</span><span id="ClusterSet-166"><a href="#ClusterSet-166"><span class="linenos"> 166</span></a><span class="sd">            Returns a maximum of _MAX_ITEMS (150) instances for performance protection.</span>
</span><span id="ClusterSet-167"><a href="#ClusterSet-167"><span class="linenos"> 167</span></a><span class="sd">            If your cluster has more instances, increase this limit or use filtering.</span>
</span><span id="ClusterSet-168"><a href="#ClusterSet-168"><span class="linenos"> 168</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-169"><a href="#ClusterSet-169"><span class="linenos"> 169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-170"><a href="#ClusterSet-170"><span class="linenos"> 170</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-171"><a href="#ClusterSet-171"><span class="linenos"> 171</span></a>        <span class="c1"># Exclude terminated instances</span>
</span><span id="ClusterSet-172"><a href="#ClusterSet-172"><span class="linenos"> 172</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet-173"><a href="#ClusterSet-173"><span class="linenos"> 173</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-174"><a href="#ClusterSet-174"><span class="linenos"> 174</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-175"><a href="#ClusterSet-175"><span class="linenos"> 175</span></a>            <span class="s1">&#39;shutting-down&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-176"><a href="#ClusterSet-176"><span class="linenos"> 176</span></a>            <span class="s1">&#39;stopped&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-177"><a href="#ClusterSet-177"><span class="linenos"> 177</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet-178"><a href="#ClusterSet-178"><span class="linenos"> 178</span></a>        <span class="p">])</span>
</span><span id="ClusterSet-179"><a href="#ClusterSet-179"><span class="linenos"> 179</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-180"><a href="#ClusterSet-180"><span class="linenos"> 180</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-181"><a href="#ClusterSet-181"><span class="linenos"> 181</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet-182"><a href="#ClusterSet-182"><span class="linenos"> 182</span></a>        <span class="k">return</span> <span class="n">instance_list</span>
</span><span id="ClusterSet-183"><a href="#ClusterSet-183"><span class="linenos"> 183</span></a>
</span><span id="ClusterSet-184"><a href="#ClusterSet-184"><span class="linenos"> 184</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_deployed_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-185"><a href="#ClusterSet-185"><span class="linenos"> 185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-186"><a href="#ClusterSet-186"><span class="linenos"> 186</span></a><span class="sd">        Get a dictionary with all clusters already deployed.</span>
</span><span id="ClusterSet-187"><a href="#ClusterSet-187"><span class="linenos"> 187</span></a>
</span><span id="ClusterSet-188"><a href="#ClusterSet-188"><span class="linenos"> 188</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-189"><a href="#ClusterSet-189"><span class="linenos"> 189</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-190"><a href="#ClusterSet-190"><span class="linenos"> 190</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-191"><a href="#ClusterSet-191"><span class="linenos"> 191</span></a><span class="sd">            dictionary of clusters</span>
</span><span id="ClusterSet-192"><a href="#ClusterSet-192"><span class="linenos"> 192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-193"><a href="#ClusterSet-193"><span class="linenos"> 193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_deployed_clusters&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-194"><a href="#ClusterSet-194"><span class="linenos"> 194</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-195"><a href="#ClusterSet-195"><span class="linenos"> 195</span></a>        <span class="c1"># Exclude terminated instances</span>
</span><span id="ClusterSet-196"><a href="#ClusterSet-196"><span class="linenos"> 196</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet-197"><a href="#ClusterSet-197"><span class="linenos"> 197</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-198"><a href="#ClusterSet-198"><span class="linenos"> 198</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-199"><a href="#ClusterSet-199"><span class="linenos"> 199</span></a>            <span class="s1">&#39;shutting-down&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-200"><a href="#ClusterSet-200"><span class="linenos"> 200</span></a>            <span class="s1">&#39;stopped&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-201"><a href="#ClusterSet-201"><span class="linenos"> 201</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet-202"><a href="#ClusterSet-202"><span class="linenos"> 202</span></a>        <span class="p">])</span>
</span><span id="ClusterSet-203"><a href="#ClusterSet-203"><span class="linenos"> 203</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-204"><a href="#ClusterSet-204"><span class="linenos"> 204</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-205"><a href="#ClusterSet-205"><span class="linenos"> 205</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet-206"><a href="#ClusterSet-206"><span class="linenos"> 206</span></a>        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">}</span>
</span><span id="ClusterSet-207"><a href="#ClusterSet-207"><span class="linenos"> 207</span></a>
</span><span id="ClusterSet-208"><a href="#ClusterSet-208"><span class="linenos"> 208</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet-209"><a href="#ClusterSet-209"><span class="linenos"> 209</span></a>            <span class="n">cluster_tag</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-210"><a href="#ClusterSet-210"><span class="linenos"> 210</span></a>            <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ClusterSet-211"><a href="#ClusterSet-211"><span class="linenos"> 211</span></a>
</span><span id="ClusterSet-212"><a href="#ClusterSet-212"><span class="linenos"> 212</span></a>        <span class="k">return</span> <span class="n">cluster_dict</span>
</span><span id="ClusterSet-213"><a href="#ClusterSet-213"><span class="linenos"> 213</span></a>
</span><span id="ClusterSet-214"><a href="#ClusterSet-214"><span class="linenos"> 214</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_deployed_cluster_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-215"><a href="#ClusterSet-215"><span class="linenos"> 215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-216"><a href="#ClusterSet-216"><span class="linenos"> 216</span></a><span class="sd">        Get a set of all supported environment cluster names already deployed.</span>
</span><span id="ClusterSet-217"><a href="#ClusterSet-217"><span class="linenos"> 217</span></a>
</span><span id="ClusterSet-218"><a href="#ClusterSet-218"><span class="linenos"> 218</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-219"><a href="#ClusterSet-219"><span class="linenos"> 219</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-220"><a href="#ClusterSet-220"><span class="linenos"> 220</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-221"><a href="#ClusterSet-221"><span class="linenos"> 221</span></a><span class="sd">            set of deployed cluster_names</span>
</span><span id="ClusterSet-222"><a href="#ClusterSet-222"><span class="linenos"> 222</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-223"><a href="#ClusterSet-223"><span class="linenos"> 223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_deployed_cluster_names&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-224"><a href="#ClusterSet-224"><span class="linenos"> 224</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-225"><a href="#ClusterSet-225"><span class="linenos"> 225</span></a>        <span class="c1"># Exclude terminated instances</span>
</span><span id="ClusterSet-226"><a href="#ClusterSet-226"><span class="linenos"> 226</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet-227"><a href="#ClusterSet-227"><span class="linenos"> 227</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-228"><a href="#ClusterSet-228"><span class="linenos"> 228</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-229"><a href="#ClusterSet-229"><span class="linenos"> 229</span></a>            <span class="s1">&#39;shutting-down&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-230"><a href="#ClusterSet-230"><span class="linenos"> 230</span></a>            <span class="s1">&#39;stopped&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-231"><a href="#ClusterSet-231"><span class="linenos"> 231</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet-232"><a href="#ClusterSet-232"><span class="linenos"> 232</span></a>        <span class="p">])</span>
</span><span id="ClusterSet-233"><a href="#ClusterSet-233"><span class="linenos"> 233</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-234"><a href="#ClusterSet-234"><span class="linenos"> 234</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-235"><a href="#ClusterSet-235"><span class="linenos"> 235</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet-236"><a href="#ClusterSet-236"><span class="linenos"> 236</span></a>        <span class="n">instance_cluster_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-237"><a href="#ClusterSet-237"><span class="linenos"> 237</span></a>
</span><span id="ClusterSet-238"><a href="#ClusterSet-238"><span class="linenos"> 238</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet-239"><a href="#ClusterSet-239"><span class="linenos"> 239</span></a>            <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-240"><a href="#ClusterSet-240"><span class="linenos"> 240</span></a>            <span class="k">if</span> <span class="n">cluster_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance_cluster_names</span><span class="p">:</span>
</span><span id="ClusterSet-241"><a href="#ClusterSet-241"><span class="linenos"> 241</span></a>                <span class="n">instance_cluster_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
</span><span id="ClusterSet-242"><a href="#ClusterSet-242"><span class="linenos"> 242</span></a>
</span><span id="ClusterSet-243"><a href="#ClusterSet-243"><span class="linenos"> 243</span></a>        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">instance_cluster_names</span><span class="p">)</span>
</span><span id="ClusterSet-244"><a href="#ClusterSet-244"><span class="linenos"> 244</span></a>
</span><span id="ClusterSet-245"><a href="#ClusterSet-245"><span class="linenos"> 245</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_running_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-246"><a href="#ClusterSet-246"><span class="linenos"> 246</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-247"><a href="#ClusterSet-247"><span class="linenos"> 247</span></a><span class="sd">        Get list of instances that are powered on. This includes instances in</span>
</span><span id="ClusterSet-248"><a href="#ClusterSet-248"><span class="linenos"> 248</span></a><span class="sd">        a pending, running, or stopping state.</span>
</span><span id="ClusterSet-249"><a href="#ClusterSet-249"><span class="linenos"> 249</span></a>
</span><span id="ClusterSet-250"><a href="#ClusterSet-250"><span class="linenos"> 250</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-251"><a href="#ClusterSet-251"><span class="linenos"> 251</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-252"><a href="#ClusterSet-252"><span class="linenos"> 252</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-253"><a href="#ClusterSet-253"><span class="linenos"> 253</span></a><span class="sd">            list of instances</span>
</span><span id="ClusterSet-254"><a href="#ClusterSet-254"><span class="linenos"> 254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-255"><a href="#ClusterSet-255"><span class="linenos"> 255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-256"><a href="#ClusterSet-256"><span class="linenos"> 256</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-257"><a href="#ClusterSet-257"><span class="linenos"> 257</span></a>        <span class="c1"># Only want instances that are pending, running, or stopping</span>
</span><span id="ClusterSet-258"><a href="#ClusterSet-258"><span class="linenos"> 258</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet-259"><a href="#ClusterSet-259"><span class="linenos"> 259</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-260"><a href="#ClusterSet-260"><span class="linenos"> 260</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-261"><a href="#ClusterSet-261"><span class="linenos"> 261</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet-262"><a href="#ClusterSet-262"><span class="linenos"> 262</span></a>        <span class="p">])</span>
</span><span id="ClusterSet-263"><a href="#ClusterSet-263"><span class="linenos"> 263</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-264"><a href="#ClusterSet-264"><span class="linenos"> 264</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-265"><a href="#ClusterSet-265"><span class="linenos"> 265</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet-266"><a href="#ClusterSet-266"><span class="linenos"> 266</span></a>        <span class="k">return</span> <span class="n">instance_list</span>
</span><span id="ClusterSet-267"><a href="#ClusterSet-267"><span class="linenos"> 267</span></a>
</span><span id="ClusterSet-268"><a href="#ClusterSet-268"><span class="linenos"> 268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_running_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-269"><a href="#ClusterSet-269"><span class="linenos"> 269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-270"><a href="#ClusterSet-270"><span class="linenos"> 270</span></a><span class="sd">        Get a dictionary with all clusters that are powered on. This includes instances in</span>
</span><span id="ClusterSet-271"><a href="#ClusterSet-271"><span class="linenos"> 271</span></a><span class="sd">        a pending, running, or stopping state.</span>
</span><span id="ClusterSet-272"><a href="#ClusterSet-272"><span class="linenos"> 272</span></a>
</span><span id="ClusterSet-273"><a href="#ClusterSet-273"><span class="linenos"> 273</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-274"><a href="#ClusterSet-274"><span class="linenos"> 274</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-275"><a href="#ClusterSet-275"><span class="linenos"> 275</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-276"><a href="#ClusterSet-276"><span class="linenos"> 276</span></a><span class="sd">            dictionary of running clusters</span>
</span><span id="ClusterSet-277"><a href="#ClusterSet-277"><span class="linenos"> 277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-278"><a href="#ClusterSet-278"><span class="linenos"> 278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_running_clusters&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-279"><a href="#ClusterSet-279"><span class="linenos"> 279</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-280"><a href="#ClusterSet-280"><span class="linenos"> 280</span></a>        <span class="c1"># Only want instances that are pending, running, or stopping</span>
</span><span id="ClusterSet-281"><a href="#ClusterSet-281"><span class="linenos"> 281</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet-282"><a href="#ClusterSet-282"><span class="linenos"> 282</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-283"><a href="#ClusterSet-283"><span class="linenos"> 283</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-284"><a href="#ClusterSet-284"><span class="linenos"> 284</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet-285"><a href="#ClusterSet-285"><span class="linenos"> 285</span></a>        <span class="p">])</span>
</span><span id="ClusterSet-286"><a href="#ClusterSet-286"><span class="linenos"> 286</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-287"><a href="#ClusterSet-287"><span class="linenos"> 287</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-288"><a href="#ClusterSet-288"><span class="linenos"> 288</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet-289"><a href="#ClusterSet-289"><span class="linenos"> 289</span></a>        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">}</span>
</span><span id="ClusterSet-290"><a href="#ClusterSet-290"><span class="linenos"> 290</span></a>
</span><span id="ClusterSet-291"><a href="#ClusterSet-291"><span class="linenos"> 291</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet-292"><a href="#ClusterSet-292"><span class="linenos"> 292</span></a>            <span class="n">cluster_tag</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-293"><a href="#ClusterSet-293"><span class="linenos"> 293</span></a>            <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ClusterSet-294"><a href="#ClusterSet-294"><span class="linenos"> 294</span></a>
</span><span id="ClusterSet-295"><a href="#ClusterSet-295"><span class="linenos"> 295</span></a>        <span class="k">return</span> <span class="n">cluster_dict</span>
</span><span id="ClusterSet-296"><a href="#ClusterSet-296"><span class="linenos"> 296</span></a>
</span><span id="ClusterSet-297"><a href="#ClusterSet-297"><span class="linenos"> 297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stopped_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-298"><a href="#ClusterSet-298"><span class="linenos"> 298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-299"><a href="#ClusterSet-299"><span class="linenos"> 299</span></a><span class="sd">        Get list of instances that are powered off.</span>
</span><span id="ClusterSet-300"><a href="#ClusterSet-300"><span class="linenos"> 300</span></a>
</span><span id="ClusterSet-301"><a href="#ClusterSet-301"><span class="linenos"> 301</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-302"><a href="#ClusterSet-302"><span class="linenos"> 302</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-303"><a href="#ClusterSet-303"><span class="linenos"> 303</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-304"><a href="#ClusterSet-304"><span class="linenos"> 304</span></a><span class="sd">            list of instances</span>
</span><span id="ClusterSet-305"><a href="#ClusterSet-305"><span class="linenos"> 305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-306"><a href="#ClusterSet-306"><span class="linenos"> 306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-307"><a href="#ClusterSet-307"><span class="linenos"> 307</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-308"><a href="#ClusterSet-308"><span class="linenos"> 308</span></a>        <span class="c1"># Only want instances that are completely stopped</span>
</span><span id="ClusterSet-309"><a href="#ClusterSet-309"><span class="linenos"> 309</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-310"><a href="#ClusterSet-310"><span class="linenos"> 310</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-311"><a href="#ClusterSet-311"><span class="linenos"> 311</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-312"><a href="#ClusterSet-312"><span class="linenos"> 312</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet-313"><a href="#ClusterSet-313"><span class="linenos"> 313</span></a>        <span class="k">return</span> <span class="n">instance_list</span>
</span><span id="ClusterSet-314"><a href="#ClusterSet-314"><span class="linenos"> 314</span></a>
</span><span id="ClusterSet-315"><a href="#ClusterSet-315"><span class="linenos"> 315</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stopped_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-316"><a href="#ClusterSet-316"><span class="linenos"> 316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-317"><a href="#ClusterSet-317"><span class="linenos"> 317</span></a><span class="sd">        Get a dictionary with all clusters that are powered off.</span>
</span><span id="ClusterSet-318"><a href="#ClusterSet-318"><span class="linenos"> 318</span></a>
</span><span id="ClusterSet-319"><a href="#ClusterSet-319"><span class="linenos"> 319</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-320"><a href="#ClusterSet-320"><span class="linenos"> 320</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-321"><a href="#ClusterSet-321"><span class="linenos"> 321</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-322"><a href="#ClusterSet-322"><span class="linenos"> 322</span></a><span class="sd">            dictionary of stopped clusters</span>
</span><span id="ClusterSet-323"><a href="#ClusterSet-323"><span class="linenos"> 323</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-324"><a href="#ClusterSet-324"><span class="linenos"> 324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_stopped_clusters&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-325"><a href="#ClusterSet-325"><span class="linenos"> 325</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-326"><a href="#ClusterSet-326"><span class="linenos"> 326</span></a>        <span class="c1"># Only want instances that are completely stopped</span>
</span><span id="ClusterSet-327"><a href="#ClusterSet-327"><span class="linenos"> 327</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-328"><a href="#ClusterSet-328"><span class="linenos"> 328</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-329"><a href="#ClusterSet-329"><span class="linenos"> 329</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-330"><a href="#ClusterSet-330"><span class="linenos"> 330</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet-331"><a href="#ClusterSet-331"><span class="linenos"> 331</span></a>        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">}</span>
</span><span id="ClusterSet-332"><a href="#ClusterSet-332"><span class="linenos"> 332</span></a>
</span><span id="ClusterSet-333"><a href="#ClusterSet-333"><span class="linenos"> 333</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet-334"><a href="#ClusterSet-334"><span class="linenos"> 334</span></a>            <span class="n">cluster_tag</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-335"><a href="#ClusterSet-335"><span class="linenos"> 335</span></a>            <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ClusterSet-336"><a href="#ClusterSet-336"><span class="linenos"> 336</span></a>
</span><span id="ClusterSet-337"><a href="#ClusterSet-337"><span class="linenos"> 337</span></a>        <span class="k">return</span> <span class="n">cluster_dict</span>
</span><span id="ClusterSet-338"><a href="#ClusterSet-338"><span class="linenos"> 338</span></a>
</span><span id="ClusterSet-339"><a href="#ClusterSet-339"><span class="linenos"> 339</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-340"><a href="#ClusterSet-340"><span class="linenos"> 340</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start all stopped EC2 instances in this cluster.</span>
</span><span id="ClusterSet-341"><a href="#ClusterSet-341"><span class="linenos"> 341</span></a>
</span><span id="ClusterSet-342"><a href="#ClusterSet-342"><span class="linenos"> 342</span></a><span class="sd">        Identifies all instances in the cluster that are currently in &#39;stopped&#39; state</span>
</span><span id="ClusterSet-343"><a href="#ClusterSet-343"><span class="linenos"> 343</span></a><span class="sd">        and starts them. Running instances are not affected. The operation processes</span>
</span><span id="ClusterSet-344"><a href="#ClusterSet-344"><span class="linenos"> 344</span></a><span class="sd">        instances in batches and provides feedback on progress.</span>
</span><span id="ClusterSet-345"><a href="#ClusterSet-345"><span class="linenos"> 345</span></a>
</span><span id="ClusterSet-346"><a href="#ClusterSet-346"><span class="linenos"> 346</span></a><span class="sd">        Example:</span>
</span><span id="ClusterSet-347"><a href="#ClusterSet-347"><span class="linenos"> 347</span></a><span class="sd">            ```python</span>
</span><span id="ClusterSet-348"><a href="#ClusterSet-348"><span class="linenos"> 348</span></a><span class="sd">            cluster = ClusterSet(&#39;production-web&#39;)</span>
</span><span id="ClusterSet-349"><a href="#ClusterSet-349"><span class="linenos"> 349</span></a><span class="sd">            cluster.start_instances()  # Starts all stopped instances</span>
</span><span id="ClusterSet-350"><a href="#ClusterSet-350"><span class="linenos"> 350</span></a><span class="sd">            ```</span>
</span><span id="ClusterSet-351"><a href="#ClusterSet-351"><span class="linenos"> 351</span></a>
</span><span id="ClusterSet-352"><a href="#ClusterSet-352"><span class="linenos"> 352</span></a><span class="sd">        Note:</span>
</span><span id="ClusterSet-353"><a href="#ClusterSet-353"><span class="linenos"> 353</span></a><span class="sd">            Only instances in &#39;stopped&#39; state will be started. Instances in other</span>
</span><span id="ClusterSet-354"><a href="#ClusterSet-354"><span class="linenos"> 354</span></a><span class="sd">            states (running, stopping, etc.) are ignored. The operation may take</span>
</span><span id="ClusterSet-355"><a href="#ClusterSet-355"><span class="linenos"> 355</span></a><span class="sd">            several minutes for large clusters.</span>
</span><span id="ClusterSet-356"><a href="#ClusterSet-356"><span class="linenos"> 356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-357"><a href="#ClusterSet-357"><span class="linenos"> 357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: start_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-358"><a href="#ClusterSet-358"><span class="linenos"> 358</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stopped_instances</span><span class="p">()</span>
</span><span id="ClusterSet-359"><a href="#ClusterSet-359"><span class="linenos"> 359</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-360"><a href="#ClusterSet-360"><span class="linenos"> 360</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No instances to start.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-361"><a href="#ClusterSet-361"><span class="linenos"> 361</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-362"><a href="#ClusterSet-362"><span class="linenos"> 362</span></a>            <span class="c1"># Start instances</span>
</span><span id="ClusterSet-363"><a href="#ClusterSet-363"><span class="linenos"> 363</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-364"><a href="#ClusterSet-364"><span class="linenos"> 364</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-365"><a href="#ClusterSet-365"><span class="linenos"> 365</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-366"><a href="#ClusterSet-366"><span class="linenos"> 366</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="ClusterSet-367"><a href="#ClusterSet-367"><span class="linenos"> 367</span></a>            <span class="c1"># Wait for instances to start. Call in separate loop because we want</span>
</span><span id="ClusterSet-368"><a href="#ClusterSet-368"><span class="linenos"> 368</span></a>            <span class="c1"># to issue the start commands asynchronously rather than waiting for</span>
</span><span id="ClusterSet-369"><a href="#ClusterSet-369"><span class="linenos"> 369</span></a>            <span class="c1"># each instance to start before issuing the next one.</span>
</span><span id="ClusterSet-370"><a href="#ClusterSet-370"><span class="linenos"> 370</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to start...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-371"><a href="#ClusterSet-371"><span class="linenos"> 371</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-372"><a href="#ClusterSet-372"><span class="linenos"> 372</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_running</span><span class="p">()</span>
</span><span id="ClusterSet-373"><a href="#ClusterSet-373"><span class="linenos"> 373</span></a>
</span><span id="ClusterSet-374"><a href="#ClusterSet-374"><span class="linenos"> 374</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-375"><a href="#ClusterSet-375"><span class="linenos"> 375</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-376"><a href="#ClusterSet-376"><span class="linenos"> 376</span></a><span class="sd">        Stop instances associated with this cluster.</span>
</span><span id="ClusterSet-377"><a href="#ClusterSet-377"><span class="linenos"> 377</span></a>
</span><span id="ClusterSet-378"><a href="#ClusterSet-378"><span class="linenos"> 378</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-379"><a href="#ClusterSet-379"><span class="linenos"> 379</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-380"><a href="#ClusterSet-380"><span class="linenos"> 380</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-381"><a href="#ClusterSet-381"><span class="linenos"> 381</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-382"><a href="#ClusterSet-382"><span class="linenos"> 382</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-383"><a href="#ClusterSet-383"><span class="linenos"> 383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: stop_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-384"><a href="#ClusterSet-384"><span class="linenos"> 384</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_running_instances</span><span class="p">()</span>
</span><span id="ClusterSet-385"><a href="#ClusterSet-385"><span class="linenos"> 385</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-386"><a href="#ClusterSet-386"><span class="linenos"> 386</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No instances to stop.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-387"><a href="#ClusterSet-387"><span class="linenos"> 387</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-388"><a href="#ClusterSet-388"><span class="linenos"> 388</span></a>            <span class="c1"># Stop instances</span>
</span><span id="ClusterSet-389"><a href="#ClusterSet-389"><span class="linenos"> 389</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-390"><a href="#ClusterSet-390"><span class="linenos"> 390</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-391"><a href="#ClusterSet-391"><span class="linenos"> 391</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-392"><a href="#ClusterSet-392"><span class="linenos"> 392</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="ClusterSet-393"><a href="#ClusterSet-393"><span class="linenos"> 393</span></a>            <span class="c1"># Wait for instances to stop. Call in separate loop because we want</span>
</span><span id="ClusterSet-394"><a href="#ClusterSet-394"><span class="linenos"> 394</span></a>            <span class="c1"># to issue the stop commands asynchronously rather than waiting for</span>
</span><span id="ClusterSet-395"><a href="#ClusterSet-395"><span class="linenos"> 395</span></a>            <span class="c1"># each instance to stop before issuing the next one.</span>
</span><span id="ClusterSet-396"><a href="#ClusterSet-396"><span class="linenos"> 396</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to stop...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-397"><a href="#ClusterSet-397"><span class="linenos"> 397</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-398"><a href="#ClusterSet-398"><span class="linenos"> 398</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_stopped</span><span class="p">()</span>
</span><span id="ClusterSet-399"><a href="#ClusterSet-399"><span class="linenos"> 399</span></a>
</span><span id="ClusterSet-400"><a href="#ClusterSet-400"><span class="linenos"> 400</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-401"><a href="#ClusterSet-401"><span class="linenos"> 401</span></a>        <span class="c1"># The resource API is somewhat less efficient than the low-level client</span>
</span><span id="ClusterSet-402"><a href="#ClusterSet-402"><span class="linenos"> 402</span></a>        <span class="c1"># API because it does one request per tag operation. For reasonably</span>
</span><span id="ClusterSet-403"><a href="#ClusterSet-403"><span class="linenos"> 403</span></a>        <span class="c1"># sized collections this should be ok.</span>
</span><span id="ClusterSet-404"><a href="#ClusterSet-404"><span class="linenos"> 404</span></a>        <span class="c1"># tags = {&#39;key&#39;: &#39;values&#39;}</span>
</span><span id="ClusterSet-405"><a href="#ClusterSet-405"><span class="linenos"> 405</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet-406"><a href="#ClusterSet-406"><span class="linenos"> 406</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-407"><a href="#ClusterSet-407"><span class="linenos"> 407</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging instance </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-408"><a href="#ClusterSet-408"><span class="linenos"> 408</span></a>            <span class="n">i</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-409"><a href="#ClusterSet-409"><span class="linenos"> 409</span></a>
</span><span id="ClusterSet-410"><a href="#ClusterSet-410"><span class="linenos"> 410</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-411"><a href="#ClusterSet-411"><span class="linenos"> 411</span></a>        <span class="c1"># Might as well un-tag on one big batch since instance objects don&#39;t</span>
</span><span id="ClusterSet-412"><a href="#ClusterSet-412"><span class="linenos"> 412</span></a>        <span class="c1"># have direct support for un-tagging.</span>
</span><span id="ClusterSet-413"><a href="#ClusterSet-413"><span class="linenos"> 413</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet-414"><a href="#ClusterSet-414"><span class="linenos"> 414</span></a>        <span class="n">instance_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-415"><a href="#ClusterSet-415"><span class="linenos"> 415</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-416"><a href="#ClusterSet-416"><span class="linenos"> 416</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging instance </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-417"><a href="#ClusterSet-417"><span class="linenos"> 417</span></a>            <span class="n">instance_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-418"><a href="#ClusterSet-418"><span class="linenos"> 418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="n">instance_ids</span><span class="p">,</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-419"><a href="#ClusterSet-419"><span class="linenos"> 419</span></a>
</span><span id="ClusterSet-420"><a href="#ClusterSet-420"><span class="linenos"> 420</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-421"><a href="#ClusterSet-421"><span class="linenos"> 421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-422"><a href="#ClusterSet-422"><span class="linenos"> 422</span></a><span class="sd">        Get list of volumes associated with this cluster.</span>
</span><span id="ClusterSet-423"><a href="#ClusterSet-423"><span class="linenos"> 423</span></a>
</span><span id="ClusterSet-424"><a href="#ClusterSet-424"><span class="linenos"> 424</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-425"><a href="#ClusterSet-425"><span class="linenos"> 425</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-426"><a href="#ClusterSet-426"><span class="linenos"> 426</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-427"><a href="#ClusterSet-427"><span class="linenos"> 427</span></a><span class="sd">            list of volumes</span>
</span><span id="ClusterSet-428"><a href="#ClusterSet-428"><span class="linenos"> 428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-429"><a href="#ClusterSet-429"><span class="linenos"> 429</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-430"><a href="#ClusterSet-430"><span class="linenos"> 430</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-431"><a href="#ClusterSet-431"><span class="linenos"> 431</span></a>        <span class="c1"># The tool deliberately only works with volumes that have the tag</span>
</span><span id="ClusterSet-432"><a href="#ClusterSet-432"><span class="linenos"> 432</span></a>        <span class="c1"># &#39;automation_key&#39; set. It will ignore all other volumes so that it</span>
</span><span id="ClusterSet-433"><a href="#ClusterSet-433"><span class="linenos"> 433</span></a>        <span class="c1"># doesn&#39;t clobber volumes that it is not responsible for. It may be that</span>
</span><span id="ClusterSet-434"><a href="#ClusterSet-434"><span class="linenos"> 434</span></a>        <span class="c1"># we only need to worry about volumes created by snapshot manager</span>
</span><span id="ClusterSet-435"><a href="#ClusterSet-435"><span class="linenos"> 435</span></a>        <span class="c1"># because volumes created by the provisioner won&#39;t ever have a label,</span>
</span><span id="ClusterSet-436"><a href="#ClusterSet-436"><span class="linenos"> 436</span></a>        <span class="c1"># so when looking for restored volumes, we can just look for managed</span>
</span><span id="ClusterSet-437"><a href="#ClusterSet-437"><span class="linenos"> 437</span></a>        <span class="c1"># volumes that have a label.</span>
</span><span id="ClusterSet-438"><a href="#ClusterSet-438"><span class="linenos"> 438</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:automation_key&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet-439"><a href="#ClusterSet-439"><span class="linenos"> 439</span></a>            <span class="s1">&#39;PROVISIONER&#39;</span><span class="p">,</span>
</span><span id="ClusterSet-440"><a href="#ClusterSet-440"><span class="linenos"> 440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span>
</span><span id="ClusterSet-441"><a href="#ClusterSet-441"><span class="linenos"> 441</span></a>        <span class="p">])</span>
</span><span id="ClusterSet-442"><a href="#ClusterSet-442"><span class="linenos"> 442</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-443"><a href="#ClusterSet-443"><span class="linenos"> 443</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-444"><a href="#ClusterSet-444"><span class="linenos"> 444</span></a>        <span class="n">volume_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">volumes</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet-445"><a href="#ClusterSet-445"><span class="linenos"> 445</span></a>        <span class="k">return</span> <span class="n">volume_list</span>
</span><span id="ClusterSet-446"><a href="#ClusterSet-446"><span class="linenos"> 446</span></a>
</span><span id="ClusterSet-447"><a href="#ClusterSet-447"><span class="linenos"> 447</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_kubernetes_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-448"><a href="#ClusterSet-448"><span class="linenos"> 448</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-449"><a href="#ClusterSet-449"><span class="linenos"> 449</span></a><span class="sd">        Get list of kubernetes volumes associated with this cluster.</span>
</span><span id="ClusterSet-450"><a href="#ClusterSet-450"><span class="linenos"> 450</span></a>
</span><span id="ClusterSet-451"><a href="#ClusterSet-451"><span class="linenos"> 451</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-452"><a href="#ClusterSet-452"><span class="linenos"> 452</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-453"><a href="#ClusterSet-453"><span class="linenos"> 453</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-454"><a href="#ClusterSet-454"><span class="linenos"> 454</span></a><span class="sd">            list of kubernetes volumes</span>
</span><span id="ClusterSet-455"><a href="#ClusterSet-455"><span class="linenos"> 455</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-456"><a href="#ClusterSet-456"><span class="linenos"> 456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_kubernetes_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-457"><a href="#ClusterSet-457"><span class="linenos"> 457</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">([</span>
</span><span id="ClusterSet-458"><a href="#ClusterSet-458"><span class="linenos"> 458</span></a>            <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:KubernetesCluster&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">]},</span>
</span><span id="ClusterSet-459"><a href="#ClusterSet-459"><span class="linenos"> 459</span></a>            <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:kubernetes.io/created-for/pvc/namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;openshift-logging&#39;</span><span class="p">]}</span>
</span><span id="ClusterSet-460"><a href="#ClusterSet-460"><span class="linenos"> 460</span></a>        <span class="p">])</span>
</span><span id="ClusterSet-461"><a href="#ClusterSet-461"><span class="linenos"> 461</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-462"><a href="#ClusterSet-462"><span class="linenos"> 462</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-463"><a href="#ClusterSet-463"><span class="linenos"> 463</span></a>        <span class="n">volume_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>
</span><span id="ClusterSet-464"><a href="#ClusterSet-464"><span class="linenos"> 464</span></a>        <span class="k">return</span> <span class="n">volume_list</span>
</span><span id="ClusterSet-465"><a href="#ClusterSet-465"><span class="linenos"> 465</span></a>
</span><span id="ClusterSet-466"><a href="#ClusterSet-466"><span class="linenos"> 466</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_restored_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ClusterSet-467"><a href="#ClusterSet-467"><span class="linenos"> 467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-468"><a href="#ClusterSet-468"><span class="linenos"> 468</span></a><span class="sd">        Get list of volumes that were previously created from snapshots.</span>
</span><span id="ClusterSet-469"><a href="#ClusterSet-469"><span class="linenos"> 469</span></a>
</span><span id="ClusterSet-470"><a href="#ClusterSet-470"><span class="linenos"> 470</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-471"><a href="#ClusterSet-471"><span class="linenos"> 471</span></a><span class="sd">            - label: label of volumes being sought (optional)</span>
</span><span id="ClusterSet-472"><a href="#ClusterSet-472"><span class="linenos"> 472</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-473"><a href="#ClusterSet-473"><span class="linenos"> 473</span></a><span class="sd">            list of snapshots</span>
</span><span id="ClusterSet-474"><a href="#ClusterSet-474"><span class="linenos"> 474</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-475"><a href="#ClusterSet-475"><span class="linenos"> 475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_restored_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-476"><a href="#ClusterSet-476"><span class="linenos"> 476</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-477"><a href="#ClusterSet-477"><span class="linenos"> 477</span></a>        <span class="c1"># These volumes can be in available state (if just created) or in-use state (if attached)</span>
</span><span id="ClusterSet-478"><a href="#ClusterSet-478"><span class="linenos"> 478</span></a>        <span class="c1"># We need to check for both states to properly detect restored volumes</span>
</span><span id="ClusterSet-479"><a href="#ClusterSet-479"><span class="linenos"> 479</span></a>        <span class="c1"># | Note: The &#39;status&#39; filter corresponds to the &#39;state&#39; attribute in</span>
</span><span id="ClusterSet-480"><a href="#ClusterSet-480"><span class="linenos"> 480</span></a>        <span class="c1"># | the AWS management console. Not sure about the reason behind that.</span>
</span><span id="ClusterSet-481"><a href="#ClusterSet-481"><span class="linenos"> 481</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet-482"><a href="#ClusterSet-482"><span class="linenos"> 482</span></a>        <span class="c1"># Optionally, get volumes with the given label</span>
</span><span id="ClusterSet-483"><a href="#ClusterSet-483"><span class="linenos"> 483</span></a>        <span class="c1"># This might not really be needed because the way the snapshot manager</span>
</span><span id="ClusterSet-484"><a href="#ClusterSet-484"><span class="linenos"> 484</span></a>        <span class="c1"># works is that it deletes all managed volumes before creating new ones</span>
</span><span id="ClusterSet-485"><a href="#ClusterSet-485"><span class="linenos"> 485</span></a>        <span class="c1"># from snapshots. Therefore at any given time, there should only be one</span>
</span><span id="ClusterSet-486"><a href="#ClusterSet-486"><span class="linenos"> 486</span></a>        <span class="c1"># set of available volumes.</span>
</span><span id="ClusterSet-487"><a href="#ClusterSet-487"><span class="linenos"> 487</span></a>        <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ClusterSet-488"><a href="#ClusterSet-488"><span class="linenos"> 488</span></a>            <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-489"><a href="#ClusterSet-489"><span class="linenos"> 489</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-490"><a href="#ClusterSet-490"><span class="linenos"> 490</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-491"><a href="#ClusterSet-491"><span class="linenos"> 491</span></a>        <span class="n">volume_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">volumes</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet-492"><a href="#ClusterSet-492"><span class="linenos"> 492</span></a>        <span class="k">return</span> <span class="n">volume_list</span>
</span><span id="ClusterSet-493"><a href="#ClusterSet-493"><span class="linenos"> 493</span></a>
</span><span id="ClusterSet-494"><a href="#ClusterSet-494"><span class="linenos"> 494</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">attach_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet-495"><a href="#ClusterSet-495"><span class="linenos"> 495</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-496"><a href="#ClusterSet-496"><span class="linenos"> 496</span></a><span class="sd">        Attach volumes to associated instances.</span>
</span><span id="ClusterSet-497"><a href="#ClusterSet-497"><span class="linenos"> 497</span></a>
</span><span id="ClusterSet-498"><a href="#ClusterSet-498"><span class="linenos"> 498</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-499"><a href="#ClusterSet-499"><span class="linenos"> 499</span></a><span class="sd">            - label: label of volume to attach</span>
</span><span id="ClusterSet-500"><a href="#ClusterSet-500"><span class="linenos"> 500</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-501"><a href="#ClusterSet-501"><span class="linenos"> 501</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-502"><a href="#ClusterSet-502"><span class="linenos"> 502</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-503"><a href="#ClusterSet-503"><span class="linenos"> 503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: attach_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-504"><a href="#ClusterSet-504"><span class="linenos"> 504</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet-505"><a href="#ClusterSet-505"><span class="linenos"> 505</span></a>        <span class="c1"># We should be able to work with get_volumes, but this just protects</span>
</span><span id="ClusterSet-506"><a href="#ClusterSet-506"><span class="linenos"> 506</span></a>        <span class="c1"># against the case when users are manually creating volumes. It filters</span>
</span><span id="ClusterSet-507"><a href="#ClusterSet-507"><span class="linenos"> 507</span></a>        <span class="c1"># out any volumes that were not created by the snapshot manager.</span>
</span><span id="ClusterSet-508"><a href="#ClusterSet-508"><span class="linenos"> 508</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restored_volumes</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-509"><a href="#ClusterSet-509"><span class="linenos"> 509</span></a>        <span class="c1"># This is for debugging purposes. Sometimes the algorithm below doesn&#39;t</span>
</span><span id="ClusterSet-510"><a href="#ClusterSet-510"><span class="linenos"> 510</span></a>        <span class="c1"># find all volumes.</span>
</span><span id="ClusterSet-511"><a href="#ClusterSet-511"><span class="linenos"> 511</span></a>        <span class="c1"># volume_list = list(volumes)</span>
</span><span id="ClusterSet-512"><a href="#ClusterSet-512"><span class="linenos"> 512</span></a>        <span class="c1"># print(f&quot;Found {len(volume_list)} volumes to attach.&quot;)</span>
</span><span id="ClusterSet-513"><a href="#ClusterSet-513"><span class="linenos"> 513</span></a>
</span><span id="ClusterSet-514"><a href="#ClusterSet-514"><span class="linenos"> 514</span></a>        <span class="c1"># For each instance, find all associated volumes and attach them. The</span>
</span><span id="ClusterSet-515"><a href="#ClusterSet-515"><span class="linenos"> 515</span></a>        <span class="c1"># association is performed by matching the volume &#39;Instance&#39; tag to</span>
</span><span id="ClusterSet-516"><a href="#ClusterSet-516"><span class="linenos"> 516</span></a>        <span class="c1"># the instance &#39;Name&#39; tag.</span>
</span><span id="ClusterSet-517"><a href="#ClusterSet-517"><span class="linenos"> 517</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-518"><a href="#ClusterSet-518"><span class="linenos"> 518</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-519"><a href="#ClusterSet-519"><span class="linenos"> 519</span></a>            <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-520"><a href="#ClusterSet-520"><span class="linenos"> 520</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-521"><a href="#ClusterSet-521"><span class="linenos"> 521</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-522"><a href="#ClusterSet-522"><span class="linenos"> 522</span></a>                <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-523"><a href="#ClusterSet-523"><span class="linenos"> 523</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-524"><a href="#ClusterSet-524"><span class="linenos"> 524</span></a>                <span class="k">if</span> <span class="n">instance</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
</span><span id="ClusterSet-525"><a href="#ClusterSet-525"><span class="linenos"> 525</span></a>                    <span class="c1"># Attach volume</span>
</span><span id="ClusterSet-526"><a href="#ClusterSet-526"><span class="linenos"> 526</span></a>                    <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet-527"><a href="#ClusterSet-527"><span class="linenos"> 527</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-528"><a href="#ClusterSet-528"><span class="linenos"> 528</span></a>                    <span class="n">volume</span><span class="o">.</span><span class="n">attach_to_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-529"><a href="#ClusterSet-529"><span class="linenos"> 529</span></a>                    <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-530"><a href="#ClusterSet-530"><span class="linenos"> 530</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-531"><a href="#ClusterSet-531"><span class="linenos"> 531</span></a>            <span class="c1"># This is probably an error. The expectation is that we have a set</span>
</span><span id="ClusterSet-532"><a href="#ClusterSet-532"><span class="linenos"> 532</span></a>            <span class="c1"># of newly created volumes from snapshots.</span>
</span><span id="ClusterSet-533"><a href="#ClusterSet-533"><span class="linenos"> 533</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No volumes to attach.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-534"><a href="#ClusterSet-534"><span class="linenos"> 534</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-535"><a href="#ClusterSet-535"><span class="linenos"> 535</span></a>            <span class="c1"># Wait for the volumes to be attached</span>
</span><span id="ClusterSet-536"><a href="#ClusterSet-536"><span class="linenos"> 536</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be attached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-537"><a href="#ClusterSet-537"><span class="linenos"> 537</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_in_use&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-538"><a href="#ClusterSet-538"><span class="linenos"> 538</span></a>
</span><span id="ClusterSet-539"><a href="#ClusterSet-539"><span class="linenos"> 539</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet-540"><a href="#ClusterSet-540"><span class="linenos"> 540</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-541"><a href="#ClusterSet-541"><span class="linenos"> 541</span></a><span class="sd">        Create new volumes from managed snapshots.</span>
</span><span id="ClusterSet-542"><a href="#ClusterSet-542"><span class="linenos"> 542</span></a>
</span><span id="ClusterSet-543"><a href="#ClusterSet-543"><span class="linenos"> 543</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-544"><a href="#ClusterSet-544"><span class="linenos"> 544</span></a><span class="sd">            - label: label of snapshots to restore</span>
</span><span id="ClusterSet-545"><a href="#ClusterSet-545"><span class="linenos"> 545</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-546"><a href="#ClusterSet-546"><span class="linenos"> 546</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-547"><a href="#ClusterSet-547"><span class="linenos"> 547</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-548"><a href="#ClusterSet-548"><span class="linenos"> 548</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: create_managed_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-549"><a href="#ClusterSet-549"><span class="linenos"> 549</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-550"><a href="#ClusterSet-550"><span class="linenos"> 550</span></a>        <span class="c1"># Check if snapshot list is empty (e.g. due to an invalid label)</span>
</span><span id="ClusterSet-551"><a href="#ClusterSet-551"><span class="linenos"> 551</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-552"><a href="#ClusterSet-552"><span class="linenos"> 552</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No snapshots found with label &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-553"><a href="#ClusterSet-553"><span class="linenos"> 553</span></a>        <span class="c1"># Create volumes</span>
</span><span id="ClusterSet-554"><a href="#ClusterSet-554"><span class="linenos"> 554</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-555"><a href="#ClusterSet-555"><span class="linenos"> 555</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet-556"><a href="#ClusterSet-556"><span class="linenos"> 556</span></a>            <span class="c1"># Determine snapshot&#39;s associated instance and device. This is</span>
</span><span id="ClusterSet-557"><a href="#ClusterSet-557"><span class="linenos"> 557</span></a>            <span class="c1"># needed later on so that we know where to attach it.</span>
</span><span id="ClusterSet-558"><a href="#ClusterSet-558"><span class="linenos"> 558</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-559"><a href="#ClusterSet-559"><span class="linenos"> 559</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-560"><a href="#ClusterSet-560"><span class="linenos"> 560</span></a>            <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-561"><a href="#ClusterSet-561"><span class="linenos"> 561</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="p">:</span>
</span><span id="ClusterSet-562"><a href="#ClusterSet-562"><span class="linenos"> 562</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find device tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-563"><a href="#ClusterSet-563"><span class="linenos"> 563</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span><span id="ClusterSet-564"><a href="#ClusterSet-564"><span class="linenos"> 564</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find instance tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-565"><a href="#ClusterSet-565"><span class="linenos"> 565</span></a>            <span class="c1"># Determine availability zone from one of the cluster instances</span>
</span><span id="ClusterSet-566"><a href="#ClusterSet-566"><span class="linenos"> 566</span></a>            <span class="n">avail_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">placement</span><span class="p">[</span><span class="s1">&#39;AvailabilityZone&#39;</span><span class="p">]</span>
</span><span id="ClusterSet-567"><a href="#ClusterSet-567"><span class="linenos"> 567</span></a>            <span class="c1"># Make tags</span>
</span><span id="ClusterSet-568"><a href="#ClusterSet-568"><span class="linenos"> 568</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>
</span><span id="ClusterSet-569"><a href="#ClusterSet-569"><span class="linenos"> 569</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">)</span>
</span><span id="ClusterSet-570"><a href="#ClusterSet-570"><span class="linenos"> 570</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="ClusterSet-571"><a href="#ClusterSet-571"><span class="linenos"> 571</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="ClusterSet-572"><a href="#ClusterSet-572"><span class="linenos"> 572</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-573"><a href="#ClusterSet-573"><span class="linenos"> 573</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-574"><a href="#ClusterSet-574"><span class="linenos"> 574</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet-575"><a href="#ClusterSet-575"><span class="linenos"> 575</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-576"><a href="#ClusterSet-576"><span class="linenos"> 576</span></a>            <span class="c1"># Create volume</span>
</span><span id="ClusterSet-577"><a href="#ClusterSet-577"><span class="linenos"> 577</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating volume from snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-578"><a href="#ClusterSet-578"><span class="linenos"> 578</span></a>            <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">create_volume</span><span class="p">(</span>
</span><span id="ClusterSet-579"><a href="#ClusterSet-579"><span class="linenos"> 579</span></a>                <span class="n">SnapshotId</span><span class="o">=</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="ClusterSet-580"><a href="#ClusterSet-580"><span class="linenos"> 580</span></a>                <span class="n">AvailabilityZone</span><span class="o">=</span><span class="n">avail_zone</span><span class="p">,</span>
</span><span id="ClusterSet-581"><a href="#ClusterSet-581"><span class="linenos"> 581</span></a>                <span class="n">TagSpecifications</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">}]</span>
</span><span id="ClusterSet-582"><a href="#ClusterSet-582"><span class="linenos"> 582</span></a>            <span class="p">)</span>
</span><span id="ClusterSet-583"><a href="#ClusterSet-583"><span class="linenos"> 583</span></a>            <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-584"><a href="#ClusterSet-584"><span class="linenos"> 584</span></a>        <span class="c1"># Wait for the volumes to be created</span>
</span><span id="ClusterSet-585"><a href="#ClusterSet-585"><span class="linenos"> 585</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-586"><a href="#ClusterSet-586"><span class="linenos"> 586</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be created...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-587"><a href="#ClusterSet-587"><span class="linenos"> 587</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-588"><a href="#ClusterSet-588"><span class="linenos"> 588</span></a>            <span class="c1"># When attaching newly created volumes later, not all volumes are</span>
</span><span id="ClusterSet-589"><a href="#ClusterSet-589"><span class="linenos"> 589</span></a>            <span class="c1"># being attached for some reason. Perhaps the waiter returns before</span>
</span><span id="ClusterSet-590"><a href="#ClusterSet-590"><span class="linenos"> 590</span></a>            <span class="c1"># the tags have actually been applied. Try giving ten more seconds</span>
</span><span id="ClusterSet-591"><a href="#ClusterSet-591"><span class="linenos"> 591</span></a>            <span class="c1"># for the tags to be applied.</span>
</span><span id="ClusterSet-592"><a href="#ClusterSet-592"><span class="linenos"> 592</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="ClusterSet-593"><a href="#ClusterSet-593"><span class="linenos"> 593</span></a>
</span><span id="ClusterSet-594"><a href="#ClusterSet-594"><span class="linenos"> 594</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-595"><a href="#ClusterSet-595"><span class="linenos"> 595</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-596"><a href="#ClusterSet-596"><span class="linenos"> 596</span></a><span class="sd">        Delete all volumes associated with this cluster.</span>
</span><span id="ClusterSet-597"><a href="#ClusterSet-597"><span class="linenos"> 597</span></a>
</span><span id="ClusterSet-598"><a href="#ClusterSet-598"><span class="linenos"> 598</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-599"><a href="#ClusterSet-599"><span class="linenos"> 599</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-600"><a href="#ClusterSet-600"><span class="linenos"> 600</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-601"><a href="#ClusterSet-601"><span class="linenos"> 601</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-602"><a href="#ClusterSet-602"><span class="linenos"> 602</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-603"><a href="#ClusterSet-603"><span class="linenos"> 603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-604"><a href="#ClusterSet-604"><span class="linenos"> 604</span></a>        <span class="c1"># We really only have to delete the previously detached volumes, but</span>
</span><span id="ClusterSet-605"><a href="#ClusterSet-605"><span class="linenos"> 605</span></a>        <span class="c1"># this will delete all managed volumes in the cluster. Its probably a</span>
</span><span id="ClusterSet-606"><a href="#ClusterSet-606"><span class="linenos"> 606</span></a>        <span class="c1"># good idea to do so as a matter of good housekeeping. Also, if there</span>
</span><span id="ClusterSet-607"><a href="#ClusterSet-607"><span class="linenos"> 607</span></a>        <span class="c1"># are any stale volumes hanging around with the same label that we are</span>
</span><span id="ClusterSet-608"><a href="#ClusterSet-608"><span class="linenos"> 608</span></a>        <span class="c1"># about to restore from that would cause problems because we wouldn&#39;t</span>
</span><span id="ClusterSet-609"><a href="#ClusterSet-609"><span class="linenos"> 609</span></a>        <span class="c1"># know which volumes to attach.</span>
</span><span id="ClusterSet-610"><a href="#ClusterSet-610"><span class="linenos"> 610</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet-611"><a href="#ClusterSet-611"><span class="linenos"> 611</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-612"><a href="#ClusterSet-612"><span class="linenos"> 612</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No volumes to delete.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-613"><a href="#ClusterSet-613"><span class="linenos"> 613</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-614"><a href="#ClusterSet-614"><span class="linenos"> 614</span></a>            <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-615"><a href="#ClusterSet-615"><span class="linenos"> 615</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-616"><a href="#ClusterSet-616"><span class="linenos"> 616</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-617"><a href="#ClusterSet-617"><span class="linenos"> 617</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet-618"><a href="#ClusterSet-618"><span class="linenos"> 618</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-619"><a href="#ClusterSet-619"><span class="linenos"> 619</span></a>            <span class="c1"># Wait for the volumes to be deleted</span>
</span><span id="ClusterSet-620"><a href="#ClusterSet-620"><span class="linenos"> 620</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be deleted...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-621"><a href="#ClusterSet-621"><span class="linenos"> 621</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_deleted&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-622"><a href="#ClusterSet-622"><span class="linenos"> 622</span></a>
</span><span id="ClusterSet-623"><a href="#ClusterSet-623"><span class="linenos"> 623</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_kubernetes_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-624"><a href="#ClusterSet-624"><span class="linenos"> 624</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-625"><a href="#ClusterSet-625"><span class="linenos"> 625</span></a><span class="sd">        Delete all kubernetes volumes associated with this cluster.</span>
</span><span id="ClusterSet-626"><a href="#ClusterSet-626"><span class="linenos"> 626</span></a>
</span><span id="ClusterSet-627"><a href="#ClusterSet-627"><span class="linenos"> 627</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-628"><a href="#ClusterSet-628"><span class="linenos"> 628</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-629"><a href="#ClusterSet-629"><span class="linenos"> 629</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-630"><a href="#ClusterSet-630"><span class="linenos"> 630</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-631"><a href="#ClusterSet-631"><span class="linenos"> 631</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-632"><a href="#ClusterSet-632"><span class="linenos"> 632</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_kubernetes_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-633"><a href="#ClusterSet-633"><span class="linenos"> 633</span></a>        <span class="c1"># We really only have to delete the previously detached volumes, but</span>
</span><span id="ClusterSet-634"><a href="#ClusterSet-634"><span class="linenos"> 634</span></a>        <span class="c1"># this will delete all managed volumes in the cluster. Its probably a</span>
</span><span id="ClusterSet-635"><a href="#ClusterSet-635"><span class="linenos"> 635</span></a>        <span class="c1"># good idea to do so as a matter of good housekeeping. Also, if there</span>
</span><span id="ClusterSet-636"><a href="#ClusterSet-636"><span class="linenos"> 636</span></a>        <span class="c1"># are any stale volumes hanging around with the same label that we are</span>
</span><span id="ClusterSet-637"><a href="#ClusterSet-637"><span class="linenos"> 637</span></a>        <span class="c1"># about to restore from that would cause problems because we wouldn&#39;t</span>
</span><span id="ClusterSet-638"><a href="#ClusterSet-638"><span class="linenos"> 638</span></a>        <span class="c1"># know which volumes to attach.</span>
</span><span id="ClusterSet-639"><a href="#ClusterSet-639"><span class="linenos"> 639</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kubernetes_volumes</span><span class="p">()</span>
</span><span id="ClusterSet-640"><a href="#ClusterSet-640"><span class="linenos"> 640</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-641"><a href="#ClusterSet-641"><span class="linenos"> 641</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No kubernetes volumes to delete.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-642"><a href="#ClusterSet-642"><span class="linenos"> 642</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-643"><a href="#ClusterSet-643"><span class="linenos"> 643</span></a>            <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-644"><a href="#ClusterSet-644"><span class="linenos"> 644</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-645"><a href="#ClusterSet-645"><span class="linenos"> 645</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-646"><a href="#ClusterSet-646"><span class="linenos"> 646</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet-647"><a href="#ClusterSet-647"><span class="linenos"> 647</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-648"><a href="#ClusterSet-648"><span class="linenos"> 648</span></a>            <span class="c1"># Wait for the volumes to be deleted</span>
</span><span id="ClusterSet-649"><a href="#ClusterSet-649"><span class="linenos"> 649</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be deleted...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-650"><a href="#ClusterSet-650"><span class="linenos"> 650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_deleted&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-651"><a href="#ClusterSet-651"><span class="linenos"> 651</span></a>
</span><span id="ClusterSet-652"><a href="#ClusterSet-652"><span class="linenos"> 652</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detach_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-653"><a href="#ClusterSet-653"><span class="linenos"> 653</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-654"><a href="#ClusterSet-654"><span class="linenos"> 654</span></a><span class="sd">        Detach all currently attached volumes.</span>
</span><span id="ClusterSet-655"><a href="#ClusterSet-655"><span class="linenos"> 655</span></a>
</span><span id="ClusterSet-656"><a href="#ClusterSet-656"><span class="linenos"> 656</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-657"><a href="#ClusterSet-657"><span class="linenos"> 657</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-658"><a href="#ClusterSet-658"><span class="linenos"> 658</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-659"><a href="#ClusterSet-659"><span class="linenos"> 659</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-660"><a href="#ClusterSet-660"><span class="linenos"> 660</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-661"><a href="#ClusterSet-661"><span class="linenos"> 661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: detach_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-662"><a href="#ClusterSet-662"><span class="linenos"> 662</span></a>        <span class="c1"># Build list of volume_ids so to pass to waiter in one big batch</span>
</span><span id="ClusterSet-663"><a href="#ClusterSet-663"><span class="linenos"> 663</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-664"><a href="#ClusterSet-664"><span class="linenos"> 664</span></a>        <span class="c1"># For each instance, detach all volumes</span>
</span><span id="ClusterSet-665"><a href="#ClusterSet-665"><span class="linenos"> 665</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet-666"><a href="#ClusterSet-666"><span class="linenos"> 666</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-667"><a href="#ClusterSet-667"><span class="linenos"> 667</span></a>            <span class="n">volumes</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ClusterSet-668"><a href="#ClusterSet-668"><span class="linenos"> 668</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-669"><a href="#ClusterSet-669"><span class="linenos"> 669</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Device&#39;</span><span class="p">]</span>
</span><span id="ClusterSet-670"><a href="#ClusterSet-670"><span class="linenos"> 670</span></a>                <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-671"><a href="#ClusterSet-671"><span class="linenos"> 671</span></a>                <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet-672"><a href="#ClusterSet-672"><span class="linenos"> 672</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-673"><a href="#ClusterSet-673"><span class="linenos"> 673</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">detach_from_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-674"><a href="#ClusterSet-674"><span class="linenos"> 674</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-675"><a href="#ClusterSet-675"><span class="linenos"> 675</span></a>        <span class="c1"># Wait for volumes to detach</span>
</span><span id="ClusterSet-676"><a href="#ClusterSet-676"><span class="linenos"> 676</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-677"><a href="#ClusterSet-677"><span class="linenos"> 677</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be detached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-678"><a href="#ClusterSet-678"><span class="linenos"> 678</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-679"><a href="#ClusterSet-679"><span class="linenos"> 679</span></a>
</span><span id="ClusterSet-680"><a href="#ClusterSet-680"><span class="linenos"> 680</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-681"><a href="#ClusterSet-681"><span class="linenos"> 681</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet-682"><a href="#ClusterSet-682"><span class="linenos"> 682</span></a>        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-683"><a href="#ClusterSet-683"><span class="linenos"> 683</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-684"><a href="#ClusterSet-684"><span class="linenos"> 684</span></a>            <span class="n">volume</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-685"><a href="#ClusterSet-685"><span class="linenos"> 685</span></a>
</span><span id="ClusterSet-686"><a href="#ClusterSet-686"><span class="linenos"> 686</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-687"><a href="#ClusterSet-687"><span class="linenos"> 687</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet-688"><a href="#ClusterSet-688"><span class="linenos"> 688</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-689"><a href="#ClusterSet-689"><span class="linenos"> 689</span></a>        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-690"><a href="#ClusterSet-690"><span class="linenos"> 690</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-691"><a href="#ClusterSet-691"><span class="linenos"> 691</span></a>            <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-692"><a href="#ClusterSet-692"><span class="linenos"> 692</span></a>        <span class="c1"># Might as well un-tag on one big batch since volume objects don&#39;t</span>
</span><span id="ClusterSet-693"><a href="#ClusterSet-693"><span class="linenos"> 693</span></a>        <span class="c1"># have direct support for un-tagging.</span>
</span><span id="ClusterSet-694"><a href="#ClusterSet-694"><span class="linenos"> 694</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="n">volume_ids</span><span class="p">,</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-695"><a href="#ClusterSet-695"><span class="linenos"> 695</span></a>
</span><span id="ClusterSet-696"><a href="#ClusterSet-696"><span class="linenos"> 696</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_ids</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
</span><span id="ClusterSet-697"><a href="#ClusterSet-697"><span class="linenos"> 697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-698"><a href="#ClusterSet-698"><span class="linenos"> 698</span></a><span class="sd">        Wait for an action to complete on volumes.</span>
</span><span id="ClusterSet-699"><a href="#ClusterSet-699"><span class="linenos"> 699</span></a>
</span><span id="ClusterSet-700"><a href="#ClusterSet-700"><span class="linenos"> 700</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-701"><a href="#ClusterSet-701"><span class="linenos"> 701</span></a><span class="sd">            volume_ids - volume_ids: list of volume IDs</span>
</span><span id="ClusterSet-702"><a href="#ClusterSet-702"><span class="linenos"> 702</span></a><span class="sd">            status - status to check for completion of action</span>
</span><span id="ClusterSet-703"><a href="#ClusterSet-703"><span class="linenos"> 703</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-704"><a href="#ClusterSet-704"><span class="linenos"> 704</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-705"><a href="#ClusterSet-705"><span class="linenos"> 705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-706"><a href="#ClusterSet-706"><span class="linenos"> 706</span></a>        <span class="c1"># This is a helper method - perhaps it should be static</span>
</span><span id="ClusterSet-707"><a href="#ClusterSet-707"><span class="linenos"> 707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: wait_for_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-708"><a href="#ClusterSet-708"><span class="linenos"> 708</span></a>        <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</span><span id="ClusterSet-709"><a href="#ClusterSet-709"><span class="linenos"> 709</span></a>        <span class="n">waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
</span><span id="ClusterSet-710"><a href="#ClusterSet-710"><span class="linenos"> 710</span></a>            <span class="n">VolumeIds</span><span class="o">=</span><span class="n">volume_ids</span><span class="p">,</span>
</span><span id="ClusterSet-711"><a href="#ClusterSet-711"><span class="linenos"> 711</span></a>            <span class="n">WaiterConfig</span><span class="o">=</span><span class="p">{</span>
</span><span id="ClusterSet-712"><a href="#ClusterSet-712"><span class="linenos"> 712</span></a>                <span class="c1"># &#39;Delay&#39;: 15  # This is the default in seconds</span>
</span><span id="ClusterSet-713"><a href="#ClusterSet-713"><span class="linenos"> 713</span></a>                <span class="s1">&#39;MaxAttempts&#39;</span><span class="p">:</span> <span class="mi">240</span>  <span class="c1"># This will give AWS an hour</span>
</span><span id="ClusterSet-714"><a href="#ClusterSet-714"><span class="linenos"> 714</span></a>            <span class="p">}</span>
</span><span id="ClusterSet-715"><a href="#ClusterSet-715"><span class="linenos"> 715</span></a>        <span class="p">)</span>
</span><span id="ClusterSet-716"><a href="#ClusterSet-716"><span class="linenos"> 716</span></a>
</span><span id="ClusterSet-717"><a href="#ClusterSet-717"><span class="linenos"> 717</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ClusterSet-718"><a href="#ClusterSet-718"><span class="linenos"> 718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-719"><a href="#ClusterSet-719"><span class="linenos"> 719</span></a><span class="sd">        Get a list of cluster snapshots.</span>
</span><span id="ClusterSet-720"><a href="#ClusterSet-720"><span class="linenos"> 720</span></a>
</span><span id="ClusterSet-721"><a href="#ClusterSet-721"><span class="linenos"> 721</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-722"><a href="#ClusterSet-722"><span class="linenos"> 722</span></a><span class="sd">            label - label of snapshots being sought (optional)</span>
</span><span id="ClusterSet-723"><a href="#ClusterSet-723"><span class="linenos"> 723</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-724"><a href="#ClusterSet-724"><span class="linenos"> 724</span></a><span class="sd">            list of snapshots</span>
</span><span id="ClusterSet-725"><a href="#ClusterSet-725"><span class="linenos"> 725</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-726"><a href="#ClusterSet-726"><span class="linenos"> 726</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_all_snapshots&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-727"><a href="#ClusterSet-727"><span class="linenos"> 727</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-728"><a href="#ClusterSet-728"><span class="linenos"> 728</span></a>        <span class="c1"># Only get snapshots in a completed state. It is expected that users</span>
</span><span id="ClusterSet-729"><a href="#ClusterSet-729"><span class="linenos"> 729</span></a>        <span class="c1"># will only call this method after snapshots have been completed.</span>
</span><span id="ClusterSet-730"><a href="#ClusterSet-730"><span class="linenos"> 730</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-731"><a href="#ClusterSet-731"><span class="linenos"> 731</span></a>        <span class="c1"># Only get snapshots that were created by the snapshot manager.</span>
</span><span id="ClusterSet-732"><a href="#ClusterSet-732"><span class="linenos"> 732</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet-733"><a href="#ClusterSet-733"><span class="linenos"> 733</span></a>        <span class="c1"># Optionally, get snapshots with a given label</span>
</span><span id="ClusterSet-734"><a href="#ClusterSet-734"><span class="linenos"> 734</span></a>        <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ClusterSet-735"><a href="#ClusterSet-735"><span class="linenos"> 735</span></a>            <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-736"><a href="#ClusterSet-736"><span class="linenos"> 736</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-737"><a href="#ClusterSet-737"><span class="linenos"> 737</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-738"><a href="#ClusterSet-738"><span class="linenos"> 738</span></a>        <span class="n">snapshot_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">snapshots</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet-739"><a href="#ClusterSet-739"><span class="linenos"> 739</span></a>        <span class="k">return</span> <span class="n">snapshot_list</span>
</span><span id="ClusterSet-740"><a href="#ClusterSet-740"><span class="linenos"> 740</span></a>
</span><span id="ClusterSet-741"><a href="#ClusterSet-741"><span class="linenos"> 741</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet-742"><a href="#ClusterSet-742"><span class="linenos"> 742</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-743"><a href="#ClusterSet-743"><span class="linenos"> 743</span></a><span class="sd">        Create snapshots of volumes.</span>
</span><span id="ClusterSet-744"><a href="#ClusterSet-744"><span class="linenos"> 744</span></a>
</span><span id="ClusterSet-745"><a href="#ClusterSet-745"><span class="linenos"> 745</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-746"><a href="#ClusterSet-746"><span class="linenos"> 746</span></a><span class="sd">            - label: label to apply to each snapshot</span>
</span><span id="ClusterSet-747"><a href="#ClusterSet-747"><span class="linenos"> 747</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-748"><a href="#ClusterSet-748"><span class="linenos"> 748</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-749"><a href="#ClusterSet-749"><span class="linenos"> 749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-750"><a href="#ClusterSet-750"><span class="linenos"> 750</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: create_snapshots&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-751"><a href="#ClusterSet-751"><span class="linenos"> 751</span></a>        <span class="c1"># Check if any snapshots with the same label already exists. If so,</span>
</span><span id="ClusterSet-752"><a href="#ClusterSet-752"><span class="linenos"> 752</span></a>        <span class="c1"># delete them. Only one set of snapshots with a given label may</span>
</span><span id="ClusterSet-753"><a href="#ClusterSet-753"><span class="linenos"> 753</span></a>        <span class="c1"># exist at a time.</span>
</span><span id="ClusterSet-754"><a href="#ClusterSet-754"><span class="linenos"> 754</span></a>        <span class="n">old_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-755"><a href="#ClusterSet-755"><span class="linenos"> 755</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_snapshots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-756"><a href="#ClusterSet-756"><span class="linenos"> 756</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delete_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-757"><a href="#ClusterSet-757"><span class="linenos"> 757</span></a>        <span class="n">snapshot_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-758"><a href="#ClusterSet-758"><span class="linenos"> 758</span></a>        <span class="c1"># Get list of instances that need snapshots taken</span>
</span><span id="ClusterSet-759"><a href="#ClusterSet-759"><span class="linenos"> 759</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet-760"><a href="#ClusterSet-760"><span class="linenos"> 760</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-761"><a href="#ClusterSet-761"><span class="linenos"> 761</span></a>            <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-762"><a href="#ClusterSet-762"><span class="linenos"> 762</span></a>            <span class="c1"># Get collection of volumes for the current instance</span>
</span><span id="ClusterSet-763"><a href="#ClusterSet-763"><span class="linenos"> 763</span></a>            <span class="n">volumes</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ClusterSet-764"><a href="#ClusterSet-764"><span class="linenos"> 764</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-765"><a href="#ClusterSet-765"><span class="linenos"> 765</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Device&#39;</span><span class="p">]</span>
</span><span id="ClusterSet-766"><a href="#ClusterSet-766"><span class="linenos"> 766</span></a>                <span class="c1"># Make description</span>
</span><span id="ClusterSet-767"><a href="#ClusterSet-767"><span class="linenos"> 767</span></a>                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="ClusterSet-768"><a href="#ClusterSet-768"><span class="linenos"> 768</span></a>                <span class="n">date</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-769"><a href="#ClusterSet-769"><span class="linenos"> 769</span></a>                <span class="n">time</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-770"><a href="#ClusterSet-770"><span class="linenos"> 770</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Managed snapshot taken on </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ClusterSet-771"><a href="#ClusterSet-771"><span class="linenos"> 771</span></a>                <span class="c1"># Make tags</span>
</span><span id="ClusterSet-772"><a href="#ClusterSet-772"><span class="linenos"> 772</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>
</span><span id="ClusterSet-773"><a href="#ClusterSet-773"><span class="linenos"> 773</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">)</span>
</span><span id="ClusterSet-774"><a href="#ClusterSet-774"><span class="linenos"> 774</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="ClusterSet-775"><a href="#ClusterSet-775"><span class="linenos"> 775</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">)</span>
</span><span id="ClusterSet-776"><a href="#ClusterSet-776"><span class="linenos"> 776</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-777"><a href="#ClusterSet-777"><span class="linenos"> 777</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-778"><a href="#ClusterSet-778"><span class="linenos"> 778</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet-779"><a href="#ClusterSet-779"><span class="linenos"> 779</span></a>                <span class="n">tags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-780"><a href="#ClusterSet-780"><span class="linenos"> 780</span></a>                <span class="c1"># Create shapshot</span>
</span><span id="ClusterSet-781"><a href="#ClusterSet-781"><span class="linenos"> 781</span></a>                <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet-782"><a href="#ClusterSet-782"><span class="linenos"> 782</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating snapshot of </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) on </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-783"><a href="#ClusterSet-783"><span class="linenos"> 783</span></a>                <span class="n">snapshot</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">create_snapshot</span><span class="p">(</span>
</span><span id="ClusterSet-784"><a href="#ClusterSet-784"><span class="linenos"> 784</span></a>                    <span class="n">Description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
</span><span id="ClusterSet-785"><a href="#ClusterSet-785"><span class="linenos"> 785</span></a>                    <span class="n">TagSpecifications</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;snapshot&#39;</span><span class="p">,</span> <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">}]</span>
</span><span id="ClusterSet-786"><a href="#ClusterSet-786"><span class="linenos"> 786</span></a>                <span class="p">)</span>
</span><span id="ClusterSet-787"><a href="#ClusterSet-787"><span class="linenos"> 787</span></a>                <span class="n">snapshot_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-788"><a href="#ClusterSet-788"><span class="linenos"> 788</span></a>        <span class="c1"># Wait for snapshots to complete</span>
</span><span id="ClusterSet-789"><a href="#ClusterSet-789"><span class="linenos"> 789</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshot_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshots to complete...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-790"><a href="#ClusterSet-790"><span class="linenos"> 790</span></a>        <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;snapshot_completed&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-791"><a href="#ClusterSet-791"><span class="linenos"> 791</span></a>        <span class="n">waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
</span><span id="ClusterSet-792"><a href="#ClusterSet-792"><span class="linenos"> 792</span></a>            <span class="n">SnapshotIds</span><span class="o">=</span><span class="n">snapshot_ids</span><span class="p">,</span>
</span><span id="ClusterSet-793"><a href="#ClusterSet-793"><span class="linenos"> 793</span></a>            <span class="n">WaiterConfig</span><span class="o">=</span><span class="p">{</span>
</span><span id="ClusterSet-794"><a href="#ClusterSet-794"><span class="linenos"> 794</span></a>                <span class="c1"># &#39;Delay&#39;: 15  # This is the default in seconds</span>
</span><span id="ClusterSet-795"><a href="#ClusterSet-795"><span class="linenos"> 795</span></a>                <span class="s1">&#39;MaxAttempts&#39;</span><span class="p">:</span> <span class="mi">240</span>  <span class="c1"># This will give AWS an hour</span>
</span><span id="ClusterSet-796"><a href="#ClusterSet-796"><span class="linenos"> 796</span></a>            <span class="p">}</span>
</span><span id="ClusterSet-797"><a href="#ClusterSet-797"><span class="linenos"> 797</span></a>        <span class="p">)</span>
</span><span id="ClusterSet-798"><a href="#ClusterSet-798"><span class="linenos"> 798</span></a>
</span><span id="ClusterSet-799"><a href="#ClusterSet-799"><span class="linenos"> 799</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet-800"><a href="#ClusterSet-800"><span class="linenos"> 800</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-801"><a href="#ClusterSet-801"><span class="linenos"> 801</span></a><span class="sd">        Delete cluster snapshots that have the given label.</span>
</span><span id="ClusterSet-802"><a href="#ClusterSet-802"><span class="linenos"> 802</span></a>
</span><span id="ClusterSet-803"><a href="#ClusterSet-803"><span class="linenos"> 803</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-804"><a href="#ClusterSet-804"><span class="linenos"> 804</span></a><span class="sd">            label - label of snapshots to be deleted</span>
</span><span id="ClusterSet-805"><a href="#ClusterSet-805"><span class="linenos"> 805</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-806"><a href="#ClusterSet-806"><span class="linenos"> 806</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-807"><a href="#ClusterSet-807"><span class="linenos"> 807</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-808"><a href="#ClusterSet-808"><span class="linenos"> 808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_snapshots&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-809"><a href="#ClusterSet-809"><span class="linenos"> 809</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-810"><a href="#ClusterSet-810"><span class="linenos"> 810</span></a>        <span class="c1"># Delete each snapshot</span>
</span><span id="ClusterSet-811"><a href="#ClusterSet-811"><span class="linenos"> 811</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshots...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-812"><a href="#ClusterSet-812"><span class="linenos"> 812</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet-813"><a href="#ClusterSet-813"><span class="linenos"> 813</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-814"><a href="#ClusterSet-814"><span class="linenos"> 814</span></a>            <span class="n">snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet-815"><a href="#ClusterSet-815"><span class="linenos"> 815</span></a>        <span class="c1"># There is no waiter for snapshot deletion. Add a small delay to guard</span>
</span><span id="ClusterSet-816"><a href="#ClusterSet-816"><span class="linenos"> 816</span></a>        <span class="c1"># against any possible timing issues.</span>
</span><span id="ClusterSet-817"><a href="#ClusterSet-817"><span class="linenos"> 817</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="ClusterSet-818"><a href="#ClusterSet-818"><span class="linenos"> 818</span></a>
</span><span id="ClusterSet-819"><a href="#ClusterSet-819"><span class="linenos"> 819</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-820"><a href="#ClusterSet-820"><span class="linenos"> 820</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">()</span>
</span><span id="ClusterSet-821"><a href="#ClusterSet-821"><span class="linenos"> 821</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet-822"><a href="#ClusterSet-822"><span class="linenos"> 822</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-823"><a href="#ClusterSet-823"><span class="linenos"> 823</span></a>            <span class="n">snapshot</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-824"><a href="#ClusterSet-824"><span class="linenos"> 824</span></a>
</span><span id="ClusterSet-825"><a href="#ClusterSet-825"><span class="linenos"> 825</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-826"><a href="#ClusterSet-826"><span class="linenos"> 826</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">()</span>
</span><span id="ClusterSet-827"><a href="#ClusterSet-827"><span class="linenos"> 827</span></a>        <span class="n">snapshot_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-828"><a href="#ClusterSet-828"><span class="linenos"> 828</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet-829"><a href="#ClusterSet-829"><span class="linenos"> 829</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-830"><a href="#ClusterSet-830"><span class="linenos"> 830</span></a>            <span class="n">snapshot_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-831"><a href="#ClusterSet-831"><span class="linenos"> 831</span></a>        <span class="c1"># Might as well un-tag on one big batch since snapshot objects don&#39;t</span>
</span><span id="ClusterSet-832"><a href="#ClusterSet-832"><span class="linenos"> 832</span></a>        <span class="c1"># have direct support for un-tagging.</span>
</span><span id="ClusterSet-833"><a href="#ClusterSet-833"><span class="linenos"> 833</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="n">snapshot_ids</span><span class="p">,</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-834"><a href="#ClusterSet-834"><span class="linenos"> 834</span></a>
</span><span id="ClusterSet-835"><a href="#ClusterSet-835"><span class="linenos"> 835</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_subnet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet-836"><a href="#ClusterSet-836"><span class="linenos"> 836</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-837"><a href="#ClusterSet-837"><span class="linenos"> 837</span></a><span class="sd">        Get subnet belonging to this cluster.</span>
</span><span id="ClusterSet-838"><a href="#ClusterSet-838"><span class="linenos"> 838</span></a>
</span><span id="ClusterSet-839"><a href="#ClusterSet-839"><span class="linenos"> 839</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-840"><a href="#ClusterSet-840"><span class="linenos"> 840</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-841"><a href="#ClusterSet-841"><span class="linenos"> 841</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-842"><a href="#ClusterSet-842"><span class="linenos"> 842</span></a><span class="sd">            subnet</span>
</span><span id="ClusterSet-843"><a href="#ClusterSet-843"><span class="linenos"> 843</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-844"><a href="#ClusterSet-844"><span class="linenos"> 844</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_subnet&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-845"><a href="#ClusterSet-845"><span class="linenos"> 845</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet-846"><a href="#ClusterSet-846"><span class="linenos"> 846</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-847"><a href="#ClusterSet-847"><span class="linenos"> 847</span></a>        <span class="n">subnets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">subnets</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet-848"><a href="#ClusterSet-848"><span class="linenos"> 848</span></a>        <span class="n">subnet_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subnets</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet-849"><a href="#ClusterSet-849"><span class="linenos"> 849</span></a>        <span class="c1"># There should only be one subnet per cluster</span>
</span><span id="ClusterSet-850"><a href="#ClusterSet-850"><span class="linenos"> 850</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subnet_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ClusterSet-851"><a href="#ClusterSet-851"><span class="linenos"> 851</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error (get_subnet): more than one subnet returned.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-852"><a href="#ClusterSet-852"><span class="linenos"> 852</span></a>        <span class="n">subnet</span> <span class="o">=</span> <span class="n">subnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet-853"><a href="#ClusterSet-853"><span class="linenos"> 853</span></a>        <span class="k">return</span> <span class="n">subnet</span>
</span><span id="ClusterSet-854"><a href="#ClusterSet-854"><span class="linenos"> 854</span></a>
</span><span id="ClusterSet-855"><a href="#ClusterSet-855"><span class="linenos"> 855</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_subnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-856"><a href="#ClusterSet-856"><span class="linenos"> 856</span></a>        <span class="n">subnet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subnet</span><span class="p">()</span>
</span><span id="ClusterSet-857"><a href="#ClusterSet-857"><span class="linenos"> 857</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging subnet </span><span class="si">{</span><span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-858"><a href="#ClusterSet-858"><span class="linenos"> 858</span></a>        <span class="n">subnet</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-859"><a href="#ClusterSet-859"><span class="linenos"> 859</span></a>
</span><span id="ClusterSet-860"><a href="#ClusterSet-860"><span class="linenos"> 860</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_subnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet-861"><a href="#ClusterSet-861"><span class="linenos"> 861</span></a>        <span class="n">subnet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subnet</span><span class="p">()</span>
</span><span id="ClusterSet-862"><a href="#ClusterSet-862"><span class="linenos"> 862</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging subnet </span><span class="si">{</span><span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-863"><a href="#ClusterSet-863"><span class="linenos"> 863</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="p">[</span><span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-864"><a href="#ClusterSet-864"><span class="linenos"> 864</span></a>
</span><span id="ClusterSet-865"><a href="#ClusterSet-865"><span class="linenos"> 865</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_filter_instances_by_name_regex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet-866"><a href="#ClusterSet-866"><span class="linenos"> 866</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-867"><a href="#ClusterSet-867"><span class="linenos"> 867</span></a><span class="sd">        Filter instances by matching their Name tag against a regex pattern.</span>
</span><span id="ClusterSet-868"><a href="#ClusterSet-868"><span class="linenos"> 868</span></a>
</span><span id="ClusterSet-869"><a href="#ClusterSet-869"><span class="linenos"> 869</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-870"><a href="#ClusterSet-870"><span class="linenos"> 870</span></a><span class="sd">            instances: list of EC2 instance objects</span>
</span><span id="ClusterSet-871"><a href="#ClusterSet-871"><span class="linenos"> 871</span></a><span class="sd">            name_pattern: regex pattern to match against Name tags</span>
</span><span id="ClusterSet-872"><a href="#ClusterSet-872"><span class="linenos"> 872</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-873"><a href="#ClusterSet-873"><span class="linenos"> 873</span></a><span class="sd">            list of filtered instances</span>
</span><span id="ClusterSet-874"><a href="#ClusterSet-874"><span class="linenos"> 874</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-875"><a href="#ClusterSet-875"><span class="linenos"> 875</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">name_pattern</span><span class="p">:</span>
</span><span id="ClusterSet-876"><a href="#ClusterSet-876"><span class="linenos"> 876</span></a>            <span class="k">return</span> <span class="n">instances</span>
</span><span id="ClusterSet-877"><a href="#ClusterSet-877"><span class="linenos"> 877</span></a>
</span><span id="ClusterSet-878"><a href="#ClusterSet-878"><span class="linenos"> 878</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ClusterSet-879"><a href="#ClusterSet-879"><span class="linenos"> 879</span></a>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet-880"><a href="#ClusterSet-880"><span class="linenos"> 880</span></a>        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ClusterSet-881"><a href="#ClusterSet-881"><span class="linenos"> 881</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-882"><a href="#ClusterSet-882"><span class="linenos"> 882</span></a>
</span><span id="ClusterSet-883"><a href="#ClusterSet-883"><span class="linenos"> 883</span></a>        <span class="n">filtered_instances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-884"><a href="#ClusterSet-884"><span class="linenos"> 884</span></a>        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-885"><a href="#ClusterSet-885"><span class="linenos"> 885</span></a>            <span class="n">name_tag</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ClusterSet-886"><a href="#ClusterSet-886"><span class="linenos"> 886</span></a>            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
</span><span id="ClusterSet-887"><a href="#ClusterSet-887"><span class="linenos"> 887</span></a>                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">instance</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
</span><span id="ClusterSet-888"><a href="#ClusterSet-888"><span class="linenos"> 888</span></a>                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Name&#39;</span><span class="p">:</span>
</span><span id="ClusterSet-889"><a href="#ClusterSet-889"><span class="linenos"> 889</span></a>                        <span class="n">name_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
</span><span id="ClusterSet-890"><a href="#ClusterSet-890"><span class="linenos"> 890</span></a>                        <span class="k">break</span>
</span><span id="ClusterSet-891"><a href="#ClusterSet-891"><span class="linenos"> 891</span></a>
</span><span id="ClusterSet-892"><a href="#ClusterSet-892"><span class="linenos"> 892</span></a>            <span class="k">if</span> <span class="n">name_tag</span> <span class="ow">and</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">name_tag</span><span class="p">):</span>
</span><span id="ClusterSet-893"><a href="#ClusterSet-893"><span class="linenos"> 893</span></a>                <span class="n">filtered_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
</span><span id="ClusterSet-894"><a href="#ClusterSet-894"><span class="linenos"> 894</span></a>
</span><span id="ClusterSet-895"><a href="#ClusterSet-895"><span class="linenos"> 895</span></a>        <span class="k">return</span> <span class="n">filtered_instances</span>
</span><span id="ClusterSet-896"><a href="#ClusterSet-896"><span class="linenos"> 896</span></a>
</span><span id="ClusterSet-897"><a href="#ClusterSet-897"><span class="linenos"> 897</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_instances_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet-898"><a href="#ClusterSet-898"><span class="linenos"> 898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-899"><a href="#ClusterSet-899"><span class="linenos"> 899</span></a><span class="sd">        Stop instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet-900"><a href="#ClusterSet-900"><span class="linenos"> 900</span></a>
</span><span id="ClusterSet-901"><a href="#ClusterSet-901"><span class="linenos"> 901</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-902"><a href="#ClusterSet-902"><span class="linenos"> 902</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet-903"><a href="#ClusterSet-903"><span class="linenos"> 903</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-904"><a href="#ClusterSet-904"><span class="linenos"> 904</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-905"><a href="#ClusterSet-905"><span class="linenos"> 905</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-906"><a href="#ClusterSet-906"><span class="linenos"> 906</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: stop_instances_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-907"><a href="#ClusterSet-907"><span class="linenos"> 907</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_running_instances</span><span class="p">()</span>
</span><span id="ClusterSet-908"><a href="#ClusterSet-908"><span class="linenos"> 908</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet-909"><a href="#ClusterSet-909"><span class="linenos"> 909</span></a>
</span><span id="ClusterSet-910"><a href="#ClusterSet-910"><span class="linenos"> 910</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-911"><a href="#ClusterSet-911"><span class="linenos"> 911</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No running instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-912"><a href="#ClusterSet-912"><span class="linenos"> 912</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-913"><a href="#ClusterSet-913"><span class="linenos"> 913</span></a>            <span class="c1"># Stop instances</span>
</span><span id="ClusterSet-914"><a href="#ClusterSet-914"><span class="linenos"> 914</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-915"><a href="#ClusterSet-915"><span class="linenos"> 915</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-916"><a href="#ClusterSet-916"><span class="linenos"> 916</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-917"><a href="#ClusterSet-917"><span class="linenos"> 917</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="ClusterSet-918"><a href="#ClusterSet-918"><span class="linenos"> 918</span></a>            <span class="c1"># Wait for instances to stop</span>
</span><span id="ClusterSet-919"><a href="#ClusterSet-919"><span class="linenos"> 919</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to stop...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-920"><a href="#ClusterSet-920"><span class="linenos"> 920</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-921"><a href="#ClusterSet-921"><span class="linenos"> 921</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_stopped</span><span class="p">()</span>
</span><span id="ClusterSet-922"><a href="#ClusterSet-922"><span class="linenos"> 922</span></a>
</span><span id="ClusterSet-923"><a href="#ClusterSet-923"><span class="linenos"> 923</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_instances_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet-924"><a href="#ClusterSet-924"><span class="linenos"> 924</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-925"><a href="#ClusterSet-925"><span class="linenos"> 925</span></a><span class="sd">        Start instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet-926"><a href="#ClusterSet-926"><span class="linenos"> 926</span></a>
</span><span id="ClusterSet-927"><a href="#ClusterSet-927"><span class="linenos"> 927</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-928"><a href="#ClusterSet-928"><span class="linenos"> 928</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet-929"><a href="#ClusterSet-929"><span class="linenos"> 929</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-930"><a href="#ClusterSet-930"><span class="linenos"> 930</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-931"><a href="#ClusterSet-931"><span class="linenos"> 931</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-932"><a href="#ClusterSet-932"><span class="linenos"> 932</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: start_instances_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-933"><a href="#ClusterSet-933"><span class="linenos"> 933</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stopped_instances</span><span class="p">()</span>
</span><span id="ClusterSet-934"><a href="#ClusterSet-934"><span class="linenos"> 934</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet-935"><a href="#ClusterSet-935"><span class="linenos"> 935</span></a>
</span><span id="ClusterSet-936"><a href="#ClusterSet-936"><span class="linenos"> 936</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-937"><a href="#ClusterSet-937"><span class="linenos"> 937</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No stopped instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-938"><a href="#ClusterSet-938"><span class="linenos"> 938</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-939"><a href="#ClusterSet-939"><span class="linenos"> 939</span></a>            <span class="c1"># Start instances</span>
</span><span id="ClusterSet-940"><a href="#ClusterSet-940"><span class="linenos"> 940</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-941"><a href="#ClusterSet-941"><span class="linenos"> 941</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-942"><a href="#ClusterSet-942"><span class="linenos"> 942</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-943"><a href="#ClusterSet-943"><span class="linenos"> 943</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="ClusterSet-944"><a href="#ClusterSet-944"><span class="linenos"> 944</span></a>            <span class="c1"># Wait for instances to start</span>
</span><span id="ClusterSet-945"><a href="#ClusterSet-945"><span class="linenos"> 945</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to start...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-946"><a href="#ClusterSet-946"><span class="linenos"> 946</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-947"><a href="#ClusterSet-947"><span class="linenos"> 947</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_running</span><span class="p">()</span>
</span><span id="ClusterSet-948"><a href="#ClusterSet-948"><span class="linenos"> 948</span></a>
</span><span id="ClusterSet-949"><a href="#ClusterSet-949"><span class="linenos"> 949</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detach_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet-950"><a href="#ClusterSet-950"><span class="linenos"> 950</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-951"><a href="#ClusterSet-951"><span class="linenos"> 951</span></a><span class="sd">        Detach volumes from instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet-952"><a href="#ClusterSet-952"><span class="linenos"> 952</span></a>
</span><span id="ClusterSet-953"><a href="#ClusterSet-953"><span class="linenos"> 953</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-954"><a href="#ClusterSet-954"><span class="linenos"> 954</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet-955"><a href="#ClusterSet-955"><span class="linenos"> 955</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-956"><a href="#ClusterSet-956"><span class="linenos"> 956</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-957"><a href="#ClusterSet-957"><span class="linenos"> 957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-958"><a href="#ClusterSet-958"><span class="linenos"> 958</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: detach_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-959"><a href="#ClusterSet-959"><span class="linenos"> 959</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet-960"><a href="#ClusterSet-960"><span class="linenos"> 960</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet-961"><a href="#ClusterSet-961"><span class="linenos"> 961</span></a>
</span><span id="ClusterSet-962"><a href="#ClusterSet-962"><span class="linenos"> 962</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-963"><a href="#ClusterSet-963"><span class="linenos"> 963</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-964"><a href="#ClusterSet-964"><span class="linenos"> 964</span></a>            <span class="k">return</span>
</span><span id="ClusterSet-965"><a href="#ClusterSet-965"><span class="linenos"> 965</span></a>
</span><span id="ClusterSet-966"><a href="#ClusterSet-966"><span class="linenos"> 966</span></a>        <span class="c1"># Build list of volume_ids so to pass to waiter in one big batch</span>
</span><span id="ClusterSet-967"><a href="#ClusterSet-967"><span class="linenos"> 967</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-968"><a href="#ClusterSet-968"><span class="linenos"> 968</span></a>        <span class="c1"># For each matching instance, detach all volumes</span>
</span><span id="ClusterSet-969"><a href="#ClusterSet-969"><span class="linenos"> 969</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-970"><a href="#ClusterSet-970"><span class="linenos"> 970</span></a>            <span class="n">volumes</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ClusterSet-971"><a href="#ClusterSet-971"><span class="linenos"> 971</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-972"><a href="#ClusterSet-972"><span class="linenos"> 972</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Device&#39;</span><span class="p">]</span>
</span><span id="ClusterSet-973"><a href="#ClusterSet-973"><span class="linenos"> 973</span></a>                <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-974"><a href="#ClusterSet-974"><span class="linenos"> 974</span></a>                <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet-975"><a href="#ClusterSet-975"><span class="linenos"> 975</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-976"><a href="#ClusterSet-976"><span class="linenos"> 976</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">detach_from_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-977"><a href="#ClusterSet-977"><span class="linenos"> 977</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-978"><a href="#ClusterSet-978"><span class="linenos"> 978</span></a>        <span class="c1"># Wait for volumes to detach</span>
</span><span id="ClusterSet-979"><a href="#ClusterSet-979"><span class="linenos"> 979</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-980"><a href="#ClusterSet-980"><span class="linenos"> 980</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be detached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-981"><a href="#ClusterSet-981"><span class="linenos"> 981</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-982"><a href="#ClusterSet-982"><span class="linenos"> 982</span></a>
</span><span id="ClusterSet-983"><a href="#ClusterSet-983"><span class="linenos"> 983</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet-984"><a href="#ClusterSet-984"><span class="linenos"> 984</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-985"><a href="#ClusterSet-985"><span class="linenos"> 985</span></a><span class="sd">        Delete volumes associated with instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet-986"><a href="#ClusterSet-986"><span class="linenos"> 986</span></a>
</span><span id="ClusterSet-987"><a href="#ClusterSet-987"><span class="linenos"> 987</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-988"><a href="#ClusterSet-988"><span class="linenos"> 988</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet-989"><a href="#ClusterSet-989"><span class="linenos"> 989</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-990"><a href="#ClusterSet-990"><span class="linenos"> 990</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-991"><a href="#ClusterSet-991"><span class="linenos"> 991</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-992"><a href="#ClusterSet-992"><span class="linenos"> 992</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-993"><a href="#ClusterSet-993"><span class="linenos"> 993</span></a>        <span class="c1"># Get all volumes and filter by instance name pattern</span>
</span><span id="ClusterSet-994"><a href="#ClusterSet-994"><span class="linenos"> 994</span></a>        <span class="n">all_volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet-995"><a href="#ClusterSet-995"><span class="linenos"> 995</span></a>        <span class="n">targeted_volumes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-996"><a href="#ClusterSet-996"><span class="linenos"> 996</span></a>
</span><span id="ClusterSet-997"><a href="#ClusterSet-997"><span class="linenos"> 997</span></a>        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">all_volumes</span><span class="p">:</span>
</span><span id="ClusterSet-998"><a href="#ClusterSet-998"><span class="linenos"> 998</span></a>            <span class="n">volume_instance_tag</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ClusterSet-999"><a href="#ClusterSet-999"><span class="linenos"> 999</span></a>            <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
</span><span id="ClusterSet-1000"><a href="#ClusterSet-1000"><span class="linenos">1000</span></a>                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
</span><span id="ClusterSet-1001"><a href="#ClusterSet-1001"><span class="linenos">1001</span></a>                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Instance&#39;</span><span class="p">:</span>
</span><span id="ClusterSet-1002"><a href="#ClusterSet-1002"><span class="linenos">1002</span></a>                        <span class="n">volume_instance_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
</span><span id="ClusterSet-1003"><a href="#ClusterSet-1003"><span class="linenos">1003</span></a>                        <span class="k">break</span>
</span><span id="ClusterSet-1004"><a href="#ClusterSet-1004"><span class="linenos">1004</span></a>
</span><span id="ClusterSet-1005"><a href="#ClusterSet-1005"><span class="linenos">1005</span></a>            <span class="k">if</span> <span class="n">volume_instance_tag</span><span class="p">:</span>
</span><span id="ClusterSet-1006"><a href="#ClusterSet-1006"><span class="linenos">1006</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ClusterSet-1007"><a href="#ClusterSet-1007"><span class="linenos">1007</span></a>                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet-1008"><a href="#ClusterSet-1008"><span class="linenos">1008</span></a>                    <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">volume_instance_tag</span><span class="p">):</span>
</span><span id="ClusterSet-1009"><a href="#ClusterSet-1009"><span class="linenos">1009</span></a>                        <span class="n">targeted_volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
</span><span id="ClusterSet-1010"><a href="#ClusterSet-1010"><span class="linenos">1010</span></a>                <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ClusterSet-1011"><a href="#ClusterSet-1011"><span class="linenos">1011</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1012"><a href="#ClusterSet-1012"><span class="linenos">1012</span></a>
</span><span id="ClusterSet-1013"><a href="#ClusterSet-1013"><span class="linenos">1013</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targeted_volumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-1014"><a href="#ClusterSet-1014"><span class="linenos">1014</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No volumes found for instances matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1015"><a href="#ClusterSet-1015"><span class="linenos">1015</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-1016"><a href="#ClusterSet-1016"><span class="linenos">1016</span></a>            <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-1017"><a href="#ClusterSet-1017"><span class="linenos">1017</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">targeted_volumes</span><span class="p">:</span>
</span><span id="ClusterSet-1018"><a href="#ClusterSet-1018"><span class="linenos">1018</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1019"><a href="#ClusterSet-1019"><span class="linenos">1019</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet-1020"><a href="#ClusterSet-1020"><span class="linenos">1020</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-1021"><a href="#ClusterSet-1021"><span class="linenos">1021</span></a>            <span class="c1"># Wait for the volumes to be deleted</span>
</span><span id="ClusterSet-1022"><a href="#ClusterSet-1022"><span class="linenos">1022</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be deleted...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1023"><a href="#ClusterSet-1023"><span class="linenos">1023</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_deleted&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1024"><a href="#ClusterSet-1024"><span class="linenos">1024</span></a>
</span><span id="ClusterSet-1025"><a href="#ClusterSet-1025"><span class="linenos">1025</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet-1026"><a href="#ClusterSet-1026"><span class="linenos">1026</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-1027"><a href="#ClusterSet-1027"><span class="linenos">1027</span></a><span class="sd">        Create new volumes from snapshots for instances matching the given Name tag regex pattern.</span>
</span><span id="ClusterSet-1028"><a href="#ClusterSet-1028"><span class="linenos">1028</span></a>
</span><span id="ClusterSet-1029"><a href="#ClusterSet-1029"><span class="linenos">1029</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-1030"><a href="#ClusterSet-1030"><span class="linenos">1030</span></a><span class="sd">            label: label of snapshots to restore</span>
</span><span id="ClusterSet-1031"><a href="#ClusterSet-1031"><span class="linenos">1031</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet-1032"><a href="#ClusterSet-1032"><span class="linenos">1032</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-1033"><a href="#ClusterSet-1033"><span class="linenos">1033</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-1034"><a href="#ClusterSet-1034"><span class="linenos">1034</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-1035"><a href="#ClusterSet-1035"><span class="linenos">1035</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: create_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1036"><a href="#ClusterSet-1036"><span class="linenos">1036</span></a>
</span><span id="ClusterSet-1037"><a href="#ClusterSet-1037"><span class="linenos">1037</span></a>        <span class="c1"># Validate regex pattern first</span>
</span><span id="ClusterSet-1038"><a href="#ClusterSet-1038"><span class="linenos">1038</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ClusterSet-1039"><a href="#ClusterSet-1039"><span class="linenos">1039</span></a>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet-1040"><a href="#ClusterSet-1040"><span class="linenos">1040</span></a>        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ClusterSet-1041"><a href="#ClusterSet-1041"><span class="linenos">1041</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1042"><a href="#ClusterSet-1042"><span class="linenos">1042</span></a>
</span><span id="ClusterSet-1043"><a href="#ClusterSet-1043"><span class="linenos">1043</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-1044"><a href="#ClusterSet-1044"><span class="linenos">1044</span></a>
</span><span id="ClusterSet-1045"><a href="#ClusterSet-1045"><span class="linenos">1045</span></a>        <span class="c1"># Check if snapshot list is empty</span>
</span><span id="ClusterSet-1046"><a href="#ClusterSet-1046"><span class="linenos">1046</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-1047"><a href="#ClusterSet-1047"><span class="linenos">1047</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No snapshots found with label &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1048"><a href="#ClusterSet-1048"><span class="linenos">1048</span></a>            <span class="k">return</span>
</span><span id="ClusterSet-1049"><a href="#ClusterSet-1049"><span class="linenos">1049</span></a>
</span><span id="ClusterSet-1050"><a href="#ClusterSet-1050"><span class="linenos">1050</span></a>        <span class="c1"># Filter snapshots by instance name pattern</span>
</span><span id="ClusterSet-1051"><a href="#ClusterSet-1051"><span class="linenos">1051</span></a>        <span class="n">targeted_snapshots</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-1052"><a href="#ClusterSet-1052"><span class="linenos">1052</span></a>
</span><span id="ClusterSet-1053"><a href="#ClusterSet-1053"><span class="linenos">1053</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet-1054"><a href="#ClusterSet-1054"><span class="linenos">1054</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-1055"><a href="#ClusterSet-1055"><span class="linenos">1055</span></a>            <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1056"><a href="#ClusterSet-1056"><span class="linenos">1056</span></a>            <span class="k">if</span> <span class="n">instance</span> <span class="ow">and</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
</span><span id="ClusterSet-1057"><a href="#ClusterSet-1057"><span class="linenos">1057</span></a>                <span class="n">targeted_snapshots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
</span><span id="ClusterSet-1058"><a href="#ClusterSet-1058"><span class="linenos">1058</span></a>
</span><span id="ClusterSet-1059"><a href="#ClusterSet-1059"><span class="linenos">1059</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targeted_snapshots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-1060"><a href="#ClusterSet-1060"><span class="linenos">1060</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No snapshots found for instances matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1061"><a href="#ClusterSet-1061"><span class="linenos">1061</span></a>            <span class="k">return</span>
</span><span id="ClusterSet-1062"><a href="#ClusterSet-1062"><span class="linenos">1062</span></a>
</span><span id="ClusterSet-1063"><a href="#ClusterSet-1063"><span class="linenos">1063</span></a>        <span class="c1"># Create volumes</span>
</span><span id="ClusterSet-1064"><a href="#ClusterSet-1064"><span class="linenos">1064</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-1065"><a href="#ClusterSet-1065"><span class="linenos">1065</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">targeted_snapshots</span><span class="p">:</span>
</span><span id="ClusterSet-1066"><a href="#ClusterSet-1066"><span class="linenos">1066</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-1067"><a href="#ClusterSet-1067"><span class="linenos">1067</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1068"><a href="#ClusterSet-1068"><span class="linenos">1068</span></a>            <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1069"><a href="#ClusterSet-1069"><span class="linenos">1069</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="p">:</span>
</span><span id="ClusterSet-1070"><a href="#ClusterSet-1070"><span class="linenos">1070</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find device tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1071"><a href="#ClusterSet-1071"><span class="linenos">1071</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span><span id="ClusterSet-1072"><a href="#ClusterSet-1072"><span class="linenos">1072</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find instance tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1073"><a href="#ClusterSet-1073"><span class="linenos">1073</span></a>
</span><span id="ClusterSet-1074"><a href="#ClusterSet-1074"><span class="linenos">1074</span></a>            <span class="c1"># Determine availability zone from one of the cluster instances</span>
</span><span id="ClusterSet-1075"><a href="#ClusterSet-1075"><span class="linenos">1075</span></a>            <span class="n">avail_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">placement</span><span class="p">[</span><span class="s1">&#39;AvailabilityZone&#39;</span><span class="p">]</span>
</span><span id="ClusterSet-1076"><a href="#ClusterSet-1076"><span class="linenos">1076</span></a>            <span class="c1"># Make tags</span>
</span><span id="ClusterSet-1077"><a href="#ClusterSet-1077"><span class="linenos">1077</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>
</span><span id="ClusterSet-1078"><a href="#ClusterSet-1078"><span class="linenos">1078</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">)</span>
</span><span id="ClusterSet-1079"><a href="#ClusterSet-1079"><span class="linenos">1079</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="ClusterSet-1080"><a href="#ClusterSet-1080"><span class="linenos">1080</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="ClusterSet-1081"><a href="#ClusterSet-1081"><span class="linenos">1081</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-1082"><a href="#ClusterSet-1082"><span class="linenos">1082</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1083"><a href="#ClusterSet-1083"><span class="linenos">1083</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet-1084"><a href="#ClusterSet-1084"><span class="linenos">1084</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet-1085"><a href="#ClusterSet-1085"><span class="linenos">1085</span></a>            <span class="c1"># Create volume</span>
</span><span id="ClusterSet-1086"><a href="#ClusterSet-1086"><span class="linenos">1086</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating volume from snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1087"><a href="#ClusterSet-1087"><span class="linenos">1087</span></a>            <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">create_volume</span><span class="p">(</span>
</span><span id="ClusterSet-1088"><a href="#ClusterSet-1088"><span class="linenos">1088</span></a>                <span class="n">SnapshotId</span><span class="o">=</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="ClusterSet-1089"><a href="#ClusterSet-1089"><span class="linenos">1089</span></a>                <span class="n">AvailabilityZone</span><span class="o">=</span><span class="n">avail_zone</span><span class="p">,</span>
</span><span id="ClusterSet-1090"><a href="#ClusterSet-1090"><span class="linenos">1090</span></a>                <span class="n">TagSpecifications</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">}]</span>
</span><span id="ClusterSet-1091"><a href="#ClusterSet-1091"><span class="linenos">1091</span></a>            <span class="p">)</span>
</span><span id="ClusterSet-1092"><a href="#ClusterSet-1092"><span class="linenos">1092</span></a>            <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-1093"><a href="#ClusterSet-1093"><span class="linenos">1093</span></a>
</span><span id="ClusterSet-1094"><a href="#ClusterSet-1094"><span class="linenos">1094</span></a>        <span class="c1"># Wait for the volumes to be created</span>
</span><span id="ClusterSet-1095"><a href="#ClusterSet-1095"><span class="linenos">1095</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-1096"><a href="#ClusterSet-1096"><span class="linenos">1096</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be created...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1097"><a href="#ClusterSet-1097"><span class="linenos">1097</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1098"><a href="#ClusterSet-1098"><span class="linenos">1098</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="ClusterSet-1099"><a href="#ClusterSet-1099"><span class="linenos">1099</span></a>
</span><span id="ClusterSet-1100"><a href="#ClusterSet-1100"><span class="linenos">1100</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">attach_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet-1101"><a href="#ClusterSet-1101"><span class="linenos">1101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet-1102"><a href="#ClusterSet-1102"><span class="linenos">1102</span></a><span class="sd">        Attach volumes to instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet-1103"><a href="#ClusterSet-1103"><span class="linenos">1103</span></a>
</span><span id="ClusterSet-1104"><a href="#ClusterSet-1104"><span class="linenos">1104</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet-1105"><a href="#ClusterSet-1105"><span class="linenos">1105</span></a><span class="sd">            label: label of volumes to attach</span>
</span><span id="ClusterSet-1106"><a href="#ClusterSet-1106"><span class="linenos">1106</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet-1107"><a href="#ClusterSet-1107"><span class="linenos">1107</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet-1108"><a href="#ClusterSet-1108"><span class="linenos">1108</span></a><span class="sd">            none</span>
</span><span id="ClusterSet-1109"><a href="#ClusterSet-1109"><span class="linenos">1109</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet-1110"><a href="#ClusterSet-1110"><span class="linenos">1110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: attach_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1111"><a href="#ClusterSet-1111"><span class="linenos">1111</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet-1112"><a href="#ClusterSet-1112"><span class="linenos">1112</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet-1113"><a href="#ClusterSet-1113"><span class="linenos">1113</span></a>
</span><span id="ClusterSet-1114"><a href="#ClusterSet-1114"><span class="linenos">1114</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-1115"><a href="#ClusterSet-1115"><span class="linenos">1115</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1116"><a href="#ClusterSet-1116"><span class="linenos">1116</span></a>            <span class="k">return</span>
</span><span id="ClusterSet-1117"><a href="#ClusterSet-1117"><span class="linenos">1117</span></a>
</span><span id="ClusterSet-1118"><a href="#ClusterSet-1118"><span class="linenos">1118</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restored_volumes</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet-1119"><a href="#ClusterSet-1119"><span class="linenos">1119</span></a>
</span><span id="ClusterSet-1120"><a href="#ClusterSet-1120"><span class="linenos">1120</span></a>        <span class="c1"># Note: regex pattern already validated in _filter_instances_by_name_regex</span>
</span><span id="ClusterSet-1121"><a href="#ClusterSet-1121"><span class="linenos">1121</span></a>
</span><span id="ClusterSet-1122"><a href="#ClusterSet-1122"><span class="linenos">1122</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet-1123"><a href="#ClusterSet-1123"><span class="linenos">1123</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet-1124"><a href="#ClusterSet-1124"><span class="linenos">1124</span></a>            <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1125"><a href="#ClusterSet-1125"><span class="linenos">1125</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet-1126"><a href="#ClusterSet-1126"><span class="linenos">1126</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet-1127"><a href="#ClusterSet-1127"><span class="linenos">1127</span></a>                <span class="n">volume_instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1128"><a href="#ClusterSet-1128"><span class="linenos">1128</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet-1129"><a href="#ClusterSet-1129"><span class="linenos">1129</span></a>                <span class="k">if</span> <span class="n">volume_instance</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
</span><span id="ClusterSet-1130"><a href="#ClusterSet-1130"><span class="linenos">1130</span></a>                    <span class="c1"># Attach volume</span>
</span><span id="ClusterSet-1131"><a href="#ClusterSet-1131"><span class="linenos">1131</span></a>                    <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet-1132"><a href="#ClusterSet-1132"><span class="linenos">1132</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1133"><a href="#ClusterSet-1133"><span class="linenos">1133</span></a>                    <span class="n">volume</span><span class="o">.</span><span class="n">attach_to_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-1134"><a href="#ClusterSet-1134"><span class="linenos">1134</span></a>                    <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet-1135"><a href="#ClusterSet-1135"><span class="linenos">1135</span></a>
</span><span id="ClusterSet-1136"><a href="#ClusterSet-1136"><span class="linenos">1136</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet-1137"><a href="#ClusterSet-1137"><span class="linenos">1137</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No volumes to attach for instances matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1138"><a href="#ClusterSet-1138"><span class="linenos">1138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet-1139"><a href="#ClusterSet-1139"><span class="linenos">1139</span></a>            <span class="c1"># Wait for the volumes to be attached</span>
</span><span id="ClusterSet-1140"><a href="#ClusterSet-1140"><span class="linenos">1140</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be attached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet-1141"><a href="#ClusterSet-1141"><span class="linenos">1141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_in_use&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Manages collections of EC2 instances based on cluster tags.</p>

<p>The ClusterSet class provides comprehensive cluster management functionality
including instance lifecycle management, volume operations, and snapshot
management. It uses tag-based resource identification to ensure operations
only affect intended resources.</p>

<p>Attributes:
    cluster_names: The name(s) of the cluster(s) being managed
    _MAX_ITEMS: Safety limit for collection operations (150)
    AUTOMATION_KEY: Key used to track managed resources ('SNAPSHOT_MANAGER')</p>

<p>Note:
    All operations rely on the "Cluster" tag to identify cluster membership.
    The class includes built-in safety features to prevent accidental
    modification of unmanaged resources.</p>
</div>


                            <div id="ClusterSet.__init__" class="classattr">
                                        <input id="ClusterSet.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ClusterSet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">cluster_names</span>, </span><span class="param"><span class="n">profile</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="ClusterSet.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.__init__-72"><a href="#ClusterSet.__init__-72"><span class="linenos"> 72</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cluster_names</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ClusterSet.__init__-73"><a href="#ClusterSet.__init__-73"><span class="linenos"> 73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize ClusterSet for managing one or more clusters.</span>
</span><span id="ClusterSet.__init__-74"><a href="#ClusterSet.__init__-74"><span class="linenos"> 74</span></a>
</span><span id="ClusterSet.__init__-75"><a href="#ClusterSet.__init__-75"><span class="linenos"> 75</span></a><span class="sd">        Creates a new ClusterSet instance for managing EC2 instances and related</span>
</span><span id="ClusterSet.__init__-76"><a href="#ClusterSet.__init__-76"><span class="linenos"> 76</span></a><span class="sd">        resources (volumes, snapshots) for the specified cluster(s). Sets up</span>
</span><span id="ClusterSet.__init__-77"><a href="#ClusterSet.__init__-77"><span class="linenos"> 77</span></a><span class="sd">        AWS connectivity and initializes safety limits and automation tracking.</span>
</span><span id="ClusterSet.__init__-78"><a href="#ClusterSet.__init__-78"><span class="linenos"> 78</span></a>
</span><span id="ClusterSet.__init__-79"><a href="#ClusterSet.__init__-79"><span class="linenos"> 79</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.__init__-80"><a href="#ClusterSet.__init__-80"><span class="linenos"> 80</span></a><span class="sd">            cluster_names: The name of a cluster (str) or list of cluster names (list).</span>
</span><span id="ClusterSet.__init__-81"><a href="#ClusterSet.__init__-81"><span class="linenos"> 81</span></a><span class="sd">                         Must match the &quot;Cluster&quot; tag value on EC2 instances.</span>
</span><span id="ClusterSet.__init__-82"><a href="#ClusterSet.__init__-82"><span class="linenos"> 82</span></a><span class="sd">            profile: AWS profile name to use for authentication (optional).</span>
</span><span id="ClusterSet.__init__-83"><a href="#ClusterSet.__init__-83"><span class="linenos"> 83</span></a><span class="sd">                    If None, uses default AWS credentials chain.</span>
</span><span id="ClusterSet.__init__-84"><a href="#ClusterSet.__init__-84"><span class="linenos"> 84</span></a>
</span><span id="ClusterSet.__init__-85"><a href="#ClusterSet.__init__-85"><span class="linenos"> 85</span></a><span class="sd">        Example:</span>
</span><span id="ClusterSet.__init__-86"><a href="#ClusterSet.__init__-86"><span class="linenos"> 86</span></a><span class="sd">            ```python</span>
</span><span id="ClusterSet.__init__-87"><a href="#ClusterSet.__init__-87"><span class="linenos"> 87</span></a><span class="sd">            # Single cluster</span>
</span><span id="ClusterSet.__init__-88"><a href="#ClusterSet.__init__-88"><span class="linenos"> 88</span></a><span class="sd">            cluster = ClusterSet(&#39;production-web&#39;)</span>
</span><span id="ClusterSet.__init__-89"><a href="#ClusterSet.__init__-89"><span class="linenos"> 89</span></a>
</span><span id="ClusterSet.__init__-90"><a href="#ClusterSet.__init__-90"><span class="linenos"> 90</span></a><span class="sd">            # Multiple clusters</span>
</span><span id="ClusterSet.__init__-91"><a href="#ClusterSet.__init__-91"><span class="linenos"> 91</span></a><span class="sd">            clusters = ClusterSet([&#39;prod-web&#39;, &#39;prod-api&#39;])</span>
</span><span id="ClusterSet.__init__-92"><a href="#ClusterSet.__init__-92"><span class="linenos"> 92</span></a>
</span><span id="ClusterSet.__init__-93"><a href="#ClusterSet.__init__-93"><span class="linenos"> 93</span></a><span class="sd">            # With specific AWS profile</span>
</span><span id="ClusterSet.__init__-94"><a href="#ClusterSet.__init__-94"><span class="linenos"> 94</span></a><span class="sd">            cluster = ClusterSet(&#39;staging&#39;, profile=&#39;dev-account&#39;)</span>
</span><span id="ClusterSet.__init__-95"><a href="#ClusterSet.__init__-95"><span class="linenos"> 95</span></a><span class="sd">            ```</span>
</span><span id="ClusterSet.__init__-96"><a href="#ClusterSet.__init__-96"><span class="linenos"> 96</span></a>
</span><span id="ClusterSet.__init__-97"><a href="#ClusterSet.__init__-97"><span class="linenos"> 97</span></a><span class="sd">        Note:</span>
</span><span id="ClusterSet.__init__-98"><a href="#ClusterSet.__init__-98"><span class="linenos"> 98</span></a><span class="sd">            The cluster names must exactly match the &quot;Cluster&quot; tag values</span>
</span><span id="ClusterSet.__init__-99"><a href="#ClusterSet.__init__-99"><span class="linenos"> 99</span></a><span class="sd">            on your EC2 instances for operations to work correctly.</span>
</span><span id="ClusterSet.__init__-100"><a href="#ClusterSet.__init__-100"><span class="linenos">100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.__init__-101"><a href="#ClusterSet.__init__-101"><span class="linenos">101</span></a>        <span class="c1"># Collections operate lazily. Turning a collection into a list can cause</span>
</span><span id="ClusterSet.__init__-102"><a href="#ClusterSet.__init__-102"><span class="linenos">102</span></a>        <span class="c1"># performance issues if the collection is very large. Although this is</span>
</span><span id="ClusterSet.__init__-103"><a href="#ClusterSet.__init__-103"><span class="linenos">103</span></a>        <span class="c1"># unlikely in our environment, we protect against this by setting an</span>
</span><span id="ClusterSet.__init__-104"><a href="#ClusterSet.__init__-104"><span class="linenos">104</span></a>        <span class="c1"># upper bound on the number of items from the collection that can be</span>
</span><span id="ClusterSet.__init__-105"><a href="#ClusterSet.__init__-105"><span class="linenos">105</span></a>        <span class="c1"># placed in the list. If the number of items in the collection exceed</span>
</span><span id="ClusterSet.__init__-106"><a href="#ClusterSet.__init__-106"><span class="linenos">106</span></a>        <span class="c1"># this upper bound, then those items will not be processed. If this</span>
</span><span id="ClusterSet.__init__-107"><a href="#ClusterSet.__init__-107"><span class="linenos">107</span></a>        <span class="c1"># happens, then it can be addressed by increasing this value.</span>
</span><span id="ClusterSet.__init__-108"><a href="#ClusterSet.__init__-108"><span class="linenos">108</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span> <span class="o">=</span> <span class="mi">150</span>
</span><span id="ClusterSet.__init__-109"><a href="#ClusterSet.__init__-109"><span class="linenos">109</span></a>
</span><span id="ClusterSet.__init__-110"><a href="#ClusterSet.__init__-110"><span class="linenos">110</span></a>        <span class="c1"># Used to ensure we don&#39;t clobber anything we don&#39;t make</span>
</span><span id="ClusterSet.__init__-111"><a href="#ClusterSet.__init__-111"><span class="linenos">111</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span> <span class="o">=</span> <span class="s1">&#39;SNAPSHOT_MANAGER&#39;</span>
</span><span id="ClusterSet.__init__-112"><a href="#ClusterSet.__init__-112"><span class="linenos">112</span></a>
</span><span id="ClusterSet.__init__-113"><a href="#ClusterSet.__init__-113"><span class="linenos">113</span></a>        <span class="c1"># cluster_names can be a string &#39;aws-dev5&#39; or a list [&#39;aws-dev1&#39;, &#39;aws-dev2&#39;, etc...]</span>
</span><span id="ClusterSet.__init__-114"><a href="#ClusterSet.__init__-114"><span class="linenos">114</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span> <span class="o">=</span> <span class="n">cluster_names</span>
</span><span id="ClusterSet.__init__-115"><a href="#ClusterSet.__init__-115"><span class="linenos">115</span></a>
</span><span id="ClusterSet.__init__-116"><a href="#ClusterSet.__init__-116"><span class="linenos">116</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cluster_names</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
</span><span id="ClusterSet.__init__-117"><a href="#ClusterSet.__init__-117"><span class="linenos">117</span></a>            <span class="n">cluster_names</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">]</span>
</span><span id="ClusterSet.__init__-118"><a href="#ClusterSet.__init__-118"><span class="linenos">118</span></a>
</span><span id="ClusterSet.__init__-119"><a href="#ClusterSet.__init__-119"><span class="linenos">119</span></a>        <span class="c1"># Use this as a starting point to build filters that only return</span>
</span><span id="ClusterSet.__init__-120"><a href="#ClusterSet.__init__-120"><span class="linenos">120</span></a>        <span class="c1"># resources associated with this cluster. Use the &#39;get_cluster_filter&#39;</span>
</span><span id="ClusterSet.__init__-121"><a href="#ClusterSet.__init__-121"><span class="linenos">121</span></a>        <span class="c1"># method to get a copy of it rather than doing direct assignment.</span>
</span><span id="ClusterSet.__init__-122"><a href="#ClusterSet.__init__-122"><span class="linenos">122</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_filter</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ClusterSet.__init__-123"><a href="#ClusterSet.__init__-123"><span class="linenos">123</span></a>            <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:Cluster&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="n">cluster_names</span><span class="p">},</span>
</span><span id="ClusterSet.__init__-124"><a href="#ClusterSet.__init__-124"><span class="linenos">124</span></a>        <span class="p">]</span>
</span><span id="ClusterSet.__init__-125"><a href="#ClusterSet.__init__-125"><span class="linenos">125</span></a>
</span><span id="ClusterSet.__init__-126"><a href="#ClusterSet.__init__-126"><span class="linenos">126</span></a>        <span class="c1"># Set up logging</span>
</span><span id="ClusterSet.__init__-127"><a href="#ClusterSet.__init__-127"><span class="linenos">127</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;tagmania&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.__init__-128"><a href="#ClusterSet.__init__-128"><span class="linenos">128</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
</span><span id="ClusterSet.__init__-129"><a href="#ClusterSet.__init__-129"><span class="linenos">129</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logging initialized.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.__init__-130"><a href="#ClusterSet.__init__-130"><span class="linenos">130</span></a>
</span><span id="ClusterSet.__init__-131"><a href="#ClusterSet.__init__-131"><span class="linenos">131</span></a>        <span class="c1"># Create a boto3 session using the specified profile if provided.</span>
</span><span id="ClusterSet.__init__-132"><a href="#ClusterSet.__init__-132"><span class="linenos">132</span></a>        <span class="k">if</span> <span class="n">profile</span><span class="p">:</span>
</span><span id="ClusterSet.__init__-133"><a href="#ClusterSet.__init__-133"><span class="linenos">133</span></a>            <span class="n">aws_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">(</span><span class="n">profile_name</span><span class="o">=</span><span class="n">profile</span><span class="p">)</span>
</span><span id="ClusterSet.__init__-134"><a href="#ClusterSet.__init__-134"><span class="linenos">134</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using AWS profile: </span><span class="si">{</span><span class="n">profile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.__init__-135"><a href="#ClusterSet.__init__-135"><span class="linenos">135</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.__init__-136"><a href="#ClusterSet.__init__-136"><span class="linenos">136</span></a>            <span class="n">aws_session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span><span id="ClusterSet.__init__-137"><a href="#ClusterSet.__init__-137"><span class="linenos">137</span></a>
</span><span id="ClusterSet.__init__-138"><a href="#ClusterSet.__init__-138"><span class="linenos">138</span></a>        <span class="c1"># Create EC2 resource and client from the session.</span>
</span><span id="ClusterSet.__init__-139"><a href="#ClusterSet.__init__-139"><span class="linenos">139</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span> <span class="o">=</span> <span class="n">aws_session</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.__init__-140"><a href="#ClusterSet.__init__-140"><span class="linenos">140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span> <span class="o">=</span> <span class="n">aws_session</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;ec2&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize ClusterSet for managing one or more clusters.</p>

<p>Creates a new ClusterSet instance for managing EC2 instances and related
resources (volumes, snapshots) for the specified cluster(s). Sets up
AWS connectivity and initializes safety limits and automation tracking.</p>

<p>Args:
    cluster_names: The name of a cluster (str) or list of cluster names (list).
                 Must match the "Cluster" tag value on EC2 instances.
    profile: AWS profile name to use for authentication (optional).
            If None, uses default AWS credentials chain.</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Single cluster</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">ClusterSet</span><span class="p">(</span><span class="s1">&#39;production-web&#39;</span><span class="p">)</span>

<span class="c1"># Multiple clusters</span>
<span class="n">clusters</span> <span class="o">=</span> <span class="n">ClusterSet</span><span class="p">([</span><span class="s1">&#39;prod-web&#39;</span><span class="p">,</span> <span class="s1">&#39;prod-api&#39;</span><span class="p">])</span>

<span class="c1"># With specific AWS profile</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">ClusterSet</span><span class="p">(</span><span class="s1">&#39;staging&#39;</span><span class="p">,</span> <span class="n">profile</span><span class="o">=</span><span class="s1">&#39;dev-account&#39;</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>

<p>Note:
    The cluster names must exactly match the "Cluster" tag values
    on your EC2 instances for operations to work correctly.</p>
</div>


                            </div>
                            <div id="ClusterSet.AUTOMATION_KEY" class="classattr">
                                <div class="attr variable">
            <span class="name">AUTOMATION_KEY</span>

        
    </div>
    <a class="headerlink" href="#ClusterSet.AUTOMATION_KEY"></a>
    
    

                            </div>
                            <div id="ClusterSet.cluster_names" class="classattr">
                                <div class="attr variable">
            <span class="name">cluster_names</span>

        
    </div>
    <a class="headerlink" href="#ClusterSet.cluster_names"></a>
    
    

                            </div>
                            <div id="ClusterSet.get_cluster_filter" class="classattr">
                                        <input id="ClusterSet.get_cluster_filter-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_cluster_filter</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_cluster_filter-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_cluster_filter"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_cluster_filter-142"><a href="#ClusterSet.get_cluster_filter-142"><span class="linenos">142</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_cluster_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_cluster_filter-143"><a href="#ClusterSet.get_cluster_filter-143"><span class="linenos">143</span></a>        <span class="c1"># Return a copy to defend against modifications</span>
</span><span id="ClusterSet.get_cluster_filter-144"><a href="#ClusterSet.get_cluster_filter-144"><span class="linenos">144</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cluster_filter</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.get_instances" class="classattr">
                                        <input id="ClusterSet.get_instances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_instances</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_instances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_instances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_instances-146"><a href="#ClusterSet.get_instances-146"><span class="linenos">146</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_instances-147"><a href="#ClusterSet.get_instances-147"><span class="linenos">147</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all EC2 instances belonging to this cluster set.</span>
</span><span id="ClusterSet.get_instances-148"><a href="#ClusterSet.get_instances-148"><span class="linenos">148</span></a>
</span><span id="ClusterSet.get_instances-149"><a href="#ClusterSet.get_instances-149"><span class="linenos">149</span></a><span class="sd">        Retrieves all EC2 instances that have a &quot;Cluster&quot; tag matching any of the</span>
</span><span id="ClusterSet.get_instances-150"><a href="#ClusterSet.get_instances-150"><span class="linenos">150</span></a><span class="sd">        cluster names specified during initialization. The instances are filtered</span>
</span><span id="ClusterSet.get_instances-151"><a href="#ClusterSet.get_instances-151"><span class="linenos">151</span></a><span class="sd">        using the cluster filter and limited by the safety maximum (_MAX_ITEMS).</span>
</span><span id="ClusterSet.get_instances-152"><a href="#ClusterSet.get_instances-152"><span class="linenos">152</span></a>
</span><span id="ClusterSet.get_instances-153"><a href="#ClusterSet.get_instances-153"><span class="linenos">153</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_instances-154"><a href="#ClusterSet.get_instances-154"><span class="linenos">154</span></a><span class="sd">            list: List of EC2 instance objects from boto3. Each instance object</span>
</span><span id="ClusterSet.get_instances-155"><a href="#ClusterSet.get_instances-155"><span class="linenos">155</span></a><span class="sd">                 contains all AWS instance metadata including ID, state, tags, etc.</span>
</span><span id="ClusterSet.get_instances-156"><a href="#ClusterSet.get_instances-156"><span class="linenos">156</span></a>
</span><span id="ClusterSet.get_instances-157"><a href="#ClusterSet.get_instances-157"><span class="linenos">157</span></a><span class="sd">        Example:</span>
</span><span id="ClusterSet.get_instances-158"><a href="#ClusterSet.get_instances-158"><span class="linenos">158</span></a><span class="sd">            ```python</span>
</span><span id="ClusterSet.get_instances-159"><a href="#ClusterSet.get_instances-159"><span class="linenos">159</span></a><span class="sd">            cluster = ClusterSet(&#39;production-web&#39;)</span>
</span><span id="ClusterSet.get_instances-160"><a href="#ClusterSet.get_instances-160"><span class="linenos">160</span></a><span class="sd">            instances = cluster.get_instances()</span>
</span><span id="ClusterSet.get_instances-161"><a href="#ClusterSet.get_instances-161"><span class="linenos">161</span></a><span class="sd">            for instance in instances:</span>
</span><span id="ClusterSet.get_instances-162"><a href="#ClusterSet.get_instances-162"><span class="linenos">162</span></a><span class="sd">                print(f&quot;Instance {instance.id} is {instance.state[&#39;Name&#39;]}&quot;)</span>
</span><span id="ClusterSet.get_instances-163"><a href="#ClusterSet.get_instances-163"><span class="linenos">163</span></a><span class="sd">            ```</span>
</span><span id="ClusterSet.get_instances-164"><a href="#ClusterSet.get_instances-164"><span class="linenos">164</span></a>
</span><span id="ClusterSet.get_instances-165"><a href="#ClusterSet.get_instances-165"><span class="linenos">165</span></a><span class="sd">        Note:</span>
</span><span id="ClusterSet.get_instances-166"><a href="#ClusterSet.get_instances-166"><span class="linenos">166</span></a><span class="sd">            Returns a maximum of _MAX_ITEMS (150) instances for performance protection.</span>
</span><span id="ClusterSet.get_instances-167"><a href="#ClusterSet.get_instances-167"><span class="linenos">167</span></a><span class="sd">            If your cluster has more instances, increase this limit or use filtering.</span>
</span><span id="ClusterSet.get_instances-168"><a href="#ClusterSet.get_instances-168"><span class="linenos">168</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_instances-169"><a href="#ClusterSet.get_instances-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_instances-170"><a href="#ClusterSet.get_instances-170"><span class="linenos">170</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_instances-171"><a href="#ClusterSet.get_instances-171"><span class="linenos">171</span></a>        <span class="c1"># Exclude terminated instances</span>
</span><span id="ClusterSet.get_instances-172"><a href="#ClusterSet.get_instances-172"><span class="linenos">172</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet.get_instances-173"><a href="#ClusterSet.get_instances-173"><span class="linenos">173</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_instances-174"><a href="#ClusterSet.get_instances-174"><span class="linenos">174</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_instances-175"><a href="#ClusterSet.get_instances-175"><span class="linenos">175</span></a>            <span class="s1">&#39;shutting-down&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_instances-176"><a href="#ClusterSet.get_instances-176"><span class="linenos">176</span></a>            <span class="s1">&#39;stopped&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_instances-177"><a href="#ClusterSet.get_instances-177"><span class="linenos">177</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet.get_instances-178"><a href="#ClusterSet.get_instances-178"><span class="linenos">178</span></a>        <span class="p">])</span>
</span><span id="ClusterSet.get_instances-179"><a href="#ClusterSet.get_instances-179"><span class="linenos">179</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_instances-180"><a href="#ClusterSet.get_instances-180"><span class="linenos">180</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_instances-181"><a href="#ClusterSet.get_instances-181"><span class="linenos">181</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet.get_instances-182"><a href="#ClusterSet.get_instances-182"><span class="linenos">182</span></a>        <span class="k">return</span> <span class="n">instance_list</span>
</span></pre></div>


            <div class="docstring"><p>Get all EC2 instances belonging to this cluster set.</p>

<p>Retrieves all EC2 instances that have a "Cluster" tag matching any of the
cluster names specified during initialization. The instances are filtered
using the cluster filter and limited by the safety maximum (_MAX_ITEMS).</p>

<p>Returns:
    list: List of EC2 instance objects from boto3. Each instance object
         contains all AWS instance metadata including ID, state, tags, etc.</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">cluster</span> <span class="o">=</span> <span class="n">ClusterSet</span><span class="p">(</span><span class="s1">&#39;production-web&#39;</span><span class="p">)</span>
<span class="n">instances</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
<span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instance </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">instance</span><span class="o">.</span><span class="n">state</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>

<p>Note:
    Returns a maximum of _MAX_ITEMS (150) instances for performance protection.
    If your cluster has more instances, increase this limit or use filtering.</p>
</div>


                            </div>
                            <div id="ClusterSet.get_deployed_clusters" class="classattr">
                                        <input id="ClusterSet.get_deployed_clusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_deployed_clusters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_deployed_clusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_deployed_clusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_deployed_clusters-184"><a href="#ClusterSet.get_deployed_clusters-184"><span class="linenos">184</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_deployed_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_deployed_clusters-185"><a href="#ClusterSet.get_deployed_clusters-185"><span class="linenos">185</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_deployed_clusters-186"><a href="#ClusterSet.get_deployed_clusters-186"><span class="linenos">186</span></a><span class="sd">        Get a dictionary with all clusters already deployed.</span>
</span><span id="ClusterSet.get_deployed_clusters-187"><a href="#ClusterSet.get_deployed_clusters-187"><span class="linenos">187</span></a>
</span><span id="ClusterSet.get_deployed_clusters-188"><a href="#ClusterSet.get_deployed_clusters-188"><span class="linenos">188</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_deployed_clusters-189"><a href="#ClusterSet.get_deployed_clusters-189"><span class="linenos">189</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_deployed_clusters-190"><a href="#ClusterSet.get_deployed_clusters-190"><span class="linenos">190</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_deployed_clusters-191"><a href="#ClusterSet.get_deployed_clusters-191"><span class="linenos">191</span></a><span class="sd">            dictionary of clusters</span>
</span><span id="ClusterSet.get_deployed_clusters-192"><a href="#ClusterSet.get_deployed_clusters-192"><span class="linenos">192</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_deployed_clusters-193"><a href="#ClusterSet.get_deployed_clusters-193"><span class="linenos">193</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_deployed_clusters&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_clusters-194"><a href="#ClusterSet.get_deployed_clusters-194"><span class="linenos">194</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_deployed_clusters-195"><a href="#ClusterSet.get_deployed_clusters-195"><span class="linenos">195</span></a>        <span class="c1"># Exclude terminated instances</span>
</span><span id="ClusterSet.get_deployed_clusters-196"><a href="#ClusterSet.get_deployed_clusters-196"><span class="linenos">196</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet.get_deployed_clusters-197"><a href="#ClusterSet.get_deployed_clusters-197"><span class="linenos">197</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_clusters-198"><a href="#ClusterSet.get_deployed_clusters-198"><span class="linenos">198</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_clusters-199"><a href="#ClusterSet.get_deployed_clusters-199"><span class="linenos">199</span></a>            <span class="s1">&#39;shutting-down&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_clusters-200"><a href="#ClusterSet.get_deployed_clusters-200"><span class="linenos">200</span></a>            <span class="s1">&#39;stopped&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_clusters-201"><a href="#ClusterSet.get_deployed_clusters-201"><span class="linenos">201</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet.get_deployed_clusters-202"><a href="#ClusterSet.get_deployed_clusters-202"><span class="linenos">202</span></a>        <span class="p">])</span>
</span><span id="ClusterSet.get_deployed_clusters-203"><a href="#ClusterSet.get_deployed_clusters-203"><span class="linenos">203</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_deployed_clusters-204"><a href="#ClusterSet.get_deployed_clusters-204"><span class="linenos">204</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_clusters-205"><a href="#ClusterSet.get_deployed_clusters-205"><span class="linenos">205</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_clusters-206"><a href="#ClusterSet.get_deployed_clusters-206"><span class="linenos">206</span></a>        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">}</span>
</span><span id="ClusterSet.get_deployed_clusters-207"><a href="#ClusterSet.get_deployed_clusters-207"><span class="linenos">207</span></a>
</span><span id="ClusterSet.get_deployed_clusters-208"><a href="#ClusterSet.get_deployed_clusters-208"><span class="linenos">208</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet.get_deployed_clusters-209"><a href="#ClusterSet.get_deployed_clusters-209"><span class="linenos">209</span></a>            <span class="n">cluster_tag</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_clusters-210"><a href="#ClusterSet.get_deployed_clusters-210"><span class="linenos">210</span></a>            <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_clusters-211"><a href="#ClusterSet.get_deployed_clusters-211"><span class="linenos">211</span></a>
</span><span id="ClusterSet.get_deployed_clusters-212"><a href="#ClusterSet.get_deployed_clusters-212"><span class="linenos">212</span></a>        <span class="k">return</span> <span class="n">cluster_dict</span>
</span></pre></div>


            <div class="docstring"><p>Get a dictionary with all clusters already deployed.</p>

<p>Args:
    none
Returns:
    dictionary of clusters</p>
</div>


                            </div>
                            <div id="ClusterSet.get_deployed_cluster_names" class="classattr">
                                        <input id="ClusterSet.get_deployed_cluster_names-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_deployed_cluster_names</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_deployed_cluster_names-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_deployed_cluster_names"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_deployed_cluster_names-214"><a href="#ClusterSet.get_deployed_cluster_names-214"><span class="linenos">214</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_deployed_cluster_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_deployed_cluster_names-215"><a href="#ClusterSet.get_deployed_cluster_names-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_deployed_cluster_names-216"><a href="#ClusterSet.get_deployed_cluster_names-216"><span class="linenos">216</span></a><span class="sd">        Get a set of all supported environment cluster names already deployed.</span>
</span><span id="ClusterSet.get_deployed_cluster_names-217"><a href="#ClusterSet.get_deployed_cluster_names-217"><span class="linenos">217</span></a>
</span><span id="ClusterSet.get_deployed_cluster_names-218"><a href="#ClusterSet.get_deployed_cluster_names-218"><span class="linenos">218</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_deployed_cluster_names-219"><a href="#ClusterSet.get_deployed_cluster_names-219"><span class="linenos">219</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_deployed_cluster_names-220"><a href="#ClusterSet.get_deployed_cluster_names-220"><span class="linenos">220</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_deployed_cluster_names-221"><a href="#ClusterSet.get_deployed_cluster_names-221"><span class="linenos">221</span></a><span class="sd">            set of deployed cluster_names</span>
</span><span id="ClusterSet.get_deployed_cluster_names-222"><a href="#ClusterSet.get_deployed_cluster_names-222"><span class="linenos">222</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_deployed_cluster_names-223"><a href="#ClusterSet.get_deployed_cluster_names-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_deployed_cluster_names&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_cluster_names-224"><a href="#ClusterSet.get_deployed_cluster_names-224"><span class="linenos">224</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_deployed_cluster_names-225"><a href="#ClusterSet.get_deployed_cluster_names-225"><span class="linenos">225</span></a>        <span class="c1"># Exclude terminated instances</span>
</span><span id="ClusterSet.get_deployed_cluster_names-226"><a href="#ClusterSet.get_deployed_cluster_names-226"><span class="linenos">226</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet.get_deployed_cluster_names-227"><a href="#ClusterSet.get_deployed_cluster_names-227"><span class="linenos">227</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_cluster_names-228"><a href="#ClusterSet.get_deployed_cluster_names-228"><span class="linenos">228</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_cluster_names-229"><a href="#ClusterSet.get_deployed_cluster_names-229"><span class="linenos">229</span></a>            <span class="s1">&#39;shutting-down&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_cluster_names-230"><a href="#ClusterSet.get_deployed_cluster_names-230"><span class="linenos">230</span></a>            <span class="s1">&#39;stopped&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_deployed_cluster_names-231"><a href="#ClusterSet.get_deployed_cluster_names-231"><span class="linenos">231</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet.get_deployed_cluster_names-232"><a href="#ClusterSet.get_deployed_cluster_names-232"><span class="linenos">232</span></a>        <span class="p">])</span>
</span><span id="ClusterSet.get_deployed_cluster_names-233"><a href="#ClusterSet.get_deployed_cluster_names-233"><span class="linenos">233</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_deployed_cluster_names-234"><a href="#ClusterSet.get_deployed_cluster_names-234"><span class="linenos">234</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_cluster_names-235"><a href="#ClusterSet.get_deployed_cluster_names-235"><span class="linenos">235</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_cluster_names-236"><a href="#ClusterSet.get_deployed_cluster_names-236"><span class="linenos">236</span></a>        <span class="n">instance_cluster_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.get_deployed_cluster_names-237"><a href="#ClusterSet.get_deployed_cluster_names-237"><span class="linenos">237</span></a>
</span><span id="ClusterSet.get_deployed_cluster_names-238"><a href="#ClusterSet.get_deployed_cluster_names-238"><span class="linenos">238</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet.get_deployed_cluster_names-239"><a href="#ClusterSet.get_deployed_cluster_names-239"><span class="linenos">239</span></a>            <span class="n">cluster_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_cluster_names-240"><a href="#ClusterSet.get_deployed_cluster_names-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">cluster_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instance_cluster_names</span><span class="p">:</span>
</span><span id="ClusterSet.get_deployed_cluster_names-241"><a href="#ClusterSet.get_deployed_cluster_names-241"><span class="linenos">241</span></a>                <span class="n">instance_cluster_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cluster_name</span><span class="p">)</span>
</span><span id="ClusterSet.get_deployed_cluster_names-242"><a href="#ClusterSet.get_deployed_cluster_names-242"><span class="linenos">242</span></a>
</span><span id="ClusterSet.get_deployed_cluster_names-243"><a href="#ClusterSet.get_deployed_cluster_names-243"><span class="linenos">243</span></a>        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">instance_cluster_names</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get a set of all supported environment cluster names already deployed.</p>

<p>Args:
    none
Returns:
    set of deployed cluster_names</p>
</div>


                            </div>
                            <div id="ClusterSet.get_running_instances" class="classattr">
                                        <input id="ClusterSet.get_running_instances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_running_instances</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_running_instances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_running_instances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_running_instances-245"><a href="#ClusterSet.get_running_instances-245"><span class="linenos">245</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_running_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_running_instances-246"><a href="#ClusterSet.get_running_instances-246"><span class="linenos">246</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_running_instances-247"><a href="#ClusterSet.get_running_instances-247"><span class="linenos">247</span></a><span class="sd">        Get list of instances that are powered on. This includes instances in</span>
</span><span id="ClusterSet.get_running_instances-248"><a href="#ClusterSet.get_running_instances-248"><span class="linenos">248</span></a><span class="sd">        a pending, running, or stopping state.</span>
</span><span id="ClusterSet.get_running_instances-249"><a href="#ClusterSet.get_running_instances-249"><span class="linenos">249</span></a>
</span><span id="ClusterSet.get_running_instances-250"><a href="#ClusterSet.get_running_instances-250"><span class="linenos">250</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_running_instances-251"><a href="#ClusterSet.get_running_instances-251"><span class="linenos">251</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_running_instances-252"><a href="#ClusterSet.get_running_instances-252"><span class="linenos">252</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_running_instances-253"><a href="#ClusterSet.get_running_instances-253"><span class="linenos">253</span></a><span class="sd">            list of instances</span>
</span><span id="ClusterSet.get_running_instances-254"><a href="#ClusterSet.get_running_instances-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_running_instances-255"><a href="#ClusterSet.get_running_instances-255"><span class="linenos">255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_running_instances-256"><a href="#ClusterSet.get_running_instances-256"><span class="linenos">256</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_running_instances-257"><a href="#ClusterSet.get_running_instances-257"><span class="linenos">257</span></a>        <span class="c1"># Only want instances that are pending, running, or stopping</span>
</span><span id="ClusterSet.get_running_instances-258"><a href="#ClusterSet.get_running_instances-258"><span class="linenos">258</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet.get_running_instances-259"><a href="#ClusterSet.get_running_instances-259"><span class="linenos">259</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_running_instances-260"><a href="#ClusterSet.get_running_instances-260"><span class="linenos">260</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_running_instances-261"><a href="#ClusterSet.get_running_instances-261"><span class="linenos">261</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet.get_running_instances-262"><a href="#ClusterSet.get_running_instances-262"><span class="linenos">262</span></a>        <span class="p">])</span>
</span><span id="ClusterSet.get_running_instances-263"><a href="#ClusterSet.get_running_instances-263"><span class="linenos">263</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_running_instances-264"><a href="#ClusterSet.get_running_instances-264"><span class="linenos">264</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_running_instances-265"><a href="#ClusterSet.get_running_instances-265"><span class="linenos">265</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet.get_running_instances-266"><a href="#ClusterSet.get_running_instances-266"><span class="linenos">266</span></a>        <span class="k">return</span> <span class="n">instance_list</span>
</span></pre></div>


            <div class="docstring"><p>Get list of instances that are powered on. This includes instances in
a pending, running, or stopping state.</p>

<p>Args:
    none
Returns:
    list of instances</p>
</div>


                            </div>
                            <div id="ClusterSet.get_running_clusters" class="classattr">
                                        <input id="ClusterSet.get_running_clusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_running_clusters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_running_clusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_running_clusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_running_clusters-268"><a href="#ClusterSet.get_running_clusters-268"><span class="linenos">268</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_running_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_running_clusters-269"><a href="#ClusterSet.get_running_clusters-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_running_clusters-270"><a href="#ClusterSet.get_running_clusters-270"><span class="linenos">270</span></a><span class="sd">        Get a dictionary with all clusters that are powered on. This includes instances in</span>
</span><span id="ClusterSet.get_running_clusters-271"><a href="#ClusterSet.get_running_clusters-271"><span class="linenos">271</span></a><span class="sd">        a pending, running, or stopping state.</span>
</span><span id="ClusterSet.get_running_clusters-272"><a href="#ClusterSet.get_running_clusters-272"><span class="linenos">272</span></a>
</span><span id="ClusterSet.get_running_clusters-273"><a href="#ClusterSet.get_running_clusters-273"><span class="linenos">273</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_running_clusters-274"><a href="#ClusterSet.get_running_clusters-274"><span class="linenos">274</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_running_clusters-275"><a href="#ClusterSet.get_running_clusters-275"><span class="linenos">275</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_running_clusters-276"><a href="#ClusterSet.get_running_clusters-276"><span class="linenos">276</span></a><span class="sd">            dictionary of running clusters</span>
</span><span id="ClusterSet.get_running_clusters-277"><a href="#ClusterSet.get_running_clusters-277"><span class="linenos">277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_running_clusters-278"><a href="#ClusterSet.get_running_clusters-278"><span class="linenos">278</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_running_clusters&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_running_clusters-279"><a href="#ClusterSet.get_running_clusters-279"><span class="linenos">279</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_running_clusters-280"><a href="#ClusterSet.get_running_clusters-280"><span class="linenos">280</span></a>        <span class="c1"># Only want instances that are pending, running, or stopping</span>
</span><span id="ClusterSet.get_running_clusters-281"><a href="#ClusterSet.get_running_clusters-281"><span class="linenos">281</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet.get_running_clusters-282"><a href="#ClusterSet.get_running_clusters-282"><span class="linenos">282</span></a>            <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_running_clusters-283"><a href="#ClusterSet.get_running_clusters-283"><span class="linenos">283</span></a>            <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_running_clusters-284"><a href="#ClusterSet.get_running_clusters-284"><span class="linenos">284</span></a>            <span class="s1">&#39;stopping&#39;</span>
</span><span id="ClusterSet.get_running_clusters-285"><a href="#ClusterSet.get_running_clusters-285"><span class="linenos">285</span></a>        <span class="p">])</span>
</span><span id="ClusterSet.get_running_clusters-286"><a href="#ClusterSet.get_running_clusters-286"><span class="linenos">286</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_running_clusters-287"><a href="#ClusterSet.get_running_clusters-287"><span class="linenos">287</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_running_clusters-288"><a href="#ClusterSet.get_running_clusters-288"><span class="linenos">288</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet.get_running_clusters-289"><a href="#ClusterSet.get_running_clusters-289"><span class="linenos">289</span></a>        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">}</span>
</span><span id="ClusterSet.get_running_clusters-290"><a href="#ClusterSet.get_running_clusters-290"><span class="linenos">290</span></a>
</span><span id="ClusterSet.get_running_clusters-291"><a href="#ClusterSet.get_running_clusters-291"><span class="linenos">291</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet.get_running_clusters-292"><a href="#ClusterSet.get_running_clusters-292"><span class="linenos">292</span></a>            <span class="n">cluster_tag</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.get_running_clusters-293"><a href="#ClusterSet.get_running_clusters-293"><span class="linenos">293</span></a>            <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ClusterSet.get_running_clusters-294"><a href="#ClusterSet.get_running_clusters-294"><span class="linenos">294</span></a>
</span><span id="ClusterSet.get_running_clusters-295"><a href="#ClusterSet.get_running_clusters-295"><span class="linenos">295</span></a>        <span class="k">return</span> <span class="n">cluster_dict</span>
</span></pre></div>


            <div class="docstring"><p>Get a dictionary with all clusters that are powered on. This includes instances in
a pending, running, or stopping state.</p>

<p>Args:
    none
Returns:
    dictionary of running clusters</p>
</div>


                            </div>
                            <div id="ClusterSet.get_stopped_instances" class="classattr">
                                        <input id="ClusterSet.get_stopped_instances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_stopped_instances</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_stopped_instances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_stopped_instances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_stopped_instances-297"><a href="#ClusterSet.get_stopped_instances-297"><span class="linenos">297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stopped_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_stopped_instances-298"><a href="#ClusterSet.get_stopped_instances-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_stopped_instances-299"><a href="#ClusterSet.get_stopped_instances-299"><span class="linenos">299</span></a><span class="sd">        Get list of instances that are powered off.</span>
</span><span id="ClusterSet.get_stopped_instances-300"><a href="#ClusterSet.get_stopped_instances-300"><span class="linenos">300</span></a>
</span><span id="ClusterSet.get_stopped_instances-301"><a href="#ClusterSet.get_stopped_instances-301"><span class="linenos">301</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_stopped_instances-302"><a href="#ClusterSet.get_stopped_instances-302"><span class="linenos">302</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_stopped_instances-303"><a href="#ClusterSet.get_stopped_instances-303"><span class="linenos">303</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_stopped_instances-304"><a href="#ClusterSet.get_stopped_instances-304"><span class="linenos">304</span></a><span class="sd">            list of instances</span>
</span><span id="ClusterSet.get_stopped_instances-305"><a href="#ClusterSet.get_stopped_instances-305"><span class="linenos">305</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_stopped_instances-306"><a href="#ClusterSet.get_stopped_instances-306"><span class="linenos">306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_instances-307"><a href="#ClusterSet.get_stopped_instances-307"><span class="linenos">307</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_stopped_instances-308"><a href="#ClusterSet.get_stopped_instances-308"><span class="linenos">308</span></a>        <span class="c1"># Only want instances that are completely stopped</span>
</span><span id="ClusterSet.get_stopped_instances-309"><a href="#ClusterSet.get_stopped_instances-309"><span class="linenos">309</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_instances-310"><a href="#ClusterSet.get_stopped_instances-310"><span class="linenos">310</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_stopped_instances-311"><a href="#ClusterSet.get_stopped_instances-311"><span class="linenos">311</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_instances-312"><a href="#ClusterSet.get_stopped_instances-312"><span class="linenos">312</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet.get_stopped_instances-313"><a href="#ClusterSet.get_stopped_instances-313"><span class="linenos">313</span></a>        <span class="k">return</span> <span class="n">instance_list</span>
</span></pre></div>


            <div class="docstring"><p>Get list of instances that are powered off.</p>

<p>Args:
    none
Returns:
    list of instances</p>
</div>


                            </div>
                            <div id="ClusterSet.get_stopped_clusters" class="classattr">
                                        <input id="ClusterSet.get_stopped_clusters-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_stopped_clusters</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_stopped_clusters-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_stopped_clusters"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_stopped_clusters-315"><a href="#ClusterSet.get_stopped_clusters-315"><span class="linenos">315</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_stopped_clusters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_stopped_clusters-316"><a href="#ClusterSet.get_stopped_clusters-316"><span class="linenos">316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_stopped_clusters-317"><a href="#ClusterSet.get_stopped_clusters-317"><span class="linenos">317</span></a><span class="sd">        Get a dictionary with all clusters that are powered off.</span>
</span><span id="ClusterSet.get_stopped_clusters-318"><a href="#ClusterSet.get_stopped_clusters-318"><span class="linenos">318</span></a>
</span><span id="ClusterSet.get_stopped_clusters-319"><a href="#ClusterSet.get_stopped_clusters-319"><span class="linenos">319</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_stopped_clusters-320"><a href="#ClusterSet.get_stopped_clusters-320"><span class="linenos">320</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_stopped_clusters-321"><a href="#ClusterSet.get_stopped_clusters-321"><span class="linenos">321</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_stopped_clusters-322"><a href="#ClusterSet.get_stopped_clusters-322"><span class="linenos">322</span></a><span class="sd">            dictionary of stopped clusters</span>
</span><span id="ClusterSet.get_stopped_clusters-323"><a href="#ClusterSet.get_stopped_clusters-323"><span class="linenos">323</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_stopped_clusters-324"><a href="#ClusterSet.get_stopped_clusters-324"><span class="linenos">324</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_stopped_clusters&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_clusters-325"><a href="#ClusterSet.get_stopped_clusters-325"><span class="linenos">325</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_stopped_clusters-326"><a href="#ClusterSet.get_stopped_clusters-326"><span class="linenos">326</span></a>        <span class="c1"># Only want instances that are completely stopped</span>
</span><span id="ClusterSet.get_stopped_clusters-327"><a href="#ClusterSet.get_stopped_clusters-327"><span class="linenos">327</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_clusters-328"><a href="#ClusterSet.get_stopped_clusters-328"><span class="linenos">328</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_stopped_clusters-329"><a href="#ClusterSet.get_stopped_clusters-329"><span class="linenos">329</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_clusters-330"><a href="#ClusterSet.get_stopped_clusters-330"><span class="linenos">330</span></a>        <span class="n">instance_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_clusters-331"><a href="#ClusterSet.get_stopped_clusters-331"><span class="linenos">331</span></a>        <span class="n">cluster_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">}</span>
</span><span id="ClusterSet.get_stopped_clusters-332"><a href="#ClusterSet.get_stopped_clusters-332"><span class="linenos">332</span></a>
</span><span id="ClusterSet.get_stopped_clusters-333"><a href="#ClusterSet.get_stopped_clusters-333"><span class="linenos">333</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instance_list</span><span class="p">:</span>
</span><span id="ClusterSet.get_stopped_clusters-334"><a href="#ClusterSet.get_stopped_clusters-334"><span class="linenos">334</span></a>            <span class="n">cluster_tag</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_clusters-335"><a href="#ClusterSet.get_stopped_clusters-335"><span class="linenos">335</span></a>            <span class="n">cluster_dict</span><span class="p">[</span><span class="n">cluster_tag</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ClusterSet.get_stopped_clusters-336"><a href="#ClusterSet.get_stopped_clusters-336"><span class="linenos">336</span></a>
</span><span id="ClusterSet.get_stopped_clusters-337"><a href="#ClusterSet.get_stopped_clusters-337"><span class="linenos">337</span></a>        <span class="k">return</span> <span class="n">cluster_dict</span>
</span></pre></div>


            <div class="docstring"><p>Get a dictionary with all clusters that are powered off.</p>

<p>Args:
    none
Returns:
    dictionary of stopped clusters</p>
</div>


                            </div>
                            <div id="ClusterSet.start_instances" class="classattr">
                                        <input id="ClusterSet.start_instances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">start_instances</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.start_instances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.start_instances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.start_instances-339"><a href="#ClusterSet.start_instances-339"><span class="linenos">339</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.start_instances-340"><a href="#ClusterSet.start_instances-340"><span class="linenos">340</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start all stopped EC2 instances in this cluster.</span>
</span><span id="ClusterSet.start_instances-341"><a href="#ClusterSet.start_instances-341"><span class="linenos">341</span></a>
</span><span id="ClusterSet.start_instances-342"><a href="#ClusterSet.start_instances-342"><span class="linenos">342</span></a><span class="sd">        Identifies all instances in the cluster that are currently in &#39;stopped&#39; state</span>
</span><span id="ClusterSet.start_instances-343"><a href="#ClusterSet.start_instances-343"><span class="linenos">343</span></a><span class="sd">        and starts them. Running instances are not affected. The operation processes</span>
</span><span id="ClusterSet.start_instances-344"><a href="#ClusterSet.start_instances-344"><span class="linenos">344</span></a><span class="sd">        instances in batches and provides feedback on progress.</span>
</span><span id="ClusterSet.start_instances-345"><a href="#ClusterSet.start_instances-345"><span class="linenos">345</span></a>
</span><span id="ClusterSet.start_instances-346"><a href="#ClusterSet.start_instances-346"><span class="linenos">346</span></a><span class="sd">        Example:</span>
</span><span id="ClusterSet.start_instances-347"><a href="#ClusterSet.start_instances-347"><span class="linenos">347</span></a><span class="sd">            ```python</span>
</span><span id="ClusterSet.start_instances-348"><a href="#ClusterSet.start_instances-348"><span class="linenos">348</span></a><span class="sd">            cluster = ClusterSet(&#39;production-web&#39;)</span>
</span><span id="ClusterSet.start_instances-349"><a href="#ClusterSet.start_instances-349"><span class="linenos">349</span></a><span class="sd">            cluster.start_instances()  # Starts all stopped instances</span>
</span><span id="ClusterSet.start_instances-350"><a href="#ClusterSet.start_instances-350"><span class="linenos">350</span></a><span class="sd">            ```</span>
</span><span id="ClusterSet.start_instances-351"><a href="#ClusterSet.start_instances-351"><span class="linenos">351</span></a>
</span><span id="ClusterSet.start_instances-352"><a href="#ClusterSet.start_instances-352"><span class="linenos">352</span></a><span class="sd">        Note:</span>
</span><span id="ClusterSet.start_instances-353"><a href="#ClusterSet.start_instances-353"><span class="linenos">353</span></a><span class="sd">            Only instances in &#39;stopped&#39; state will be started. Instances in other</span>
</span><span id="ClusterSet.start_instances-354"><a href="#ClusterSet.start_instances-354"><span class="linenos">354</span></a><span class="sd">            states (running, stopping, etc.) are ignored. The operation may take</span>
</span><span id="ClusterSet.start_instances-355"><a href="#ClusterSet.start_instances-355"><span class="linenos">355</span></a><span class="sd">            several minutes for large clusters.</span>
</span><span id="ClusterSet.start_instances-356"><a href="#ClusterSet.start_instances-356"><span class="linenos">356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.start_instances-357"><a href="#ClusterSet.start_instances-357"><span class="linenos">357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: start_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances-358"><a href="#ClusterSet.start_instances-358"><span class="linenos">358</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stopped_instances</span><span class="p">()</span>
</span><span id="ClusterSet.start_instances-359"><a href="#ClusterSet.start_instances-359"><span class="linenos">359</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances-360"><a href="#ClusterSet.start_instances-360"><span class="linenos">360</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No instances to start.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances-361"><a href="#ClusterSet.start_instances-361"><span class="linenos">361</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances-362"><a href="#ClusterSet.start_instances-362"><span class="linenos">362</span></a>            <span class="c1"># Start instances</span>
</span><span id="ClusterSet.start_instances-363"><a href="#ClusterSet.start_instances-363"><span class="linenos">363</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances-364"><a href="#ClusterSet.start_instances-364"><span class="linenos">364</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances-365"><a href="#ClusterSet.start_instances-365"><span class="linenos">365</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances-366"><a href="#ClusterSet.start_instances-366"><span class="linenos">366</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="ClusterSet.start_instances-367"><a href="#ClusterSet.start_instances-367"><span class="linenos">367</span></a>            <span class="c1"># Wait for instances to start. Call in separate loop because we want</span>
</span><span id="ClusterSet.start_instances-368"><a href="#ClusterSet.start_instances-368"><span class="linenos">368</span></a>            <span class="c1"># to issue the start commands asynchronously rather than waiting for</span>
</span><span id="ClusterSet.start_instances-369"><a href="#ClusterSet.start_instances-369"><span class="linenos">369</span></a>            <span class="c1"># each instance to start before issuing the next one.</span>
</span><span id="ClusterSet.start_instances-370"><a href="#ClusterSet.start_instances-370"><span class="linenos">370</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to start...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances-371"><a href="#ClusterSet.start_instances-371"><span class="linenos">371</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances-372"><a href="#ClusterSet.start_instances-372"><span class="linenos">372</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_running</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Start all stopped EC2 instances in this cluster.</p>

<p>Identifies all instances in the cluster that are currently in 'stopped' state
and starts them. Running instances are not affected. The operation processes
instances in batches and provides feedback on progress.</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">cluster</span> <span class="o">=</span> <span class="n">ClusterSet</span><span class="p">(</span><span class="s1">&#39;production-web&#39;</span><span class="p">)</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">start_instances</span><span class="p">()</span>  <span class="c1"># Starts all stopped instances</span>
</code></pre>
</div>
</code></pre>

<p>Note:
    Only instances in 'stopped' state will be started. Instances in other
    states (running, stopping, etc.) are ignored. The operation may take
    several minutes for large clusters.</p>
</div>


                            </div>
                            <div id="ClusterSet.stop_instances" class="classattr">
                                        <input id="ClusterSet.stop_instances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop_instances</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.stop_instances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.stop_instances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.stop_instances-374"><a href="#ClusterSet.stop_instances-374"><span class="linenos">374</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.stop_instances-375"><a href="#ClusterSet.stop_instances-375"><span class="linenos">375</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.stop_instances-376"><a href="#ClusterSet.stop_instances-376"><span class="linenos">376</span></a><span class="sd">        Stop instances associated with this cluster.</span>
</span><span id="ClusterSet.stop_instances-377"><a href="#ClusterSet.stop_instances-377"><span class="linenos">377</span></a>
</span><span id="ClusterSet.stop_instances-378"><a href="#ClusterSet.stop_instances-378"><span class="linenos">378</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.stop_instances-379"><a href="#ClusterSet.stop_instances-379"><span class="linenos">379</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.stop_instances-380"><a href="#ClusterSet.stop_instances-380"><span class="linenos">380</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.stop_instances-381"><a href="#ClusterSet.stop_instances-381"><span class="linenos">381</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.stop_instances-382"><a href="#ClusterSet.stop_instances-382"><span class="linenos">382</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.stop_instances-383"><a href="#ClusterSet.stop_instances-383"><span class="linenos">383</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: stop_instances&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances-384"><a href="#ClusterSet.stop_instances-384"><span class="linenos">384</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_running_instances</span><span class="p">()</span>
</span><span id="ClusterSet.stop_instances-385"><a href="#ClusterSet.stop_instances-385"><span class="linenos">385</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances-386"><a href="#ClusterSet.stop_instances-386"><span class="linenos">386</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No instances to stop.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances-387"><a href="#ClusterSet.stop_instances-387"><span class="linenos">387</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances-388"><a href="#ClusterSet.stop_instances-388"><span class="linenos">388</span></a>            <span class="c1"># Stop instances</span>
</span><span id="ClusterSet.stop_instances-389"><a href="#ClusterSet.stop_instances-389"><span class="linenos">389</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances-390"><a href="#ClusterSet.stop_instances-390"><span class="linenos">390</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances-391"><a href="#ClusterSet.stop_instances-391"><span class="linenos">391</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances-392"><a href="#ClusterSet.stop_instances-392"><span class="linenos">392</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="ClusterSet.stop_instances-393"><a href="#ClusterSet.stop_instances-393"><span class="linenos">393</span></a>            <span class="c1"># Wait for instances to stop. Call in separate loop because we want</span>
</span><span id="ClusterSet.stop_instances-394"><a href="#ClusterSet.stop_instances-394"><span class="linenos">394</span></a>            <span class="c1"># to issue the stop commands asynchronously rather than waiting for</span>
</span><span id="ClusterSet.stop_instances-395"><a href="#ClusterSet.stop_instances-395"><span class="linenos">395</span></a>            <span class="c1"># each instance to stop before issuing the next one.</span>
</span><span id="ClusterSet.stop_instances-396"><a href="#ClusterSet.stop_instances-396"><span class="linenos">396</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to stop...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances-397"><a href="#ClusterSet.stop_instances-397"><span class="linenos">397</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances-398"><a href="#ClusterSet.stop_instances-398"><span class="linenos">398</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_stopped</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Stop instances associated with this cluster.</p>

<p>Args:
    none
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.tag_instances" class="classattr">
                                        <input id="ClusterSet.tag_instances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tag_instances</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.tag_instances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.tag_instances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.tag_instances-400"><a href="#ClusterSet.tag_instances-400"><span class="linenos">400</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.tag_instances-401"><a href="#ClusterSet.tag_instances-401"><span class="linenos">401</span></a>        <span class="c1"># The resource API is somewhat less efficient than the low-level client</span>
</span><span id="ClusterSet.tag_instances-402"><a href="#ClusterSet.tag_instances-402"><span class="linenos">402</span></a>        <span class="c1"># API because it does one request per tag operation. For reasonably</span>
</span><span id="ClusterSet.tag_instances-403"><a href="#ClusterSet.tag_instances-403"><span class="linenos">403</span></a>        <span class="c1"># sized collections this should be ok.</span>
</span><span id="ClusterSet.tag_instances-404"><a href="#ClusterSet.tag_instances-404"><span class="linenos">404</span></a>        <span class="c1"># tags = {&#39;key&#39;: &#39;values&#39;}</span>
</span><span id="ClusterSet.tag_instances-405"><a href="#ClusterSet.tag_instances-405"><span class="linenos">405</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet.tag_instances-406"><a href="#ClusterSet.tag_instances-406"><span class="linenos">406</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.tag_instances-407"><a href="#ClusterSet.tag_instances-407"><span class="linenos">407</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging instance </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.tag_instances-408"><a href="#ClusterSet.tag_instances-408"><span class="linenos">408</span></a>            <span class="n">i</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.untag_instances" class="classattr">
                                        <input id="ClusterSet.untag_instances-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">untag_instances</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.untag_instances-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.untag_instances"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.untag_instances-410"><a href="#ClusterSet.untag_instances-410"><span class="linenos">410</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.untag_instances-411"><a href="#ClusterSet.untag_instances-411"><span class="linenos">411</span></a>        <span class="c1"># Might as well un-tag on one big batch since instance objects don&#39;t</span>
</span><span id="ClusterSet.untag_instances-412"><a href="#ClusterSet.untag_instances-412"><span class="linenos">412</span></a>        <span class="c1"># have direct support for un-tagging.</span>
</span><span id="ClusterSet.untag_instances-413"><a href="#ClusterSet.untag_instances-413"><span class="linenos">413</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet.untag_instances-414"><a href="#ClusterSet.untag_instances-414"><span class="linenos">414</span></a>        <span class="n">instance_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.untag_instances-415"><a href="#ClusterSet.untag_instances-415"><span class="linenos">415</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.untag_instances-416"><a href="#ClusterSet.untag_instances-416"><span class="linenos">416</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging instance </span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.untag_instances-417"><a href="#ClusterSet.untag_instances-417"><span class="linenos">417</span></a>            <span class="n">instance_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.untag_instances-418"><a href="#ClusterSet.untag_instances-418"><span class="linenos">418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="n">instance_ids</span><span class="p">,</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.get_volumes" class="classattr">
                                        <input id="ClusterSet.get_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_volumes-420"><a href="#ClusterSet.get_volumes-420"><span class="linenos">420</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_volumes-421"><a href="#ClusterSet.get_volumes-421"><span class="linenos">421</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_volumes-422"><a href="#ClusterSet.get_volumes-422"><span class="linenos">422</span></a><span class="sd">        Get list of volumes associated with this cluster.</span>
</span><span id="ClusterSet.get_volumes-423"><a href="#ClusterSet.get_volumes-423"><span class="linenos">423</span></a>
</span><span id="ClusterSet.get_volumes-424"><a href="#ClusterSet.get_volumes-424"><span class="linenos">424</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_volumes-425"><a href="#ClusterSet.get_volumes-425"><span class="linenos">425</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_volumes-426"><a href="#ClusterSet.get_volumes-426"><span class="linenos">426</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_volumes-427"><a href="#ClusterSet.get_volumes-427"><span class="linenos">427</span></a><span class="sd">            list of volumes</span>
</span><span id="ClusterSet.get_volumes-428"><a href="#ClusterSet.get_volumes-428"><span class="linenos">428</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_volumes-429"><a href="#ClusterSet.get_volumes-429"><span class="linenos">429</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_volumes-430"><a href="#ClusterSet.get_volumes-430"><span class="linenos">430</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_volumes-431"><a href="#ClusterSet.get_volumes-431"><span class="linenos">431</span></a>        <span class="c1"># The tool deliberately only works with volumes that have the tag</span>
</span><span id="ClusterSet.get_volumes-432"><a href="#ClusterSet.get_volumes-432"><span class="linenos">432</span></a>        <span class="c1"># &#39;automation_key&#39; set. It will ignore all other volumes so that it</span>
</span><span id="ClusterSet.get_volumes-433"><a href="#ClusterSet.get_volumes-433"><span class="linenos">433</span></a>        <span class="c1"># doesn&#39;t clobber volumes that it is not responsible for. It may be that</span>
</span><span id="ClusterSet.get_volumes-434"><a href="#ClusterSet.get_volumes-434"><span class="linenos">434</span></a>        <span class="c1"># we only need to worry about volumes created by snapshot manager</span>
</span><span id="ClusterSet.get_volumes-435"><a href="#ClusterSet.get_volumes-435"><span class="linenos">435</span></a>        <span class="c1"># because volumes created by the provisioner won&#39;t ever have a label,</span>
</span><span id="ClusterSet.get_volumes-436"><a href="#ClusterSet.get_volumes-436"><span class="linenos">436</span></a>        <span class="c1"># so when looking for restored volumes, we can just look for managed</span>
</span><span id="ClusterSet.get_volumes-437"><a href="#ClusterSet.get_volumes-437"><span class="linenos">437</span></a>        <span class="c1"># volumes that have a label.</span>
</span><span id="ClusterSet.get_volumes-438"><a href="#ClusterSet.get_volumes-438"><span class="linenos">438</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:automation_key&#39;</span><span class="p">,</span> <span class="p">[</span>
</span><span id="ClusterSet.get_volumes-439"><a href="#ClusterSet.get_volumes-439"><span class="linenos">439</span></a>            <span class="s1">&#39;PROVISIONER&#39;</span><span class="p">,</span>
</span><span id="ClusterSet.get_volumes-440"><a href="#ClusterSet.get_volumes-440"><span class="linenos">440</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span>
</span><span id="ClusterSet.get_volumes-441"><a href="#ClusterSet.get_volumes-441"><span class="linenos">441</span></a>        <span class="p">])</span>
</span><span id="ClusterSet.get_volumes-442"><a href="#ClusterSet.get_volumes-442"><span class="linenos">442</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_volumes-443"><a href="#ClusterSet.get_volumes-443"><span class="linenos">443</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_volumes-444"><a href="#ClusterSet.get_volumes-444"><span class="linenos">444</span></a>        <span class="n">volume_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">volumes</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet.get_volumes-445"><a href="#ClusterSet.get_volumes-445"><span class="linenos">445</span></a>        <span class="k">return</span> <span class="n">volume_list</span>
</span></pre></div>


            <div class="docstring"><p>Get list of volumes associated with this cluster.</p>

<p>Args:
    none
Returns:
    list of volumes</p>
</div>


                            </div>
                            <div id="ClusterSet.get_kubernetes_volumes" class="classattr">
                                        <input id="ClusterSet.get_kubernetes_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_kubernetes_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_kubernetes_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_kubernetes_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_kubernetes_volumes-447"><a href="#ClusterSet.get_kubernetes_volumes-447"><span class="linenos">447</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_kubernetes_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_kubernetes_volumes-448"><a href="#ClusterSet.get_kubernetes_volumes-448"><span class="linenos">448</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_kubernetes_volumes-449"><a href="#ClusterSet.get_kubernetes_volumes-449"><span class="linenos">449</span></a><span class="sd">        Get list of kubernetes volumes associated with this cluster.</span>
</span><span id="ClusterSet.get_kubernetes_volumes-450"><a href="#ClusterSet.get_kubernetes_volumes-450"><span class="linenos">450</span></a>
</span><span id="ClusterSet.get_kubernetes_volumes-451"><a href="#ClusterSet.get_kubernetes_volumes-451"><span class="linenos">451</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_kubernetes_volumes-452"><a href="#ClusterSet.get_kubernetes_volumes-452"><span class="linenos">452</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_kubernetes_volumes-453"><a href="#ClusterSet.get_kubernetes_volumes-453"><span class="linenos">453</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_kubernetes_volumes-454"><a href="#ClusterSet.get_kubernetes_volumes-454"><span class="linenos">454</span></a><span class="sd">            list of kubernetes volumes</span>
</span><span id="ClusterSet.get_kubernetes_volumes-455"><a href="#ClusterSet.get_kubernetes_volumes-455"><span class="linenos">455</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_kubernetes_volumes-456"><a href="#ClusterSet.get_kubernetes_volumes-456"><span class="linenos">456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_kubernetes_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_kubernetes_volumes-457"><a href="#ClusterSet.get_kubernetes_volumes-457"><span class="linenos">457</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">([</span>
</span><span id="ClusterSet.get_kubernetes_volumes-458"><a href="#ClusterSet.get_kubernetes_volumes-458"><span class="linenos">458</span></a>            <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:KubernetesCluster&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">]},</span>
</span><span id="ClusterSet.get_kubernetes_volumes-459"><a href="#ClusterSet.get_kubernetes_volumes-459"><span class="linenos">459</span></a>            <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="s1">&#39;tag:kubernetes.io/created-for/pvc/namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;openshift-logging&#39;</span><span class="p">]}</span>
</span><span id="ClusterSet.get_kubernetes_volumes-460"><a href="#ClusterSet.get_kubernetes_volumes-460"><span class="linenos">460</span></a>        <span class="p">])</span>
</span><span id="ClusterSet.get_kubernetes_volumes-461"><a href="#ClusterSet.get_kubernetes_volumes-461"><span class="linenos">461</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_kubernetes_volumes-462"><a href="#ClusterSet.get_kubernetes_volumes-462"><span class="linenos">462</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_kubernetes_volumes-463"><a href="#ClusterSet.get_kubernetes_volumes-463"><span class="linenos">463</span></a>        <span class="n">volume_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span>
</span><span id="ClusterSet.get_kubernetes_volumes-464"><a href="#ClusterSet.get_kubernetes_volumes-464"><span class="linenos">464</span></a>        <span class="k">return</span> <span class="n">volume_list</span>
</span></pre></div>


            <div class="docstring"><p>Get list of kubernetes volumes associated with this cluster.</p>

<p>Args:
    none
Returns:
    list of kubernetes volumes</p>
</div>


                            </div>
                            <div id="ClusterSet.get_restored_volumes" class="classattr">
                                        <input id="ClusterSet.get_restored_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_restored_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_restored_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_restored_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_restored_volumes-466"><a href="#ClusterSet.get_restored_volumes-466"><span class="linenos">466</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_restored_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ClusterSet.get_restored_volumes-467"><a href="#ClusterSet.get_restored_volumes-467"><span class="linenos">467</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_restored_volumes-468"><a href="#ClusterSet.get_restored_volumes-468"><span class="linenos">468</span></a><span class="sd">        Get list of volumes that were previously created from snapshots.</span>
</span><span id="ClusterSet.get_restored_volumes-469"><a href="#ClusterSet.get_restored_volumes-469"><span class="linenos">469</span></a>
</span><span id="ClusterSet.get_restored_volumes-470"><a href="#ClusterSet.get_restored_volumes-470"><span class="linenos">470</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_restored_volumes-471"><a href="#ClusterSet.get_restored_volumes-471"><span class="linenos">471</span></a><span class="sd">            - label: label of volumes being sought (optional)</span>
</span><span id="ClusterSet.get_restored_volumes-472"><a href="#ClusterSet.get_restored_volumes-472"><span class="linenos">472</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_restored_volumes-473"><a href="#ClusterSet.get_restored_volumes-473"><span class="linenos">473</span></a><span class="sd">            list of snapshots</span>
</span><span id="ClusterSet.get_restored_volumes-474"><a href="#ClusterSet.get_restored_volumes-474"><span class="linenos">474</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_restored_volumes-475"><a href="#ClusterSet.get_restored_volumes-475"><span class="linenos">475</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_restored_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_restored_volumes-476"><a href="#ClusterSet.get_restored_volumes-476"><span class="linenos">476</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_restored_volumes-477"><a href="#ClusterSet.get_restored_volumes-477"><span class="linenos">477</span></a>        <span class="c1"># These volumes can be in available state (if just created) or in-use state (if attached)</span>
</span><span id="ClusterSet.get_restored_volumes-478"><a href="#ClusterSet.get_restored_volumes-478"><span class="linenos">478</span></a>        <span class="c1"># We need to check for both states to properly detect restored volumes</span>
</span><span id="ClusterSet.get_restored_volumes-479"><a href="#ClusterSet.get_restored_volumes-479"><span class="linenos">479</span></a>        <span class="c1"># | Note: The &#39;status&#39; filter corresponds to the &#39;state&#39; attribute in</span>
</span><span id="ClusterSet.get_restored_volumes-480"><a href="#ClusterSet.get_restored_volumes-480"><span class="linenos">480</span></a>        <span class="c1"># | the AWS management console. Not sure about the reason behind that.</span>
</span><span id="ClusterSet.get_restored_volumes-481"><a href="#ClusterSet.get_restored_volumes-481"><span class="linenos">481</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet.get_restored_volumes-482"><a href="#ClusterSet.get_restored_volumes-482"><span class="linenos">482</span></a>        <span class="c1"># Optionally, get volumes with the given label</span>
</span><span id="ClusterSet.get_restored_volumes-483"><a href="#ClusterSet.get_restored_volumes-483"><span class="linenos">483</span></a>        <span class="c1"># This might not really be needed because the way the snapshot manager</span>
</span><span id="ClusterSet.get_restored_volumes-484"><a href="#ClusterSet.get_restored_volumes-484"><span class="linenos">484</span></a>        <span class="c1"># works is that it deletes all managed volumes before creating new ones</span>
</span><span id="ClusterSet.get_restored_volumes-485"><a href="#ClusterSet.get_restored_volumes-485"><span class="linenos">485</span></a>        <span class="c1"># from snapshots. Therefore at any given time, there should only be one</span>
</span><span id="ClusterSet.get_restored_volumes-486"><a href="#ClusterSet.get_restored_volumes-486"><span class="linenos">486</span></a>        <span class="c1"># set of available volumes.</span>
</span><span id="ClusterSet.get_restored_volumes-487"><a href="#ClusterSet.get_restored_volumes-487"><span class="linenos">487</span></a>        <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ClusterSet.get_restored_volumes-488"><a href="#ClusterSet.get_restored_volumes-488"><span class="linenos">488</span></a>            <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.get_restored_volumes-489"><a href="#ClusterSet.get_restored_volumes-489"><span class="linenos">489</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_restored_volumes-490"><a href="#ClusterSet.get_restored_volumes-490"><span class="linenos">490</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_restored_volumes-491"><a href="#ClusterSet.get_restored_volumes-491"><span class="linenos">491</span></a>        <span class="n">volume_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">volumes</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet.get_restored_volumes-492"><a href="#ClusterSet.get_restored_volumes-492"><span class="linenos">492</span></a>        <span class="k">return</span> <span class="n">volume_list</span>
</span></pre></div>


            <div class="docstring"><p>Get list of volumes that were previously created from snapshots.</p>

<p>Args:
    - label: label of volumes being sought (optional)
Returns:
    list of snapshots</p>
</div>


                            </div>
                            <div id="ClusterSet.attach_volumes" class="classattr">
                                        <input id="ClusterSet.attach_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">attach_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.attach_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.attach_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.attach_volumes-494"><a href="#ClusterSet.attach_volumes-494"><span class="linenos">494</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">attach_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet.attach_volumes-495"><a href="#ClusterSet.attach_volumes-495"><span class="linenos">495</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.attach_volumes-496"><a href="#ClusterSet.attach_volumes-496"><span class="linenos">496</span></a><span class="sd">        Attach volumes to associated instances.</span>
</span><span id="ClusterSet.attach_volumes-497"><a href="#ClusterSet.attach_volumes-497"><span class="linenos">497</span></a>
</span><span id="ClusterSet.attach_volumes-498"><a href="#ClusterSet.attach_volumes-498"><span class="linenos">498</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.attach_volumes-499"><a href="#ClusterSet.attach_volumes-499"><span class="linenos">499</span></a><span class="sd">            - label: label of volume to attach</span>
</span><span id="ClusterSet.attach_volumes-500"><a href="#ClusterSet.attach_volumes-500"><span class="linenos">500</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.attach_volumes-501"><a href="#ClusterSet.attach_volumes-501"><span class="linenos">501</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.attach_volumes-502"><a href="#ClusterSet.attach_volumes-502"><span class="linenos">502</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.attach_volumes-503"><a href="#ClusterSet.attach_volumes-503"><span class="linenos">503</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: attach_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-504"><a href="#ClusterSet.attach_volumes-504"><span class="linenos">504</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet.attach_volumes-505"><a href="#ClusterSet.attach_volumes-505"><span class="linenos">505</span></a>        <span class="c1"># We should be able to work with get_volumes, but this just protects</span>
</span><span id="ClusterSet.attach_volumes-506"><a href="#ClusterSet.attach_volumes-506"><span class="linenos">506</span></a>        <span class="c1"># against the case when users are manually creating volumes. It filters</span>
</span><span id="ClusterSet.attach_volumes-507"><a href="#ClusterSet.attach_volumes-507"><span class="linenos">507</span></a>        <span class="c1"># out any volumes that were not created by the snapshot manager.</span>
</span><span id="ClusterSet.attach_volumes-508"><a href="#ClusterSet.attach_volumes-508"><span class="linenos">508</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restored_volumes</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-509"><a href="#ClusterSet.attach_volumes-509"><span class="linenos">509</span></a>        <span class="c1"># This is for debugging purposes. Sometimes the algorithm below doesn&#39;t</span>
</span><span id="ClusterSet.attach_volumes-510"><a href="#ClusterSet.attach_volumes-510"><span class="linenos">510</span></a>        <span class="c1"># find all volumes.</span>
</span><span id="ClusterSet.attach_volumes-511"><a href="#ClusterSet.attach_volumes-511"><span class="linenos">511</span></a>        <span class="c1"># volume_list = list(volumes)</span>
</span><span id="ClusterSet.attach_volumes-512"><a href="#ClusterSet.attach_volumes-512"><span class="linenos">512</span></a>        <span class="c1"># print(f&quot;Found {len(volume_list)} volumes to attach.&quot;)</span>
</span><span id="ClusterSet.attach_volumes-513"><a href="#ClusterSet.attach_volumes-513"><span class="linenos">513</span></a>
</span><span id="ClusterSet.attach_volumes-514"><a href="#ClusterSet.attach_volumes-514"><span class="linenos">514</span></a>        <span class="c1"># For each instance, find all associated volumes and attach them. The</span>
</span><span id="ClusterSet.attach_volumes-515"><a href="#ClusterSet.attach_volumes-515"><span class="linenos">515</span></a>        <span class="c1"># association is performed by matching the volume &#39;Instance&#39; tag to</span>
</span><span id="ClusterSet.attach_volumes-516"><a href="#ClusterSet.attach_volumes-516"><span class="linenos">516</span></a>        <span class="c1"># the instance &#39;Name&#39; tag.</span>
</span><span id="ClusterSet.attach_volumes-517"><a href="#ClusterSet.attach_volumes-517"><span class="linenos">517</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.attach_volumes-518"><a href="#ClusterSet.attach_volumes-518"><span class="linenos">518</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes-519"><a href="#ClusterSet.attach_volumes-519"><span class="linenos">519</span></a>            <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-520"><a href="#ClusterSet.attach_volumes-520"><span class="linenos">520</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes-521"><a href="#ClusterSet.attach_volumes-521"><span class="linenos">521</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-522"><a href="#ClusterSet.attach_volumes-522"><span class="linenos">522</span></a>                <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-523"><a href="#ClusterSet.attach_volumes-523"><span class="linenos">523</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-524"><a href="#ClusterSet.attach_volumes-524"><span class="linenos">524</span></a>                <span class="k">if</span> <span class="n">instance</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes-525"><a href="#ClusterSet.attach_volumes-525"><span class="linenos">525</span></a>                    <span class="c1"># Attach volume</span>
</span><span id="ClusterSet.attach_volumes-526"><a href="#ClusterSet.attach_volumes-526"><span class="linenos">526</span></a>                    <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet.attach_volumes-527"><a href="#ClusterSet.attach_volumes-527"><span class="linenos">527</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-528"><a href="#ClusterSet.attach_volumes-528"><span class="linenos">528</span></a>                    <span class="n">volume</span><span class="o">.</span><span class="n">attach_to_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-529"><a href="#ClusterSet.attach_volumes-529"><span class="linenos">529</span></a>                    <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-530"><a href="#ClusterSet.attach_volumes-530"><span class="linenos">530</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes-531"><a href="#ClusterSet.attach_volumes-531"><span class="linenos">531</span></a>            <span class="c1"># This is probably an error. The expectation is that we have a set</span>
</span><span id="ClusterSet.attach_volumes-532"><a href="#ClusterSet.attach_volumes-532"><span class="linenos">532</span></a>            <span class="c1"># of newly created volumes from snapshots.</span>
</span><span id="ClusterSet.attach_volumes-533"><a href="#ClusterSet.attach_volumes-533"><span class="linenos">533</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: No volumes to attach.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-534"><a href="#ClusterSet.attach_volumes-534"><span class="linenos">534</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes-535"><a href="#ClusterSet.attach_volumes-535"><span class="linenos">535</span></a>            <span class="c1"># Wait for the volumes to be attached</span>
</span><span id="ClusterSet.attach_volumes-536"><a href="#ClusterSet.attach_volumes-536"><span class="linenos">536</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be attached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes-537"><a href="#ClusterSet.attach_volumes-537"><span class="linenos">537</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_in_use&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Attach volumes to associated instances.</p>

<p>Args:
    - label: label of volume to attach
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.create_volumes" class="classattr">
                                        <input id="ClusterSet.create_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.create_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.create_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.create_volumes-539"><a href="#ClusterSet.create_volumes-539"><span class="linenos">539</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet.create_volumes-540"><a href="#ClusterSet.create_volumes-540"><span class="linenos">540</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.create_volumes-541"><a href="#ClusterSet.create_volumes-541"><span class="linenos">541</span></a><span class="sd">        Create new volumes from managed snapshots.</span>
</span><span id="ClusterSet.create_volumes-542"><a href="#ClusterSet.create_volumes-542"><span class="linenos">542</span></a>
</span><span id="ClusterSet.create_volumes-543"><a href="#ClusterSet.create_volumes-543"><span class="linenos">543</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.create_volumes-544"><a href="#ClusterSet.create_volumes-544"><span class="linenos">544</span></a><span class="sd">            - label: label of snapshots to restore</span>
</span><span id="ClusterSet.create_volumes-545"><a href="#ClusterSet.create_volumes-545"><span class="linenos">545</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.create_volumes-546"><a href="#ClusterSet.create_volumes-546"><span class="linenos">546</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.create_volumes-547"><a href="#ClusterSet.create_volumes-547"><span class="linenos">547</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.create_volumes-548"><a href="#ClusterSet.create_volumes-548"><span class="linenos">548</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: create_managed_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-549"><a href="#ClusterSet.create_volumes-549"><span class="linenos">549</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-550"><a href="#ClusterSet.create_volumes-550"><span class="linenos">550</span></a>        <span class="c1"># Check if snapshot list is empty (e.g. due to an invalid label)</span>
</span><span id="ClusterSet.create_volumes-551"><a href="#ClusterSet.create_volumes-551"><span class="linenos">551</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes-552"><a href="#ClusterSet.create_volumes-552"><span class="linenos">552</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No snapshots found with label &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-553"><a href="#ClusterSet.create_volumes-553"><span class="linenos">553</span></a>        <span class="c1"># Create volumes</span>
</span><span id="ClusterSet.create_volumes-554"><a href="#ClusterSet.create_volumes-554"><span class="linenos">554</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.create_volumes-555"><a href="#ClusterSet.create_volumes-555"><span class="linenos">555</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes-556"><a href="#ClusterSet.create_volumes-556"><span class="linenos">556</span></a>            <span class="c1"># Determine snapshot&#39;s associated instance and device. This is</span>
</span><span id="ClusterSet.create_volumes-557"><a href="#ClusterSet.create_volumes-557"><span class="linenos">557</span></a>            <span class="c1"># needed later on so that we know where to attach it.</span>
</span><span id="ClusterSet.create_volumes-558"><a href="#ClusterSet.create_volumes-558"><span class="linenos">558</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-559"><a href="#ClusterSet.create_volumes-559"><span class="linenos">559</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-560"><a href="#ClusterSet.create_volumes-560"><span class="linenos">560</span></a>            <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-561"><a href="#ClusterSet.create_volumes-561"><span class="linenos">561</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes-562"><a href="#ClusterSet.create_volumes-562"><span class="linenos">562</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find device tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-563"><a href="#ClusterSet.create_volumes-563"><span class="linenos">563</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes-564"><a href="#ClusterSet.create_volumes-564"><span class="linenos">564</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find instance tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-565"><a href="#ClusterSet.create_volumes-565"><span class="linenos">565</span></a>            <span class="c1"># Determine availability zone from one of the cluster instances</span>
</span><span id="ClusterSet.create_volumes-566"><a href="#ClusterSet.create_volumes-566"><span class="linenos">566</span></a>            <span class="n">avail_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">placement</span><span class="p">[</span><span class="s1">&#39;AvailabilityZone&#39;</span><span class="p">]</span>
</span><span id="ClusterSet.create_volumes-567"><a href="#ClusterSet.create_volumes-567"><span class="linenos">567</span></a>            <span class="c1"># Make tags</span>
</span><span id="ClusterSet.create_volumes-568"><a href="#ClusterSet.create_volumes-568"><span class="linenos">568</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>
</span><span id="ClusterSet.create_volumes-569"><a href="#ClusterSet.create_volumes-569"><span class="linenos">569</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-570"><a href="#ClusterSet.create_volumes-570"><span class="linenos">570</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-571"><a href="#ClusterSet.create_volumes-571"><span class="linenos">571</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-572"><a href="#ClusterSet.create_volumes-572"><span class="linenos">572</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-573"><a href="#ClusterSet.create_volumes-573"><span class="linenos">573</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-574"><a href="#ClusterSet.create_volumes-574"><span class="linenos">574</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-575"><a href="#ClusterSet.create_volumes-575"><span class="linenos">575</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.create_volumes-576"><a href="#ClusterSet.create_volumes-576"><span class="linenos">576</span></a>            <span class="c1"># Create volume</span>
</span><span id="ClusterSet.create_volumes-577"><a href="#ClusterSet.create_volumes-577"><span class="linenos">577</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating volume from snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-578"><a href="#ClusterSet.create_volumes-578"><span class="linenos">578</span></a>            <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">create_volume</span><span class="p">(</span>
</span><span id="ClusterSet.create_volumes-579"><a href="#ClusterSet.create_volumes-579"><span class="linenos">579</span></a>                <span class="n">SnapshotId</span><span class="o">=</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="ClusterSet.create_volumes-580"><a href="#ClusterSet.create_volumes-580"><span class="linenos">580</span></a>                <span class="n">AvailabilityZone</span><span class="o">=</span><span class="n">avail_zone</span><span class="p">,</span>
</span><span id="ClusterSet.create_volumes-581"><a href="#ClusterSet.create_volumes-581"><span class="linenos">581</span></a>                <span class="n">TagSpecifications</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">}]</span>
</span><span id="ClusterSet.create_volumes-582"><a href="#ClusterSet.create_volumes-582"><span class="linenos">582</span></a>            <span class="p">)</span>
</span><span id="ClusterSet.create_volumes-583"><a href="#ClusterSet.create_volumes-583"><span class="linenos">583</span></a>            <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-584"><a href="#ClusterSet.create_volumes-584"><span class="linenos">584</span></a>        <span class="c1"># Wait for the volumes to be created</span>
</span><span id="ClusterSet.create_volumes-585"><a href="#ClusterSet.create_volumes-585"><span class="linenos">585</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes-586"><a href="#ClusterSet.create_volumes-586"><span class="linenos">586</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be created...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-587"><a href="#ClusterSet.create_volumes-587"><span class="linenos">587</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes-588"><a href="#ClusterSet.create_volumes-588"><span class="linenos">588</span></a>            <span class="c1"># When attaching newly created volumes later, not all volumes are</span>
</span><span id="ClusterSet.create_volumes-589"><a href="#ClusterSet.create_volumes-589"><span class="linenos">589</span></a>            <span class="c1"># being attached for some reason. Perhaps the waiter returns before</span>
</span><span id="ClusterSet.create_volumes-590"><a href="#ClusterSet.create_volumes-590"><span class="linenos">590</span></a>            <span class="c1"># the tags have actually been applied. Try giving ten more seconds</span>
</span><span id="ClusterSet.create_volumes-591"><a href="#ClusterSet.create_volumes-591"><span class="linenos">591</span></a>            <span class="c1"># for the tags to be applied.</span>
</span><span id="ClusterSet.create_volumes-592"><a href="#ClusterSet.create_volumes-592"><span class="linenos">592</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create new volumes from managed snapshots.</p>

<p>Args:
    - label: label of snapshots to restore
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.delete_volumes" class="classattr">
                                        <input id="ClusterSet.delete_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.delete_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.delete_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.delete_volumes-594"><a href="#ClusterSet.delete_volumes-594"><span class="linenos">594</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.delete_volumes-595"><a href="#ClusterSet.delete_volumes-595"><span class="linenos">595</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_volumes-596"><a href="#ClusterSet.delete_volumes-596"><span class="linenos">596</span></a><span class="sd">        Delete all volumes associated with this cluster.</span>
</span><span id="ClusterSet.delete_volumes-597"><a href="#ClusterSet.delete_volumes-597"><span class="linenos">597</span></a>
</span><span id="ClusterSet.delete_volumes-598"><a href="#ClusterSet.delete_volumes-598"><span class="linenos">598</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.delete_volumes-599"><a href="#ClusterSet.delete_volumes-599"><span class="linenos">599</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.delete_volumes-600"><a href="#ClusterSet.delete_volumes-600"><span class="linenos">600</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.delete_volumes-601"><a href="#ClusterSet.delete_volumes-601"><span class="linenos">601</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.delete_volumes-602"><a href="#ClusterSet.delete_volumes-602"><span class="linenos">602</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_volumes-603"><a href="#ClusterSet.delete_volumes-603"><span class="linenos">603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes-604"><a href="#ClusterSet.delete_volumes-604"><span class="linenos">604</span></a>        <span class="c1"># We really only have to delete the previously detached volumes, but</span>
</span><span id="ClusterSet.delete_volumes-605"><a href="#ClusterSet.delete_volumes-605"><span class="linenos">605</span></a>        <span class="c1"># this will delete all managed volumes in the cluster. Its probably a</span>
</span><span id="ClusterSet.delete_volumes-606"><a href="#ClusterSet.delete_volumes-606"><span class="linenos">606</span></a>        <span class="c1"># good idea to do so as a matter of good housekeeping. Also, if there</span>
</span><span id="ClusterSet.delete_volumes-607"><a href="#ClusterSet.delete_volumes-607"><span class="linenos">607</span></a>        <span class="c1"># are any stale volumes hanging around with the same label that we are</span>
</span><span id="ClusterSet.delete_volumes-608"><a href="#ClusterSet.delete_volumes-608"><span class="linenos">608</span></a>        <span class="c1"># about to restore from that would cause problems because we wouldn&#39;t</span>
</span><span id="ClusterSet.delete_volumes-609"><a href="#ClusterSet.delete_volumes-609"><span class="linenos">609</span></a>        <span class="c1"># know which volumes to attach.</span>
</span><span id="ClusterSet.delete_volumes-610"><a href="#ClusterSet.delete_volumes-610"><span class="linenos">610</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet.delete_volumes-611"><a href="#ClusterSet.delete_volumes-611"><span class="linenos">611</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes-612"><a href="#ClusterSet.delete_volumes-612"><span class="linenos">612</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No volumes to delete.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes-613"><a href="#ClusterSet.delete_volumes-613"><span class="linenos">613</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes-614"><a href="#ClusterSet.delete_volumes-614"><span class="linenos">614</span></a>            <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.delete_volumes-615"><a href="#ClusterSet.delete_volumes-615"><span class="linenos">615</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes-616"><a href="#ClusterSet.delete_volumes-616"><span class="linenos">616</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes-617"><a href="#ClusterSet.delete_volumes-617"><span class="linenos">617</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet.delete_volumes-618"><a href="#ClusterSet.delete_volumes-618"><span class="linenos">618</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes-619"><a href="#ClusterSet.delete_volumes-619"><span class="linenos">619</span></a>            <span class="c1"># Wait for the volumes to be deleted</span>
</span><span id="ClusterSet.delete_volumes-620"><a href="#ClusterSet.delete_volumes-620"><span class="linenos">620</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be deleted...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes-621"><a href="#ClusterSet.delete_volumes-621"><span class="linenos">621</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_deleted&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete all volumes associated with this cluster.</p>

<p>Args:
    none
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.delete_kubernetes_volumes" class="classattr">
                                        <input id="ClusterSet.delete_kubernetes_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_kubernetes_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.delete_kubernetes_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.delete_kubernetes_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.delete_kubernetes_volumes-623"><a href="#ClusterSet.delete_kubernetes_volumes-623"><span class="linenos">623</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_kubernetes_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-624"><a href="#ClusterSet.delete_kubernetes_volumes-624"><span class="linenos">624</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-625"><a href="#ClusterSet.delete_kubernetes_volumes-625"><span class="linenos">625</span></a><span class="sd">        Delete all kubernetes volumes associated with this cluster.</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-626"><a href="#ClusterSet.delete_kubernetes_volumes-626"><span class="linenos">626</span></a>
</span><span id="ClusterSet.delete_kubernetes_volumes-627"><a href="#ClusterSet.delete_kubernetes_volumes-627"><span class="linenos">627</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-628"><a href="#ClusterSet.delete_kubernetes_volumes-628"><span class="linenos">628</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-629"><a href="#ClusterSet.delete_kubernetes_volumes-629"><span class="linenos">629</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-630"><a href="#ClusterSet.delete_kubernetes_volumes-630"><span class="linenos">630</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-631"><a href="#ClusterSet.delete_kubernetes_volumes-631"><span class="linenos">631</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-632"><a href="#ClusterSet.delete_kubernetes_volumes-632"><span class="linenos">632</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_kubernetes_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-633"><a href="#ClusterSet.delete_kubernetes_volumes-633"><span class="linenos">633</span></a>        <span class="c1"># We really only have to delete the previously detached volumes, but</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-634"><a href="#ClusterSet.delete_kubernetes_volumes-634"><span class="linenos">634</span></a>        <span class="c1"># this will delete all managed volumes in the cluster. Its probably a</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-635"><a href="#ClusterSet.delete_kubernetes_volumes-635"><span class="linenos">635</span></a>        <span class="c1"># good idea to do so as a matter of good housekeeping. Also, if there</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-636"><a href="#ClusterSet.delete_kubernetes_volumes-636"><span class="linenos">636</span></a>        <span class="c1"># are any stale volumes hanging around with the same label that we are</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-637"><a href="#ClusterSet.delete_kubernetes_volumes-637"><span class="linenos">637</span></a>        <span class="c1"># about to restore from that would cause problems because we wouldn&#39;t</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-638"><a href="#ClusterSet.delete_kubernetes_volumes-638"><span class="linenos">638</span></a>        <span class="c1"># know which volumes to attach.</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-639"><a href="#ClusterSet.delete_kubernetes_volumes-639"><span class="linenos">639</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_kubernetes_volumes</span><span class="p">()</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-640"><a href="#ClusterSet.delete_kubernetes_volumes-640"><span class="linenos">640</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-641"><a href="#ClusterSet.delete_kubernetes_volumes-641"><span class="linenos">641</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No kubernetes volumes to delete.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-642"><a href="#ClusterSet.delete_kubernetes_volumes-642"><span class="linenos">642</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-643"><a href="#ClusterSet.delete_kubernetes_volumes-643"><span class="linenos">643</span></a>            <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-644"><a href="#ClusterSet.delete_kubernetes_volumes-644"><span class="linenos">644</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-645"><a href="#ClusterSet.delete_kubernetes_volumes-645"><span class="linenos">645</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-646"><a href="#ClusterSet.delete_kubernetes_volumes-646"><span class="linenos">646</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-647"><a href="#ClusterSet.delete_kubernetes_volumes-647"><span class="linenos">647</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-648"><a href="#ClusterSet.delete_kubernetes_volumes-648"><span class="linenos">648</span></a>            <span class="c1"># Wait for the volumes to be deleted</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-649"><a href="#ClusterSet.delete_kubernetes_volumes-649"><span class="linenos">649</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be deleted...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_kubernetes_volumes-650"><a href="#ClusterSet.delete_kubernetes_volumes-650"><span class="linenos">650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_deleted&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete all kubernetes volumes associated with this cluster.</p>

<p>Args:
    none
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.detach_volumes" class="classattr">
                                        <input id="ClusterSet.detach_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detach_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.detach_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.detach_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.detach_volumes-652"><a href="#ClusterSet.detach_volumes-652"><span class="linenos">652</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detach_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.detach_volumes-653"><a href="#ClusterSet.detach_volumes-653"><span class="linenos">653</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.detach_volumes-654"><a href="#ClusterSet.detach_volumes-654"><span class="linenos">654</span></a><span class="sd">        Detach all currently attached volumes.</span>
</span><span id="ClusterSet.detach_volumes-655"><a href="#ClusterSet.detach_volumes-655"><span class="linenos">655</span></a>
</span><span id="ClusterSet.detach_volumes-656"><a href="#ClusterSet.detach_volumes-656"><span class="linenos">656</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.detach_volumes-657"><a href="#ClusterSet.detach_volumes-657"><span class="linenos">657</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.detach_volumes-658"><a href="#ClusterSet.detach_volumes-658"><span class="linenos">658</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.detach_volumes-659"><a href="#ClusterSet.detach_volumes-659"><span class="linenos">659</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.detach_volumes-660"><a href="#ClusterSet.detach_volumes-660"><span class="linenos">660</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.detach_volumes-661"><a href="#ClusterSet.detach_volumes-661"><span class="linenos">661</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: detach_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes-662"><a href="#ClusterSet.detach_volumes-662"><span class="linenos">662</span></a>        <span class="c1"># Build list of volume_ids so to pass to waiter in one big batch</span>
</span><span id="ClusterSet.detach_volumes-663"><a href="#ClusterSet.detach_volumes-663"><span class="linenos">663</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.detach_volumes-664"><a href="#ClusterSet.detach_volumes-664"><span class="linenos">664</span></a>        <span class="c1"># For each instance, detach all volumes</span>
</span><span id="ClusterSet.detach_volumes-665"><a href="#ClusterSet.detach_volumes-665"><span class="linenos">665</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet.detach_volumes-666"><a href="#ClusterSet.detach_volumes-666"><span class="linenos">666</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.detach_volumes-667"><a href="#ClusterSet.detach_volumes-667"><span class="linenos">667</span></a>            <span class="n">volumes</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ClusterSet.detach_volumes-668"><a href="#ClusterSet.detach_volumes-668"><span class="linenos">668</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.detach_volumes-669"><a href="#ClusterSet.detach_volumes-669"><span class="linenos">669</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Device&#39;</span><span class="p">]</span>
</span><span id="ClusterSet.detach_volumes-670"><a href="#ClusterSet.detach_volumes-670"><span class="linenos">670</span></a>                <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes-671"><a href="#ClusterSet.detach_volumes-671"><span class="linenos">671</span></a>                <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet.detach_volumes-672"><a href="#ClusterSet.detach_volumes-672"><span class="linenos">672</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes-673"><a href="#ClusterSet.detach_volumes-673"><span class="linenos">673</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">detach_from_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes-674"><a href="#ClusterSet.detach_volumes-674"><span class="linenos">674</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes-675"><a href="#ClusterSet.detach_volumes-675"><span class="linenos">675</span></a>        <span class="c1"># Wait for volumes to detach</span>
</span><span id="ClusterSet.detach_volumes-676"><a href="#ClusterSet.detach_volumes-676"><span class="linenos">676</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.detach_volumes-677"><a href="#ClusterSet.detach_volumes-677"><span class="linenos">677</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be detached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes-678"><a href="#ClusterSet.detach_volumes-678"><span class="linenos">678</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Detach all currently attached volumes.</p>

<p>Args:
    none
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.tag_volumes" class="classattr">
                                        <input id="ClusterSet.tag_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tag_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.tag_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.tag_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.tag_volumes-680"><a href="#ClusterSet.tag_volumes-680"><span class="linenos">680</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.tag_volumes-681"><a href="#ClusterSet.tag_volumes-681"><span class="linenos">681</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet.tag_volumes-682"><a href="#ClusterSet.tag_volumes-682"><span class="linenos">682</span></a>        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.tag_volumes-683"><a href="#ClusterSet.tag_volumes-683"><span class="linenos">683</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.tag_volumes-684"><a href="#ClusterSet.tag_volumes-684"><span class="linenos">684</span></a>            <span class="n">volume</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.untag_volumes" class="classattr">
                                        <input id="ClusterSet.untag_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">untag_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.untag_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.untag_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.untag_volumes-686"><a href="#ClusterSet.untag_volumes-686"><span class="linenos">686</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.untag_volumes-687"><a href="#ClusterSet.untag_volumes-687"><span class="linenos">687</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet.untag_volumes-688"><a href="#ClusterSet.untag_volumes-688"><span class="linenos">688</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.untag_volumes-689"><a href="#ClusterSet.untag_volumes-689"><span class="linenos">689</span></a>        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.untag_volumes-690"><a href="#ClusterSet.untag_volumes-690"><span class="linenos">690</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.untag_volumes-691"><a href="#ClusterSet.untag_volumes-691"><span class="linenos">691</span></a>            <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.untag_volumes-692"><a href="#ClusterSet.untag_volumes-692"><span class="linenos">692</span></a>        <span class="c1"># Might as well un-tag on one big batch since volume objects don&#39;t</span>
</span><span id="ClusterSet.untag_volumes-693"><a href="#ClusterSet.untag_volumes-693"><span class="linenos">693</span></a>        <span class="c1"># have direct support for un-tagging.</span>
</span><span id="ClusterSet.untag_volumes-694"><a href="#ClusterSet.untag_volumes-694"><span class="linenos">694</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="n">volume_ids</span><span class="p">,</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.wait_for_volumes" class="classattr">
                                        <input id="ClusterSet.wait_for_volumes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">wait_for_volumes</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">volume_ids</span>, </span><span class="param"><span class="n">status</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.wait_for_volumes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.wait_for_volumes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.wait_for_volumes-696"><a href="#ClusterSet.wait_for_volumes-696"><span class="linenos">696</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_ids</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
</span><span id="ClusterSet.wait_for_volumes-697"><a href="#ClusterSet.wait_for_volumes-697"><span class="linenos">697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.wait_for_volumes-698"><a href="#ClusterSet.wait_for_volumes-698"><span class="linenos">698</span></a><span class="sd">        Wait for an action to complete on volumes.</span>
</span><span id="ClusterSet.wait_for_volumes-699"><a href="#ClusterSet.wait_for_volumes-699"><span class="linenos">699</span></a>
</span><span id="ClusterSet.wait_for_volumes-700"><a href="#ClusterSet.wait_for_volumes-700"><span class="linenos">700</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.wait_for_volumes-701"><a href="#ClusterSet.wait_for_volumes-701"><span class="linenos">701</span></a><span class="sd">            volume_ids - volume_ids: list of volume IDs</span>
</span><span id="ClusterSet.wait_for_volumes-702"><a href="#ClusterSet.wait_for_volumes-702"><span class="linenos">702</span></a><span class="sd">            status - status to check for completion of action</span>
</span><span id="ClusterSet.wait_for_volumes-703"><a href="#ClusterSet.wait_for_volumes-703"><span class="linenos">703</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.wait_for_volumes-704"><a href="#ClusterSet.wait_for_volumes-704"><span class="linenos">704</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.wait_for_volumes-705"><a href="#ClusterSet.wait_for_volumes-705"><span class="linenos">705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.wait_for_volumes-706"><a href="#ClusterSet.wait_for_volumes-706"><span class="linenos">706</span></a>        <span class="c1"># This is a helper method - perhaps it should be static</span>
</span><span id="ClusterSet.wait_for_volumes-707"><a href="#ClusterSet.wait_for_volumes-707"><span class="linenos">707</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: wait_for_volumes&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.wait_for_volumes-708"><a href="#ClusterSet.wait_for_volumes-708"><span class="linenos">708</span></a>        <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</span><span id="ClusterSet.wait_for_volumes-709"><a href="#ClusterSet.wait_for_volumes-709"><span class="linenos">709</span></a>        <span class="n">waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
</span><span id="ClusterSet.wait_for_volumes-710"><a href="#ClusterSet.wait_for_volumes-710"><span class="linenos">710</span></a>            <span class="n">VolumeIds</span><span class="o">=</span><span class="n">volume_ids</span><span class="p">,</span>
</span><span id="ClusterSet.wait_for_volumes-711"><a href="#ClusterSet.wait_for_volumes-711"><span class="linenos">711</span></a>            <span class="n">WaiterConfig</span><span class="o">=</span><span class="p">{</span>
</span><span id="ClusterSet.wait_for_volumes-712"><a href="#ClusterSet.wait_for_volumes-712"><span class="linenos">712</span></a>                <span class="c1"># &#39;Delay&#39;: 15  # This is the default in seconds</span>
</span><span id="ClusterSet.wait_for_volumes-713"><a href="#ClusterSet.wait_for_volumes-713"><span class="linenos">713</span></a>                <span class="s1">&#39;MaxAttempts&#39;</span><span class="p">:</span> <span class="mi">240</span>  <span class="c1"># This will give AWS an hour</span>
</span><span id="ClusterSet.wait_for_volumes-714"><a href="#ClusterSet.wait_for_volumes-714"><span class="linenos">714</span></a>            <span class="p">}</span>
</span><span id="ClusterSet.wait_for_volumes-715"><a href="#ClusterSet.wait_for_volumes-715"><span class="linenos">715</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Wait for an action to complete on volumes.</p>

<p>Args:
    volume_ids - volume_ids: list of volume IDs
    status - status to check for completion of action
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.get_snapshots" class="classattr">
                                        <input id="ClusterSet.get_snapshots-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_snapshots</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_snapshots-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_snapshots"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_snapshots-717"><a href="#ClusterSet.get_snapshots-717"><span class="linenos">717</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="ClusterSet.get_snapshots-718"><a href="#ClusterSet.get_snapshots-718"><span class="linenos">718</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_snapshots-719"><a href="#ClusterSet.get_snapshots-719"><span class="linenos">719</span></a><span class="sd">        Get a list of cluster snapshots.</span>
</span><span id="ClusterSet.get_snapshots-720"><a href="#ClusterSet.get_snapshots-720"><span class="linenos">720</span></a>
</span><span id="ClusterSet.get_snapshots-721"><a href="#ClusterSet.get_snapshots-721"><span class="linenos">721</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_snapshots-722"><a href="#ClusterSet.get_snapshots-722"><span class="linenos">722</span></a><span class="sd">            label - label of snapshots being sought (optional)</span>
</span><span id="ClusterSet.get_snapshots-723"><a href="#ClusterSet.get_snapshots-723"><span class="linenos">723</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_snapshots-724"><a href="#ClusterSet.get_snapshots-724"><span class="linenos">724</span></a><span class="sd">            list of snapshots</span>
</span><span id="ClusterSet.get_snapshots-725"><a href="#ClusterSet.get_snapshots-725"><span class="linenos">725</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_snapshots-726"><a href="#ClusterSet.get_snapshots-726"><span class="linenos">726</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_all_snapshots&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_snapshots-727"><a href="#ClusterSet.get_snapshots-727"><span class="linenos">727</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_snapshots-728"><a href="#ClusterSet.get_snapshots-728"><span class="linenos">728</span></a>        <span class="c1"># Only get snapshots in a completed state. It is expected that users</span>
</span><span id="ClusterSet.get_snapshots-729"><a href="#ClusterSet.get_snapshots-729"><span class="linenos">729</span></a>        <span class="c1"># will only call this method after snapshots have been completed.</span>
</span><span id="ClusterSet.get_snapshots-730"><a href="#ClusterSet.get_snapshots-730"><span class="linenos">730</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;completed&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.get_snapshots-731"><a href="#ClusterSet.get_snapshots-731"><span class="linenos">731</span></a>        <span class="c1"># Only get snapshots that were created by the snapshot manager.</span>
</span><span id="ClusterSet.get_snapshots-732"><a href="#ClusterSet.get_snapshots-732"><span class="linenos">732</span></a>        <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet.get_snapshots-733"><a href="#ClusterSet.get_snapshots-733"><span class="linenos">733</span></a>        <span class="c1"># Optionally, get snapshots with a given label</span>
</span><span id="ClusterSet.get_snapshots-734"><a href="#ClusterSet.get_snapshots-734"><span class="linenos">734</span></a>        <span class="k">if</span> <span class="n">label</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ClusterSet.get_snapshots-735"><a href="#ClusterSet.get_snapshots-735"><span class="linenos">735</span></a>            <span class="n">fs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.get_snapshots-736"><a href="#ClusterSet.get_snapshots-736"><span class="linenos">736</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_snapshots-737"><a href="#ClusterSet.get_snapshots-737"><span class="linenos">737</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">snapshots</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_snapshots-738"><a href="#ClusterSet.get_snapshots-738"><span class="linenos">738</span></a>        <span class="n">snapshot_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">snapshots</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet.get_snapshots-739"><a href="#ClusterSet.get_snapshots-739"><span class="linenos">739</span></a>        <span class="k">return</span> <span class="n">snapshot_list</span>
</span></pre></div>


            <div class="docstring"><p>Get a list of cluster snapshots.</p>

<p>Args:
    label - label of snapshots being sought (optional)
Returns:
    list of snapshots</p>
</div>


                            </div>
                            <div id="ClusterSet.create_snapshots" class="classattr">
                                        <input id="ClusterSet.create_snapshots-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_snapshots</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.create_snapshots-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.create_snapshots"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.create_snapshots-741"><a href="#ClusterSet.create_snapshots-741"><span class="linenos">741</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet.create_snapshots-742"><a href="#ClusterSet.create_snapshots-742"><span class="linenos">742</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.create_snapshots-743"><a href="#ClusterSet.create_snapshots-743"><span class="linenos">743</span></a><span class="sd">        Create snapshots of volumes.</span>
</span><span id="ClusterSet.create_snapshots-744"><a href="#ClusterSet.create_snapshots-744"><span class="linenos">744</span></a>
</span><span id="ClusterSet.create_snapshots-745"><a href="#ClusterSet.create_snapshots-745"><span class="linenos">745</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.create_snapshots-746"><a href="#ClusterSet.create_snapshots-746"><span class="linenos">746</span></a><span class="sd">            - label: label to apply to each snapshot</span>
</span><span id="ClusterSet.create_snapshots-747"><a href="#ClusterSet.create_snapshots-747"><span class="linenos">747</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.create_snapshots-748"><a href="#ClusterSet.create_snapshots-748"><span class="linenos">748</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.create_snapshots-749"><a href="#ClusterSet.create_snapshots-749"><span class="linenos">749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.create_snapshots-750"><a href="#ClusterSet.create_snapshots-750"><span class="linenos">750</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: create_snapshots&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-751"><a href="#ClusterSet.create_snapshots-751"><span class="linenos">751</span></a>        <span class="c1"># Check if any snapshots with the same label already exists. If so,</span>
</span><span id="ClusterSet.create_snapshots-752"><a href="#ClusterSet.create_snapshots-752"><span class="linenos">752</span></a>        <span class="c1"># delete them. Only one set of snapshots with a given label may</span>
</span><span id="ClusterSet.create_snapshots-753"><a href="#ClusterSet.create_snapshots-753"><span class="linenos">753</span></a>        <span class="c1"># exist at a time.</span>
</span><span id="ClusterSet.create_snapshots-754"><a href="#ClusterSet.create_snapshots-754"><span class="linenos">754</span></a>        <span class="n">old_snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-755"><a href="#ClusterSet.create_snapshots-755"><span class="linenos">755</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_snapshots</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.create_snapshots-756"><a href="#ClusterSet.create_snapshots-756"><span class="linenos">756</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">delete_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-757"><a href="#ClusterSet.create_snapshots-757"><span class="linenos">757</span></a>        <span class="n">snapshot_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.create_snapshots-758"><a href="#ClusterSet.create_snapshots-758"><span class="linenos">758</span></a>        <span class="c1"># Get list of instances that need snapshots taken</span>
</span><span id="ClusterSet.create_snapshots-759"><a href="#ClusterSet.create_snapshots-759"><span class="linenos">759</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet.create_snapshots-760"><a href="#ClusterSet.create_snapshots-760"><span class="linenos">760</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.create_snapshots-761"><a href="#ClusterSet.create_snapshots-761"><span class="linenos">761</span></a>            <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-762"><a href="#ClusterSet.create_snapshots-762"><span class="linenos">762</span></a>            <span class="c1"># Get collection of volumes for the current instance</span>
</span><span id="ClusterSet.create_snapshots-763"><a href="#ClusterSet.create_snapshots-763"><span class="linenos">763</span></a>            <span class="n">volumes</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ClusterSet.create_snapshots-764"><a href="#ClusterSet.create_snapshots-764"><span class="linenos">764</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.create_snapshots-765"><a href="#ClusterSet.create_snapshots-765"><span class="linenos">765</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Device&#39;</span><span class="p">]</span>
</span><span id="ClusterSet.create_snapshots-766"><a href="#ClusterSet.create_snapshots-766"><span class="linenos">766</span></a>                <span class="c1"># Make description</span>
</span><span id="ClusterSet.create_snapshots-767"><a href="#ClusterSet.create_snapshots-767"><span class="linenos">767</span></a>                <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="ClusterSet.create_snapshots-768"><a href="#ClusterSet.create_snapshots-768"><span class="linenos">768</span></a>                <span class="n">date</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-769"><a href="#ClusterSet.create_snapshots-769"><span class="linenos">769</span></a>                <span class="n">time</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-770"><a href="#ClusterSet.create_snapshots-770"><span class="linenos">770</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Managed snapshot taken on </span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">time</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="ClusterSet.create_snapshots-771"><a href="#ClusterSet.create_snapshots-771"><span class="linenos">771</span></a>                <span class="c1"># Make tags</span>
</span><span id="ClusterSet.create_snapshots-772"><a href="#ClusterSet.create_snapshots-772"><span class="linenos">772</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>
</span><span id="ClusterSet.create_snapshots-773"><a href="#ClusterSet.create_snapshots-773"><span class="linenos">773</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-774"><a href="#ClusterSet.create_snapshots-774"><span class="linenos">774</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-775"><a href="#ClusterSet.create_snapshots-775"><span class="linenos">775</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-776"><a href="#ClusterSet.create_snapshots-776"><span class="linenos">776</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-777"><a href="#ClusterSet.create_snapshots-777"><span class="linenos">777</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance_name</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-778"><a href="#ClusterSet.create_snapshots-778"><span class="linenos">778</span></a>                <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-779"><a href="#ClusterSet.create_snapshots-779"><span class="linenos">779</span></a>                <span class="n">tags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.create_snapshots-780"><a href="#ClusterSet.create_snapshots-780"><span class="linenos">780</span></a>                <span class="c1"># Create shapshot</span>
</span><span id="ClusterSet.create_snapshots-781"><a href="#ClusterSet.create_snapshots-781"><span class="linenos">781</span></a>                <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet.create_snapshots-782"><a href="#ClusterSet.create_snapshots-782"><span class="linenos">782</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating snapshot of </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) on </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-783"><a href="#ClusterSet.create_snapshots-783"><span class="linenos">783</span></a>                <span class="n">snapshot</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">create_snapshot</span><span class="p">(</span>
</span><span id="ClusterSet.create_snapshots-784"><a href="#ClusterSet.create_snapshots-784"><span class="linenos">784</span></a>                    <span class="n">Description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
</span><span id="ClusterSet.create_snapshots-785"><a href="#ClusterSet.create_snapshots-785"><span class="linenos">785</span></a>                    <span class="n">TagSpecifications</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;snapshot&#39;</span><span class="p">,</span> <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">}]</span>
</span><span id="ClusterSet.create_snapshots-786"><a href="#ClusterSet.create_snapshots-786"><span class="linenos">786</span></a>                <span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-787"><a href="#ClusterSet.create_snapshots-787"><span class="linenos">787</span></a>                <span class="n">snapshot_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-788"><a href="#ClusterSet.create_snapshots-788"><span class="linenos">788</span></a>        <span class="c1"># Wait for snapshots to complete</span>
</span><span id="ClusterSet.create_snapshots-789"><a href="#ClusterSet.create_snapshots-789"><span class="linenos">789</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshot_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshots to complete...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-790"><a href="#ClusterSet.create_snapshots-790"><span class="linenos">790</span></a>        <span class="n">waiter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">get_waiter</span><span class="p">(</span><span class="s1">&#39;snapshot_completed&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_snapshots-791"><a href="#ClusterSet.create_snapshots-791"><span class="linenos">791</span></a>        <span class="n">waiter</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span>
</span><span id="ClusterSet.create_snapshots-792"><a href="#ClusterSet.create_snapshots-792"><span class="linenos">792</span></a>            <span class="n">SnapshotIds</span><span class="o">=</span><span class="n">snapshot_ids</span><span class="p">,</span>
</span><span id="ClusterSet.create_snapshots-793"><a href="#ClusterSet.create_snapshots-793"><span class="linenos">793</span></a>            <span class="n">WaiterConfig</span><span class="o">=</span><span class="p">{</span>
</span><span id="ClusterSet.create_snapshots-794"><a href="#ClusterSet.create_snapshots-794"><span class="linenos">794</span></a>                <span class="c1"># &#39;Delay&#39;: 15  # This is the default in seconds</span>
</span><span id="ClusterSet.create_snapshots-795"><a href="#ClusterSet.create_snapshots-795"><span class="linenos">795</span></a>                <span class="s1">&#39;MaxAttempts&#39;</span><span class="p">:</span> <span class="mi">240</span>  <span class="c1"># This will give AWS an hour</span>
</span><span id="ClusterSet.create_snapshots-796"><a href="#ClusterSet.create_snapshots-796"><span class="linenos">796</span></a>            <span class="p">}</span>
</span><span id="ClusterSet.create_snapshots-797"><a href="#ClusterSet.create_snapshots-797"><span class="linenos">797</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create snapshots of volumes.</p>

<p>Args:
    - label: label to apply to each snapshot
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.delete_snapshots" class="classattr">
                                        <input id="ClusterSet.delete_snapshots-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_snapshots</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.delete_snapshots-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.delete_snapshots"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.delete_snapshots-799"><a href="#ClusterSet.delete_snapshots-799"><span class="linenos">799</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
</span><span id="ClusterSet.delete_snapshots-800"><a href="#ClusterSet.delete_snapshots-800"><span class="linenos">800</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_snapshots-801"><a href="#ClusterSet.delete_snapshots-801"><span class="linenos">801</span></a><span class="sd">        Delete cluster snapshots that have the given label.</span>
</span><span id="ClusterSet.delete_snapshots-802"><a href="#ClusterSet.delete_snapshots-802"><span class="linenos">802</span></a>
</span><span id="ClusterSet.delete_snapshots-803"><a href="#ClusterSet.delete_snapshots-803"><span class="linenos">803</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.delete_snapshots-804"><a href="#ClusterSet.delete_snapshots-804"><span class="linenos">804</span></a><span class="sd">            label - label of snapshots to be deleted</span>
</span><span id="ClusterSet.delete_snapshots-805"><a href="#ClusterSet.delete_snapshots-805"><span class="linenos">805</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.delete_snapshots-806"><a href="#ClusterSet.delete_snapshots-806"><span class="linenos">806</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.delete_snapshots-807"><a href="#ClusterSet.delete_snapshots-807"><span class="linenos">807</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_snapshots-808"><a href="#ClusterSet.delete_snapshots-808"><span class="linenos">808</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_snapshots&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_snapshots-809"><a href="#ClusterSet.delete_snapshots-809"><span class="linenos">809</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.delete_snapshots-810"><a href="#ClusterSet.delete_snapshots-810"><span class="linenos">810</span></a>        <span class="c1"># Delete each snapshot</span>
</span><span id="ClusterSet.delete_snapshots-811"><a href="#ClusterSet.delete_snapshots-811"><span class="linenos">811</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span><span class="si">}</span><span class="s2"> snapshots...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_snapshots-812"><a href="#ClusterSet.delete_snapshots-812"><span class="linenos">812</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet.delete_snapshots-813"><a href="#ClusterSet.delete_snapshots-813"><span class="linenos">813</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_snapshots-814"><a href="#ClusterSet.delete_snapshots-814"><span class="linenos">814</span></a>            <span class="n">snapshot</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet.delete_snapshots-815"><a href="#ClusterSet.delete_snapshots-815"><span class="linenos">815</span></a>        <span class="c1"># There is no waiter for snapshot deletion. Add a small delay to guard</span>
</span><span id="ClusterSet.delete_snapshots-816"><a href="#ClusterSet.delete_snapshots-816"><span class="linenos">816</span></a>        <span class="c1"># against any possible timing issues.</span>
</span><span id="ClusterSet.delete_snapshots-817"><a href="#ClusterSet.delete_snapshots-817"><span class="linenos">817</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete cluster snapshots that have the given label.</p>

<p>Args:
    label - label of snapshots to be deleted
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.tag_snapshots" class="classattr">
                                        <input id="ClusterSet.tag_snapshots-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tag_snapshots</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.tag_snapshots-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.tag_snapshots"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.tag_snapshots-819"><a href="#ClusterSet.tag_snapshots-819"><span class="linenos">819</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.tag_snapshots-820"><a href="#ClusterSet.tag_snapshots-820"><span class="linenos">820</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">()</span>
</span><span id="ClusterSet.tag_snapshots-821"><a href="#ClusterSet.tag_snapshots-821"><span class="linenos">821</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet.tag_snapshots-822"><a href="#ClusterSet.tag_snapshots-822"><span class="linenos">822</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.tag_snapshots-823"><a href="#ClusterSet.tag_snapshots-823"><span class="linenos">823</span></a>            <span class="n">snapshot</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.untag_snapshots" class="classattr">
                                        <input id="ClusterSet.untag_snapshots-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">untag_snapshots</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.untag_snapshots-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.untag_snapshots"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.untag_snapshots-825"><a href="#ClusterSet.untag_snapshots-825"><span class="linenos">825</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.untag_snapshots-826"><a href="#ClusterSet.untag_snapshots-826"><span class="linenos">826</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">()</span>
</span><span id="ClusterSet.untag_snapshots-827"><a href="#ClusterSet.untag_snapshots-827"><span class="linenos">827</span></a>        <span class="n">snapshot_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.untag_snapshots-828"><a href="#ClusterSet.untag_snapshots-828"><span class="linenos">828</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet.untag_snapshots-829"><a href="#ClusterSet.untag_snapshots-829"><span class="linenos">829</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.untag_snapshots-830"><a href="#ClusterSet.untag_snapshots-830"><span class="linenos">830</span></a>            <span class="n">snapshot_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.untag_snapshots-831"><a href="#ClusterSet.untag_snapshots-831"><span class="linenos">831</span></a>        <span class="c1"># Might as well un-tag on one big batch since snapshot objects don&#39;t</span>
</span><span id="ClusterSet.untag_snapshots-832"><a href="#ClusterSet.untag_snapshots-832"><span class="linenos">832</span></a>        <span class="c1"># have direct support for un-tagging.</span>
</span><span id="ClusterSet.untag_snapshots-833"><a href="#ClusterSet.untag_snapshots-833"><span class="linenos">833</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="n">snapshot_ids</span><span class="p">,</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.get_subnet" class="classattr">
                                        <input id="ClusterSet.get_subnet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_subnet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.get_subnet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.get_subnet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.get_subnet-835"><a href="#ClusterSet.get_subnet-835"><span class="linenos">835</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_subnet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="ClusterSet.get_subnet-836"><a href="#ClusterSet.get_subnet-836"><span class="linenos">836</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_subnet-837"><a href="#ClusterSet.get_subnet-837"><span class="linenos">837</span></a><span class="sd">        Get subnet belonging to this cluster.</span>
</span><span id="ClusterSet.get_subnet-838"><a href="#ClusterSet.get_subnet-838"><span class="linenos">838</span></a>
</span><span id="ClusterSet.get_subnet-839"><a href="#ClusterSet.get_subnet-839"><span class="linenos">839</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.get_subnet-840"><a href="#ClusterSet.get_subnet-840"><span class="linenos">840</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.get_subnet-841"><a href="#ClusterSet.get_subnet-841"><span class="linenos">841</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.get_subnet-842"><a href="#ClusterSet.get_subnet-842"><span class="linenos">842</span></a><span class="sd">            subnet</span>
</span><span id="ClusterSet.get_subnet-843"><a href="#ClusterSet.get_subnet-843"><span class="linenos">843</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.get_subnet-844"><a href="#ClusterSet.get_subnet-844"><span class="linenos">844</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: get_subnet&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_subnet-845"><a href="#ClusterSet.get_subnet-845"><span class="linenos">845</span></a>        <span class="n">fs</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_cluster_filter</span><span class="p">())</span>
</span><span id="ClusterSet.get_subnet-846"><a href="#ClusterSet.get_subnet-846"><span class="linenos">846</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.get_subnet-847"><a href="#ClusterSet.get_subnet-847"><span class="linenos">847</span></a>        <span class="n">subnets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">subnets</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="p">)</span>
</span><span id="ClusterSet.get_subnet-848"><a href="#ClusterSet.get_subnet-848"><span class="linenos">848</span></a>        <span class="n">subnet_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subnets</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MAX_ITEMS</span><span class="p">))</span>
</span><span id="ClusterSet.get_subnet-849"><a href="#ClusterSet.get_subnet-849"><span class="linenos">849</span></a>        <span class="c1"># There should only be one subnet per cluster</span>
</span><span id="ClusterSet.get_subnet-850"><a href="#ClusterSet.get_subnet-850"><span class="linenos">850</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subnet_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ClusterSet.get_subnet-851"><a href="#ClusterSet.get_subnet-851"><span class="linenos">851</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Error (get_subnet): more than one subnet returned.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.get_subnet-852"><a href="#ClusterSet.get_subnet-852"><span class="linenos">852</span></a>        <span class="n">subnet</span> <span class="o">=</span> <span class="n">subnet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet.get_subnet-853"><a href="#ClusterSet.get_subnet-853"><span class="linenos">853</span></a>        <span class="k">return</span> <span class="n">subnet</span>
</span></pre></div>


            <div class="docstring"><p>Get subnet belonging to this cluster.</p>

<p>Args:
    none
Returns:
    subnet</p>
</div>


                            </div>
                            <div id="ClusterSet.tag_subnet" class="classattr">
                                        <input id="ClusterSet.tag_subnet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">tag_subnet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.tag_subnet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.tag_subnet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.tag_subnet-855"><a href="#ClusterSet.tag_subnet-855"><span class="linenos">855</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">tag_subnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.tag_subnet-856"><a href="#ClusterSet.tag_subnet-856"><span class="linenos">856</span></a>        <span class="n">subnet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subnet</span><span class="p">()</span>
</span><span id="ClusterSet.tag_subnet-857"><a href="#ClusterSet.tag_subnet-857"><span class="linenos">857</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Tagging subnet </span><span class="si">{</span><span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.tag_subnet-858"><a href="#ClusterSet.tag_subnet-858"><span class="linenos">858</span></a>        <span class="n">subnet</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.untag_subnet" class="classattr">
                                        <input id="ClusterSet.untag_subnet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">untag_subnet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">tags</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.untag_subnet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.untag_subnet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.untag_subnet-860"><a href="#ClusterSet.untag_subnet-860"><span class="linenos">860</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">untag_subnet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="p">):</span>
</span><span id="ClusterSet.untag_subnet-861"><a href="#ClusterSet.untag_subnet-861"><span class="linenos">861</span></a>        <span class="n">subnet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_subnet</span><span class="p">()</span>
</span><span id="ClusterSet.untag_subnet-862"><a href="#ClusterSet.untag_subnet-862"><span class="linenos">862</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Un-tagging subnet </span><span class="si">{</span><span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.untag_subnet-863"><a href="#ClusterSet.untag_subnet-863"><span class="linenos">863</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_ec2_client</span><span class="o">.</span><span class="n">delete_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="p">[</span><span class="n">subnet</span><span class="o">.</span><span class="n">id</span><span class="p">],</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="ClusterSet.stop_instances_targeted" class="classattr">
                                        <input id="ClusterSet.stop_instances_targeted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop_instances_targeted</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name_pattern</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.stop_instances_targeted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.stop_instances_targeted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.stop_instances_targeted-897"><a href="#ClusterSet.stop_instances_targeted-897"><span class="linenos">897</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">stop_instances_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet.stop_instances_targeted-898"><a href="#ClusterSet.stop_instances_targeted-898"><span class="linenos">898</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.stop_instances_targeted-899"><a href="#ClusterSet.stop_instances_targeted-899"><span class="linenos">899</span></a><span class="sd">        Stop instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet.stop_instances_targeted-900"><a href="#ClusterSet.stop_instances_targeted-900"><span class="linenos">900</span></a>
</span><span id="ClusterSet.stop_instances_targeted-901"><a href="#ClusterSet.stop_instances_targeted-901"><span class="linenos">901</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.stop_instances_targeted-902"><a href="#ClusterSet.stop_instances_targeted-902"><span class="linenos">902</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet.stop_instances_targeted-903"><a href="#ClusterSet.stop_instances_targeted-903"><span class="linenos">903</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.stop_instances_targeted-904"><a href="#ClusterSet.stop_instances_targeted-904"><span class="linenos">904</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.stop_instances_targeted-905"><a href="#ClusterSet.stop_instances_targeted-905"><span class="linenos">905</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.stop_instances_targeted-906"><a href="#ClusterSet.stop_instances_targeted-906"><span class="linenos">906</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: stop_instances_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances_targeted-907"><a href="#ClusterSet.stop_instances_targeted-907"><span class="linenos">907</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_running_instances</span><span class="p">()</span>
</span><span id="ClusterSet.stop_instances_targeted-908"><a href="#ClusterSet.stop_instances_targeted-908"><span class="linenos">908</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances_targeted-909"><a href="#ClusterSet.stop_instances_targeted-909"><span class="linenos">909</span></a>
</span><span id="ClusterSet.stop_instances_targeted-910"><a href="#ClusterSet.stop_instances_targeted-910"><span class="linenos">910</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances_targeted-911"><a href="#ClusterSet.stop_instances_targeted-911"><span class="linenos">911</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No running instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances_targeted-912"><a href="#ClusterSet.stop_instances_targeted-912"><span class="linenos">912</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances_targeted-913"><a href="#ClusterSet.stop_instances_targeted-913"><span class="linenos">913</span></a>            <span class="c1"># Stop instances</span>
</span><span id="ClusterSet.stop_instances_targeted-914"><a href="#ClusterSet.stop_instances_targeted-914"><span class="linenos">914</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances_targeted-915"><a href="#ClusterSet.stop_instances_targeted-915"><span class="linenos">915</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances_targeted-916"><a href="#ClusterSet.stop_instances_targeted-916"><span class="linenos">916</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stopping </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances_targeted-917"><a href="#ClusterSet.stop_instances_targeted-917"><span class="linenos">917</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="ClusterSet.stop_instances_targeted-918"><a href="#ClusterSet.stop_instances_targeted-918"><span class="linenos">918</span></a>            <span class="c1"># Wait for instances to stop</span>
</span><span id="ClusterSet.stop_instances_targeted-919"><a href="#ClusterSet.stop_instances_targeted-919"><span class="linenos">919</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to stop...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.stop_instances_targeted-920"><a href="#ClusterSet.stop_instances_targeted-920"><span class="linenos">920</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.stop_instances_targeted-921"><a href="#ClusterSet.stop_instances_targeted-921"><span class="linenos">921</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_stopped</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Stop instances that match the given Name tag regex pattern.</p>

<p>Args:
    name_pattern: regex pattern to match instance Name tags
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.start_instances_targeted" class="classattr">
                                        <input id="ClusterSet.start_instances_targeted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">start_instances_targeted</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name_pattern</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.start_instances_targeted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.start_instances_targeted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.start_instances_targeted-923"><a href="#ClusterSet.start_instances_targeted-923"><span class="linenos">923</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start_instances_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet.start_instances_targeted-924"><a href="#ClusterSet.start_instances_targeted-924"><span class="linenos">924</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.start_instances_targeted-925"><a href="#ClusterSet.start_instances_targeted-925"><span class="linenos">925</span></a><span class="sd">        Start instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet.start_instances_targeted-926"><a href="#ClusterSet.start_instances_targeted-926"><span class="linenos">926</span></a>
</span><span id="ClusterSet.start_instances_targeted-927"><a href="#ClusterSet.start_instances_targeted-927"><span class="linenos">927</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.start_instances_targeted-928"><a href="#ClusterSet.start_instances_targeted-928"><span class="linenos">928</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet.start_instances_targeted-929"><a href="#ClusterSet.start_instances_targeted-929"><span class="linenos">929</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.start_instances_targeted-930"><a href="#ClusterSet.start_instances_targeted-930"><span class="linenos">930</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.start_instances_targeted-931"><a href="#ClusterSet.start_instances_targeted-931"><span class="linenos">931</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.start_instances_targeted-932"><a href="#ClusterSet.start_instances_targeted-932"><span class="linenos">932</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: start_instances_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances_targeted-933"><a href="#ClusterSet.start_instances_targeted-933"><span class="linenos">933</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stopped_instances</span><span class="p">()</span>
</span><span id="ClusterSet.start_instances_targeted-934"><a href="#ClusterSet.start_instances_targeted-934"><span class="linenos">934</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances_targeted-935"><a href="#ClusterSet.start_instances_targeted-935"><span class="linenos">935</span></a>
</span><span id="ClusterSet.start_instances_targeted-936"><a href="#ClusterSet.start_instances_targeted-936"><span class="linenos">936</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances_targeted-937"><a href="#ClusterSet.start_instances_targeted-937"><span class="linenos">937</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No stopped instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances_targeted-938"><a href="#ClusterSet.start_instances_targeted-938"><span class="linenos">938</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances_targeted-939"><a href="#ClusterSet.start_instances_targeted-939"><span class="linenos">939</span></a>            <span class="c1"># Start instances</span>
</span><span id="ClusterSet.start_instances_targeted-940"><a href="#ClusterSet.start_instances_targeted-940"><span class="linenos">940</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances_targeted-941"><a href="#ClusterSet.start_instances_targeted-941"><span class="linenos">941</span></a>                <span class="n">name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances_targeted-942"><a href="#ClusterSet.start_instances_targeted-942"><span class="linenos">942</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances_targeted-943"><a href="#ClusterSet.start_instances_targeted-943"><span class="linenos">943</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="ClusterSet.start_instances_targeted-944"><a href="#ClusterSet.start_instances_targeted-944"><span class="linenos">944</span></a>            <span class="c1"># Wait for instances to start</span>
</span><span id="ClusterSet.start_instances_targeted-945"><a href="#ClusterSet.start_instances_targeted-945"><span class="linenos">945</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span><span class="si">}</span><span class="s2"> instances to start...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.start_instances_targeted-946"><a href="#ClusterSet.start_instances_targeted-946"><span class="linenos">946</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.start_instances_targeted-947"><a href="#ClusterSet.start_instances_targeted-947"><span class="linenos">947</span></a>                <span class="n">i</span><span class="o">.</span><span class="n">wait_until_running</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Start instances that match the given Name tag regex pattern.</p>

<p>Args:
    name_pattern: regex pattern to match instance Name tags
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.detach_volumes_targeted" class="classattr">
                                        <input id="ClusterSet.detach_volumes_targeted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detach_volumes_targeted</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name_pattern</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.detach_volumes_targeted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.detach_volumes_targeted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.detach_volumes_targeted-949"><a href="#ClusterSet.detach_volumes_targeted-949"><span class="linenos">949</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">detach_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet.detach_volumes_targeted-950"><a href="#ClusterSet.detach_volumes_targeted-950"><span class="linenos">950</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.detach_volumes_targeted-951"><a href="#ClusterSet.detach_volumes_targeted-951"><span class="linenos">951</span></a><span class="sd">        Detach volumes from instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet.detach_volumes_targeted-952"><a href="#ClusterSet.detach_volumes_targeted-952"><span class="linenos">952</span></a>
</span><span id="ClusterSet.detach_volumes_targeted-953"><a href="#ClusterSet.detach_volumes_targeted-953"><span class="linenos">953</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.detach_volumes_targeted-954"><a href="#ClusterSet.detach_volumes_targeted-954"><span class="linenos">954</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet.detach_volumes_targeted-955"><a href="#ClusterSet.detach_volumes_targeted-955"><span class="linenos">955</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.detach_volumes_targeted-956"><a href="#ClusterSet.detach_volumes_targeted-956"><span class="linenos">956</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.detach_volumes_targeted-957"><a href="#ClusterSet.detach_volumes_targeted-957"><span class="linenos">957</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.detach_volumes_targeted-958"><a href="#ClusterSet.detach_volumes_targeted-958"><span class="linenos">958</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: detach_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-959"><a href="#ClusterSet.detach_volumes_targeted-959"><span class="linenos">959</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet.detach_volumes_targeted-960"><a href="#ClusterSet.detach_volumes_targeted-960"><span class="linenos">960</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-961"><a href="#ClusterSet.detach_volumes_targeted-961"><span class="linenos">961</span></a>
</span><span id="ClusterSet.detach_volumes_targeted-962"><a href="#ClusterSet.detach_volumes_targeted-962"><span class="linenos">962</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.detach_volumes_targeted-963"><a href="#ClusterSet.detach_volumes_targeted-963"><span class="linenos">963</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-964"><a href="#ClusterSet.detach_volumes_targeted-964"><span class="linenos">964</span></a>            <span class="k">return</span>
</span><span id="ClusterSet.detach_volumes_targeted-965"><a href="#ClusterSet.detach_volumes_targeted-965"><span class="linenos">965</span></a>
</span><span id="ClusterSet.detach_volumes_targeted-966"><a href="#ClusterSet.detach_volumes_targeted-966"><span class="linenos">966</span></a>        <span class="c1"># Build list of volume_ids so to pass to waiter in one big batch</span>
</span><span id="ClusterSet.detach_volumes_targeted-967"><a href="#ClusterSet.detach_volumes_targeted-967"><span class="linenos">967</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.detach_volumes_targeted-968"><a href="#ClusterSet.detach_volumes_targeted-968"><span class="linenos">968</span></a>        <span class="c1"># For each matching instance, detach all volumes</span>
</span><span id="ClusterSet.detach_volumes_targeted-969"><a href="#ClusterSet.detach_volumes_targeted-969"><span class="linenos">969</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.detach_volumes_targeted-970"><a href="#ClusterSet.detach_volumes_targeted-970"><span class="linenos">970</span></a>            <span class="n">volumes</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</span><span id="ClusterSet.detach_volumes_targeted-971"><a href="#ClusterSet.detach_volumes_targeted-971"><span class="linenos">971</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.detach_volumes_targeted-972"><a href="#ClusterSet.detach_volumes_targeted-972"><span class="linenos">972</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">attachments</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Device&#39;</span><span class="p">]</span>
</span><span id="ClusterSet.detach_volumes_targeted-973"><a href="#ClusterSet.detach_volumes_targeted-973"><span class="linenos">973</span></a>                <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-974"><a href="#ClusterSet.detach_volumes_targeted-974"><span class="linenos">974</span></a>                <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet.detach_volumes_targeted-975"><a href="#ClusterSet.detach_volumes_targeted-975"><span class="linenos">975</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Detaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) from </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-976"><a href="#ClusterSet.detach_volumes_targeted-976"><span class="linenos">976</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">detach_from_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-977"><a href="#ClusterSet.detach_volumes_targeted-977"><span class="linenos">977</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-978"><a href="#ClusterSet.detach_volumes_targeted-978"><span class="linenos">978</span></a>        <span class="c1"># Wait for volumes to detach</span>
</span><span id="ClusterSet.detach_volumes_targeted-979"><a href="#ClusterSet.detach_volumes_targeted-979"><span class="linenos">979</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.detach_volumes_targeted-980"><a href="#ClusterSet.detach_volumes_targeted-980"><span class="linenos">980</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be detached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.detach_volumes_targeted-981"><a href="#ClusterSet.detach_volumes_targeted-981"><span class="linenos">981</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Detach volumes from instances that match the given Name tag regex pattern.</p>

<p>Args:
    name_pattern: regex pattern to match instance Name tags
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.delete_volumes_targeted" class="classattr">
                                        <input id="ClusterSet.delete_volumes_targeted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">delete_volumes_targeted</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name_pattern</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.delete_volumes_targeted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.delete_volumes_targeted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.delete_volumes_targeted-983"><a href="#ClusterSet.delete_volumes_targeted-983"><span class="linenos"> 983</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">delete_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet.delete_volumes_targeted-984"><a href="#ClusterSet.delete_volumes_targeted-984"><span class="linenos"> 984</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_volumes_targeted-985"><a href="#ClusterSet.delete_volumes_targeted-985"><span class="linenos"> 985</span></a><span class="sd">        Delete volumes associated with instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet.delete_volumes_targeted-986"><a href="#ClusterSet.delete_volumes_targeted-986"><span class="linenos"> 986</span></a>
</span><span id="ClusterSet.delete_volumes_targeted-987"><a href="#ClusterSet.delete_volumes_targeted-987"><span class="linenos"> 987</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.delete_volumes_targeted-988"><a href="#ClusterSet.delete_volumes_targeted-988"><span class="linenos"> 988</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet.delete_volumes_targeted-989"><a href="#ClusterSet.delete_volumes_targeted-989"><span class="linenos"> 989</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.delete_volumes_targeted-990"><a href="#ClusterSet.delete_volumes_targeted-990"><span class="linenos"> 990</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.delete_volumes_targeted-991"><a href="#ClusterSet.delete_volumes_targeted-991"><span class="linenos"> 991</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.delete_volumes_targeted-992"><a href="#ClusterSet.delete_volumes_targeted-992"><span class="linenos"> 992</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: delete_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-993"><a href="#ClusterSet.delete_volumes_targeted-993"><span class="linenos"> 993</span></a>        <span class="c1"># Get all volumes and filter by instance name pattern</span>
</span><span id="ClusterSet.delete_volumes_targeted-994"><a href="#ClusterSet.delete_volumes_targeted-994"><span class="linenos"> 994</span></a>        <span class="n">all_volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_volumes</span><span class="p">()</span>
</span><span id="ClusterSet.delete_volumes_targeted-995"><a href="#ClusterSet.delete_volumes_targeted-995"><span class="linenos"> 995</span></a>        <span class="n">targeted_volumes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.delete_volumes_targeted-996"><a href="#ClusterSet.delete_volumes_targeted-996"><span class="linenos"> 996</span></a>
</span><span id="ClusterSet.delete_volumes_targeted-997"><a href="#ClusterSet.delete_volumes_targeted-997"><span class="linenos"> 997</span></a>        <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">all_volumes</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-998"><a href="#ClusterSet.delete_volumes_targeted-998"><span class="linenos"> 998</span></a>            <span class="n">volume_instance_tag</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="ClusterSet.delete_volumes_targeted-999"><a href="#ClusterSet.delete_volumes_targeted-999"><span class="linenos"> 999</span></a>            <span class="k">if</span> <span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1000"><a href="#ClusterSet.delete_volumes_targeted-1000"><span class="linenos">1000</span></a>                <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1001"><a href="#ClusterSet.delete_volumes_targeted-1001"><span class="linenos">1001</span></a>                    <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Instance&#39;</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1002"><a href="#ClusterSet.delete_volumes_targeted-1002"><span class="linenos">1002</span></a>                        <span class="n">volume_instance_tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
</span><span id="ClusterSet.delete_volumes_targeted-1003"><a href="#ClusterSet.delete_volumes_targeted-1003"><span class="linenos">1003</span></a>                        <span class="k">break</span>
</span><span id="ClusterSet.delete_volumes_targeted-1004"><a href="#ClusterSet.delete_volumes_targeted-1004"><span class="linenos">1004</span></a>
</span><span id="ClusterSet.delete_volumes_targeted-1005"><a href="#ClusterSet.delete_volumes_targeted-1005"><span class="linenos">1005</span></a>            <span class="k">if</span> <span class="n">volume_instance_tag</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1006"><a href="#ClusterSet.delete_volumes_targeted-1006"><span class="linenos">1006</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1007"><a href="#ClusterSet.delete_volumes_targeted-1007"><span class="linenos">1007</span></a>                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-1008"><a href="#ClusterSet.delete_volumes_targeted-1008"><span class="linenos">1008</span></a>                    <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">volume_instance_tag</span><span class="p">):</span>
</span><span id="ClusterSet.delete_volumes_targeted-1009"><a href="#ClusterSet.delete_volumes_targeted-1009"><span class="linenos">1009</span></a>                        <span class="n">targeted_volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-1010"><a href="#ClusterSet.delete_volumes_targeted-1010"><span class="linenos">1010</span></a>                <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1011"><a href="#ClusterSet.delete_volumes_targeted-1011"><span class="linenos">1011</span></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-1012"><a href="#ClusterSet.delete_volumes_targeted-1012"><span class="linenos">1012</span></a>
</span><span id="ClusterSet.delete_volumes_targeted-1013"><a href="#ClusterSet.delete_volumes_targeted-1013"><span class="linenos">1013</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targeted_volumes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1014"><a href="#ClusterSet.delete_volumes_targeted-1014"><span class="linenos">1014</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No volumes found for instances matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-1015"><a href="#ClusterSet.delete_volumes_targeted-1015"><span class="linenos">1015</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1016"><a href="#ClusterSet.delete_volumes_targeted-1016"><span class="linenos">1016</span></a>            <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.delete_volumes_targeted-1017"><a href="#ClusterSet.delete_volumes_targeted-1017"><span class="linenos">1017</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">targeted_volumes</span><span class="p">:</span>
</span><span id="ClusterSet.delete_volumes_targeted-1018"><a href="#ClusterSet.delete_volumes_targeted-1018"><span class="linenos">1018</span></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting volume </span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-1019"><a href="#ClusterSet.delete_volumes_targeted-1019"><span class="linenos">1019</span></a>                <span class="n">volume</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</span><span id="ClusterSet.delete_volumes_targeted-1020"><a href="#ClusterSet.delete_volumes_targeted-1020"><span class="linenos">1020</span></a>                <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-1021"><a href="#ClusterSet.delete_volumes_targeted-1021"><span class="linenos">1021</span></a>            <span class="c1"># Wait for the volumes to be deleted</span>
</span><span id="ClusterSet.delete_volumes_targeted-1022"><a href="#ClusterSet.delete_volumes_targeted-1022"><span class="linenos">1022</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be deleted...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.delete_volumes_targeted-1023"><a href="#ClusterSet.delete_volumes_targeted-1023"><span class="linenos">1023</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_deleted&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Delete volumes associated with instances that match the given Name tag regex pattern.</p>

<p>Args:
    name_pattern: regex pattern to match instance Name tags
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.create_volumes_targeted" class="classattr">
                                        <input id="ClusterSet.create_volumes_targeted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_volumes_targeted</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span>, </span><span class="param"><span class="n">name_pattern</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.create_volumes_targeted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.create_volumes_targeted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.create_volumes_targeted-1025"><a href="#ClusterSet.create_volumes_targeted-1025"><span class="linenos">1025</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">create_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet.create_volumes_targeted-1026"><a href="#ClusterSet.create_volumes_targeted-1026"><span class="linenos">1026</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.create_volumes_targeted-1027"><a href="#ClusterSet.create_volumes_targeted-1027"><span class="linenos">1027</span></a><span class="sd">        Create new volumes from snapshots for instances matching the given Name tag regex pattern.</span>
</span><span id="ClusterSet.create_volumes_targeted-1028"><a href="#ClusterSet.create_volumes_targeted-1028"><span class="linenos">1028</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1029"><a href="#ClusterSet.create_volumes_targeted-1029"><span class="linenos">1029</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.create_volumes_targeted-1030"><a href="#ClusterSet.create_volumes_targeted-1030"><span class="linenos">1030</span></a><span class="sd">            label: label of snapshots to restore</span>
</span><span id="ClusterSet.create_volumes_targeted-1031"><a href="#ClusterSet.create_volumes_targeted-1031"><span class="linenos">1031</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet.create_volumes_targeted-1032"><a href="#ClusterSet.create_volumes_targeted-1032"><span class="linenos">1032</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.create_volumes_targeted-1033"><a href="#ClusterSet.create_volumes_targeted-1033"><span class="linenos">1033</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.create_volumes_targeted-1034"><a href="#ClusterSet.create_volumes_targeted-1034"><span class="linenos">1034</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.create_volumes_targeted-1035"><a href="#ClusterSet.create_volumes_targeted-1035"><span class="linenos">1035</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: create_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1036"><a href="#ClusterSet.create_volumes_targeted-1036"><span class="linenos">1036</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1037"><a href="#ClusterSet.create_volumes_targeted-1037"><span class="linenos">1037</span></a>        <span class="c1"># Validate regex pattern first</span>
</span><span id="ClusterSet.create_volumes_targeted-1038"><a href="#ClusterSet.create_volumes_targeted-1038"><span class="linenos">1038</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1039"><a href="#ClusterSet.create_volumes_targeted-1039"><span class="linenos">1039</span></a>            <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1040"><a href="#ClusterSet.create_volumes_targeted-1040"><span class="linenos">1040</span></a>        <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1041"><a href="#ClusterSet.create_volumes_targeted-1041"><span class="linenos">1041</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid regex pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1042"><a href="#ClusterSet.create_volumes_targeted-1042"><span class="linenos">1042</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1043"><a href="#ClusterSet.create_volumes_targeted-1043"><span class="linenos">1043</span></a>        <span class="n">snapshots</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_snapshots</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1044"><a href="#ClusterSet.create_volumes_targeted-1044"><span class="linenos">1044</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1045"><a href="#ClusterSet.create_volumes_targeted-1045"><span class="linenos">1045</span></a>        <span class="c1"># Check if snapshot list is empty</span>
</span><span id="ClusterSet.create_volumes_targeted-1046"><a href="#ClusterSet.create_volumes_targeted-1046"><span class="linenos">1046</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">snapshots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1047"><a href="#ClusterSet.create_volumes_targeted-1047"><span class="linenos">1047</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No snapshots found with label &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1048"><a href="#ClusterSet.create_volumes_targeted-1048"><span class="linenos">1048</span></a>            <span class="k">return</span>
</span><span id="ClusterSet.create_volumes_targeted-1049"><a href="#ClusterSet.create_volumes_targeted-1049"><span class="linenos">1049</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1050"><a href="#ClusterSet.create_volumes_targeted-1050"><span class="linenos">1050</span></a>        <span class="c1"># Filter snapshots by instance name pattern</span>
</span><span id="ClusterSet.create_volumes_targeted-1051"><a href="#ClusterSet.create_volumes_targeted-1051"><span class="linenos">1051</span></a>        <span class="n">targeted_snapshots</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.create_volumes_targeted-1052"><a href="#ClusterSet.create_volumes_targeted-1052"><span class="linenos">1052</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1053"><a href="#ClusterSet.create_volumes_targeted-1053"><span class="linenos">1053</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">snapshots</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1054"><a href="#ClusterSet.create_volumes_targeted-1054"><span class="linenos">1054</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1055"><a href="#ClusterSet.create_volumes_targeted-1055"><span class="linenos">1055</span></a>            <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1056"><a href="#ClusterSet.create_volumes_targeted-1056"><span class="linenos">1056</span></a>            <span class="k">if</span> <span class="n">instance</span> <span class="ow">and</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
</span><span id="ClusterSet.create_volumes_targeted-1057"><a href="#ClusterSet.create_volumes_targeted-1057"><span class="linenos">1057</span></a>                <span class="n">targeted_snapshots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">snapshot</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1058"><a href="#ClusterSet.create_volumes_targeted-1058"><span class="linenos">1058</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1059"><a href="#ClusterSet.create_volumes_targeted-1059"><span class="linenos">1059</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">targeted_snapshots</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1060"><a href="#ClusterSet.create_volumes_targeted-1060"><span class="linenos">1060</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No snapshots found for instances matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1061"><a href="#ClusterSet.create_volumes_targeted-1061"><span class="linenos">1061</span></a>            <span class="k">return</span>
</span><span id="ClusterSet.create_volumes_targeted-1062"><a href="#ClusterSet.create_volumes_targeted-1062"><span class="linenos">1062</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1063"><a href="#ClusterSet.create_volumes_targeted-1063"><span class="linenos">1063</span></a>        <span class="c1"># Create volumes</span>
</span><span id="ClusterSet.create_volumes_targeted-1064"><a href="#ClusterSet.create_volumes_targeted-1064"><span class="linenos">1064</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.create_volumes_targeted-1065"><a href="#ClusterSet.create_volumes_targeted-1065"><span class="linenos">1065</span></a>        <span class="k">for</span> <span class="n">snapshot</span> <span class="ow">in</span> <span class="n">targeted_snapshots</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1066"><a href="#ClusterSet.create_volumes_targeted-1066"><span class="linenos">1066</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">snapshot</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1067"><a href="#ClusterSet.create_volumes_targeted-1067"><span class="linenos">1067</span></a>            <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1068"><a href="#ClusterSet.create_volumes_targeted-1068"><span class="linenos">1068</span></a>            <span class="n">instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1069"><a href="#ClusterSet.create_volumes_targeted-1069"><span class="linenos">1069</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1070"><a href="#ClusterSet.create_volumes_targeted-1070"><span class="linenos">1070</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find device tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1071"><a href="#ClusterSet.create_volumes_targeted-1071"><span class="linenos">1071</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1072"><a href="#ClusterSet.create_volumes_targeted-1072"><span class="linenos">1072</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: create_volume: Can&#39;t find instance tag for snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1073"><a href="#ClusterSet.create_volumes_targeted-1073"><span class="linenos">1073</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1074"><a href="#ClusterSet.create_volumes_targeted-1074"><span class="linenos">1074</span></a>            <span class="c1"># Determine availability zone from one of the cluster instances</span>
</span><span id="ClusterSet.create_volumes_targeted-1075"><a href="#ClusterSet.create_volumes_targeted-1075"><span class="linenos">1075</span></a>            <span class="n">avail_zone</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">placement</span><span class="p">[</span><span class="s1">&#39;AvailabilityZone&#39;</span><span class="p">]</span>
</span><span id="ClusterSet.create_volumes_targeted-1076"><a href="#ClusterSet.create_volumes_targeted-1076"><span class="linenos">1076</span></a>            <span class="c1"># Make tags</span>
</span><span id="ClusterSet.create_volumes_targeted-1077"><a href="#ClusterSet.create_volumes_targeted-1077"><span class="linenos">1077</span></a>            <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>
</span><span id="ClusterSet.create_volumes_targeted-1078"><a href="#ClusterSet.create_volumes_targeted-1078"><span class="linenos">1078</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_names</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1079"><a href="#ClusterSet.create_volumes_targeted-1079"><span class="linenos">1079</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1080"><a href="#ClusterSet.create_volumes_targeted-1080"><span class="linenos">1080</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1081"><a href="#ClusterSet.create_volumes_targeted-1081"><span class="linenos">1081</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1082"><a href="#ClusterSet.create_volumes_targeted-1082"><span class="linenos">1082</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1083"><a href="#ClusterSet.create_volumes_targeted-1083"><span class="linenos">1083</span></a>            <span class="n">ts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;automation_key&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AUTOMATION_KEY</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1084"><a href="#ClusterSet.create_volumes_targeted-1084"><span class="linenos">1084</span></a>            <span class="n">tags</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="ClusterSet.create_volumes_targeted-1085"><a href="#ClusterSet.create_volumes_targeted-1085"><span class="linenos">1085</span></a>            <span class="c1"># Create volume</span>
</span><span id="ClusterSet.create_volumes_targeted-1086"><a href="#ClusterSet.create_volumes_targeted-1086"><span class="linenos">1086</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating volume from snapshot </span><span class="si">{</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">instance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1087"><a href="#ClusterSet.create_volumes_targeted-1087"><span class="linenos">1087</span></a>            <span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec2</span><span class="o">.</span><span class="n">create_volume</span><span class="p">(</span>
</span><span id="ClusterSet.create_volumes_targeted-1088"><a href="#ClusterSet.create_volumes_targeted-1088"><span class="linenos">1088</span></a>                <span class="n">SnapshotId</span><span class="o">=</span><span class="n">snapshot</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="ClusterSet.create_volumes_targeted-1089"><a href="#ClusterSet.create_volumes_targeted-1089"><span class="linenos">1089</span></a>                <span class="n">AvailabilityZone</span><span class="o">=</span><span class="n">avail_zone</span><span class="p">,</span>
</span><span id="ClusterSet.create_volumes_targeted-1090"><a href="#ClusterSet.create_volumes_targeted-1090"><span class="linenos">1090</span></a>                <span class="n">TagSpecifications</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;ResourceType&#39;</span><span class="p">:</span> <span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Tags&#39;</span><span class="p">:</span> <span class="n">tags</span><span class="p">}]</span>
</span><span id="ClusterSet.create_volumes_targeted-1091"><a href="#ClusterSet.create_volumes_targeted-1091"><span class="linenos">1091</span></a>            <span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1092"><a href="#ClusterSet.create_volumes_targeted-1092"><span class="linenos">1092</span></a>            <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1093"><a href="#ClusterSet.create_volumes_targeted-1093"><span class="linenos">1093</span></a>
</span><span id="ClusterSet.create_volumes_targeted-1094"><a href="#ClusterSet.create_volumes_targeted-1094"><span class="linenos">1094</span></a>        <span class="c1"># Wait for the volumes to be created</span>
</span><span id="ClusterSet.create_volumes_targeted-1095"><a href="#ClusterSet.create_volumes_targeted-1095"><span class="linenos">1095</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.create_volumes_targeted-1096"><a href="#ClusterSet.create_volumes_targeted-1096"><span class="linenos">1096</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be created...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1097"><a href="#ClusterSet.create_volumes_targeted-1097"><span class="linenos">1097</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_available&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.create_volumes_targeted-1098"><a href="#ClusterSet.create_volumes_targeted-1098"><span class="linenos">1098</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create new volumes from snapshots for instances matching the given Name tag regex pattern.</p>

<p>Args:
    label: label of snapshots to restore
    name_pattern: regex pattern to match instance Name tags
Returns:
    none</p>
</div>


                            </div>
                            <div id="ClusterSet.attach_volumes_targeted" class="classattr">
                                        <input id="ClusterSet.attach_volumes_targeted-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">attach_volumes_targeted</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">label</span>, </span><span class="param"><span class="n">name_pattern</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ClusterSet.attach_volumes_targeted-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ClusterSet.attach_volumes_targeted"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ClusterSet.attach_volumes_targeted-1100"><a href="#ClusterSet.attach_volumes_targeted-1100"><span class="linenos">1100</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">attach_volumes_targeted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
</span><span id="ClusterSet.attach_volumes_targeted-1101"><a href="#ClusterSet.attach_volumes_targeted-1101"><span class="linenos">1101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ClusterSet.attach_volumes_targeted-1102"><a href="#ClusterSet.attach_volumes_targeted-1102"><span class="linenos">1102</span></a><span class="sd">        Attach volumes to instances that match the given Name tag regex pattern.</span>
</span><span id="ClusterSet.attach_volumes_targeted-1103"><a href="#ClusterSet.attach_volumes_targeted-1103"><span class="linenos">1103</span></a>
</span><span id="ClusterSet.attach_volumes_targeted-1104"><a href="#ClusterSet.attach_volumes_targeted-1104"><span class="linenos">1104</span></a><span class="sd">        Args:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1105"><a href="#ClusterSet.attach_volumes_targeted-1105"><span class="linenos">1105</span></a><span class="sd">            label: label of volumes to attach</span>
</span><span id="ClusterSet.attach_volumes_targeted-1106"><a href="#ClusterSet.attach_volumes_targeted-1106"><span class="linenos">1106</span></a><span class="sd">            name_pattern: regex pattern to match instance Name tags</span>
</span><span id="ClusterSet.attach_volumes_targeted-1107"><a href="#ClusterSet.attach_volumes_targeted-1107"><span class="linenos">1107</span></a><span class="sd">        Returns:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1108"><a href="#ClusterSet.attach_volumes_targeted-1108"><span class="linenos">1108</span></a><span class="sd">            none</span>
</span><span id="ClusterSet.attach_volumes_targeted-1109"><a href="#ClusterSet.attach_volumes_targeted-1109"><span class="linenos">1109</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ClusterSet.attach_volumes_targeted-1110"><a href="#ClusterSet.attach_volumes_targeted-1110"><span class="linenos">1110</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;method_call: attach_volumes_targeted&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1111"><a href="#ClusterSet.attach_volumes_targeted-1111"><span class="linenos">1111</span></a>        <span class="n">all_instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_instances</span><span class="p">()</span>
</span><span id="ClusterSet.attach_volumes_targeted-1112"><a href="#ClusterSet.attach_volumes_targeted-1112"><span class="linenos">1112</span></a>        <span class="n">instances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_instances_by_name_regex</span><span class="p">(</span><span class="n">all_instances</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1113"><a href="#ClusterSet.attach_volumes_targeted-1113"><span class="linenos">1113</span></a>
</span><span id="ClusterSet.attach_volumes_targeted-1114"><a href="#ClusterSet.attach_volumes_targeted-1114"><span class="linenos">1114</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1115"><a href="#ClusterSet.attach_volumes_targeted-1115"><span class="linenos">1115</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No instances found matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1116"><a href="#ClusterSet.attach_volumes_targeted-1116"><span class="linenos">1116</span></a>            <span class="k">return</span>
</span><span id="ClusterSet.attach_volumes_targeted-1117"><a href="#ClusterSet.attach_volumes_targeted-1117"><span class="linenos">1117</span></a>
</span><span id="ClusterSet.attach_volumes_targeted-1118"><a href="#ClusterSet.attach_volumes_targeted-1118"><span class="linenos">1118</span></a>        <span class="n">volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_restored_volumes</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1119"><a href="#ClusterSet.attach_volumes_targeted-1119"><span class="linenos">1119</span></a>
</span><span id="ClusterSet.attach_volumes_targeted-1120"><a href="#ClusterSet.attach_volumes_targeted-1120"><span class="linenos">1120</span></a>        <span class="c1"># Note: regex pattern already validated in _filter_instances_by_name_regex</span>
</span><span id="ClusterSet.attach_volumes_targeted-1121"><a href="#ClusterSet.attach_volumes_targeted-1121"><span class="linenos">1121</span></a>
</span><span id="ClusterSet.attach_volumes_targeted-1122"><a href="#ClusterSet.attach_volumes_targeted-1122"><span class="linenos">1122</span></a>        <span class="n">volume_ids</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ClusterSet.attach_volumes_targeted-1123"><a href="#ClusterSet.attach_volumes_targeted-1123"><span class="linenos">1123</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1124"><a href="#ClusterSet.attach_volumes_targeted-1124"><span class="linenos">1124</span></a>            <span class="n">instance_name</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1125"><a href="#ClusterSet.attach_volumes_targeted-1125"><span class="linenos">1125</span></a>            <span class="k">for</span> <span class="n">volume</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1126"><a href="#ClusterSet.attach_volumes_targeted-1126"><span class="linenos">1126</span></a>                <span class="n">ts</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1127"><a href="#ClusterSet.attach_volumes_targeted-1127"><span class="linenos">1127</span></a>                <span class="n">volume_instance</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Instance&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1128"><a href="#ClusterSet.attach_volumes_targeted-1128"><span class="linenos">1128</span></a>                <span class="n">device</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Device&#39;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1129"><a href="#ClusterSet.attach_volumes_targeted-1129"><span class="linenos">1129</span></a>                <span class="k">if</span> <span class="n">volume_instance</span> <span class="o">==</span> <span class="n">instance_name</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1130"><a href="#ClusterSet.attach_volumes_targeted-1130"><span class="linenos">1130</span></a>                    <span class="c1"># Attach volume</span>
</span><span id="ClusterSet.attach_volumes_targeted-1131"><a href="#ClusterSet.attach_volumes_targeted-1131"><span class="linenos">1131</span></a>                    <span class="n">shortname</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ClusterSet.attach_volumes_targeted-1132"><a href="#ClusterSet.attach_volumes_targeted-1132"><span class="linenos">1132</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attaching </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) to </span><span class="si">{</span><span class="n">shortname</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1133"><a href="#ClusterSet.attach_volumes_targeted-1133"><span class="linenos">1133</span></a>                    <span class="n">volume</span><span class="o">.</span><span class="n">attach_to_instance</span><span class="p">(</span><span class="n">Device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">InstanceId</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1134"><a href="#ClusterSet.attach_volumes_targeted-1134"><span class="linenos">1134</span></a>                    <span class="n">volume_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">volume</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1135"><a href="#ClusterSet.attach_volumes_targeted-1135"><span class="linenos">1135</span></a>
</span><span id="ClusterSet.attach_volumes_targeted-1136"><a href="#ClusterSet.attach_volumes_targeted-1136"><span class="linenos">1136</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1137"><a href="#ClusterSet.attach_volumes_targeted-1137"><span class="linenos">1137</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: No volumes to attach for instances matching pattern &#39;</span><span class="si">{</span><span class="n">name_pattern</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1138"><a href="#ClusterSet.attach_volumes_targeted-1138"><span class="linenos">1138</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ClusterSet.attach_volumes_targeted-1139"><a href="#ClusterSet.attach_volumes_targeted-1139"><span class="linenos">1139</span></a>            <span class="c1"># Wait for the volumes to be attached</span>
</span><span id="ClusterSet.attach_volumes_targeted-1140"><a href="#ClusterSet.attach_volumes_targeted-1140"><span class="linenos">1140</span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">)</span><span class="si">}</span><span class="s2"> volumes to be attached...&quot;</span><span class="p">)</span>
</span><span id="ClusterSet.attach_volumes_targeted-1141"><a href="#ClusterSet.attach_volumes_targeted-1141"><span class="linenos">1141</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_volumes</span><span class="p">(</span><span class="n">volume_ids</span><span class="p">,</span> <span class="s1">&#39;volume_in_use&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Attach volumes to instances that match the given Name tag regex pattern.</p>

<p>Args:
    label: label of volumes to attach
    name_pattern: regex pattern to match instance Name tags
Returns:
    none</p>
</div>


                            </div>
                </section>
                <section id="TagSet">
                            <input id="TagSet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TagSet</span>:

                <label class="view-source-button" for="TagSet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TagSet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TagSet-30"><a href="#TagSet-30"><span class="linenos"> 30</span></a><span class="k">class</span><span class="w"> </span><span class="nc">TagSet</span><span class="p">:</span>
</span><span id="TagSet-31"><a href="#TagSet-31"><span class="linenos"> 31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper class for managing AWS resource tags.</span>
</span><span id="TagSet-32"><a href="#TagSet-32"><span class="linenos"> 32</span></a>
</span><span id="TagSet-33"><a href="#TagSet-33"><span class="linenos"> 33</span></a><span class="sd">    Provides a convenient interface for working with AWS tags, which are</span>
</span><span id="TagSet-34"><a href="#TagSet-34"><span class="linenos"> 34</span></a><span class="sd">    typically represented as lists of Key/Value dictionaries. This class</span>
</span><span id="TagSet-35"><a href="#TagSet-35"><span class="linenos"> 35</span></a><span class="sd">    abstracts the details of the AWS tag format and provides simple methods</span>
</span><span id="TagSet-36"><a href="#TagSet-36"><span class="linenos"> 36</span></a><span class="sd">    for common tag operations.</span>
</span><span id="TagSet-37"><a href="#TagSet-37"><span class="linenos"> 37</span></a>
</span><span id="TagSet-38"><a href="#TagSet-38"><span class="linenos"> 38</span></a><span class="sd">    Attributes:</span>
</span><span id="TagSet-39"><a href="#TagSet-39"><span class="linenos"> 39</span></a><span class="sd">        _tags: Internal list of tag dictionaries in AWS format</span>
</span><span id="TagSet-40"><a href="#TagSet-40"><span class="linenos"> 40</span></a>
</span><span id="TagSet-41"><a href="#TagSet-41"><span class="linenos"> 41</span></a><span class="sd">    Example:</span>
</span><span id="TagSet-42"><a href="#TagSet-42"><span class="linenos"> 42</span></a><span class="sd">        ```python</span>
</span><span id="TagSet-43"><a href="#TagSet-43"><span class="linenos"> 43</span></a><span class="sd">        # Create empty tagset</span>
</span><span id="TagSet-44"><a href="#TagSet-44"><span class="linenos"> 44</span></a><span class="sd">        tags = TagSet()</span>
</span><span id="TagSet-45"><a href="#TagSet-45"><span class="linenos"> 45</span></a>
</span><span id="TagSet-46"><a href="#TagSet-46"><span class="linenos"> 46</span></a><span class="sd">        # Create from existing tags</span>
</span><span id="TagSet-47"><a href="#TagSet-47"><span class="linenos"> 47</span></a><span class="sd">        tags = TagSet(instance.tags)</span>
</span><span id="TagSet-48"><a href="#TagSet-48"><span class="linenos"> 48</span></a>
</span><span id="TagSet-49"><a href="#TagSet-49"><span class="linenos"> 49</span></a><span class="sd">        # Add tags</span>
</span><span id="TagSet-50"><a href="#TagSet-50"><span class="linenos"> 50</span></a><span class="sd">        tags.add(&#39;Name&#39;, &#39;web-server-01&#39;)</span>
</span><span id="TagSet-51"><a href="#TagSet-51"><span class="linenos"> 51</span></a><span class="sd">        tags.add(&#39;Environment&#39;, &#39;production&#39;)</span>
</span><span id="TagSet-52"><a href="#TagSet-52"><span class="linenos"> 52</span></a>
</span><span id="TagSet-53"><a href="#TagSet-53"><span class="linenos"> 53</span></a><span class="sd">        # Retrieve values</span>
</span><span id="TagSet-54"><a href="#TagSet-54"><span class="linenos"> 54</span></a><span class="sd">        name = tags.get(&#39;Name&#39;)</span>
</span><span id="TagSet-55"><a href="#TagSet-55"><span class="linenos"> 55</span></a><span class="sd">        ```</span>
</span><span id="TagSet-56"><a href="#TagSet-56"><span class="linenos"> 56</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="TagSet-57"><a href="#TagSet-57"><span class="linenos"> 57</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TagSet-58"><a href="#TagSet-58"><span class="linenos"> 58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize TagSet with optional existing tags.</span>
</span><span id="TagSet-59"><a href="#TagSet-59"><span class="linenos"> 59</span></a>
</span><span id="TagSet-60"><a href="#TagSet-60"><span class="linenos"> 60</span></a><span class="sd">        Args:</span>
</span><span id="TagSet-61"><a href="#TagSet-61"><span class="linenos"> 61</span></a><span class="sd">            tags: List of tag dictionaries in AWS format (optional).</span>
</span><span id="TagSet-62"><a href="#TagSet-62"><span class="linenos"> 62</span></a><span class="sd">                 If None, creates empty tag set.</span>
</span><span id="TagSet-63"><a href="#TagSet-63"><span class="linenos"> 63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet-64"><a href="#TagSet-64"><span class="linenos"> 64</span></a>        <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TagSet-65"><a href="#TagSet-65"><span class="linenos"> 65</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="TagSet-66"><a href="#TagSet-66"><span class="linenos"> 66</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TagSet-67"><a href="#TagSet-67"><span class="linenos"> 67</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
</span><span id="TagSet-68"><a href="#TagSet-68"><span class="linenos"> 68</span></a>
</span><span id="TagSet-69"><a href="#TagSet-69"><span class="linenos"> 69</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="TagSet-70"><a href="#TagSet-70"><span class="linenos"> 70</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new tag to the tag set.</span>
</span><span id="TagSet-71"><a href="#TagSet-71"><span class="linenos"> 71</span></a>
</span><span id="TagSet-72"><a href="#TagSet-72"><span class="linenos"> 72</span></a><span class="sd">        Args:</span>
</span><span id="TagSet-73"><a href="#TagSet-73"><span class="linenos"> 73</span></a><span class="sd">            key: Tag key (string)</span>
</span><span id="TagSet-74"><a href="#TagSet-74"><span class="linenos"> 74</span></a><span class="sd">            value: Tag value (string)</span>
</span><span id="TagSet-75"><a href="#TagSet-75"><span class="linenos"> 75</span></a>
</span><span id="TagSet-76"><a href="#TagSet-76"><span class="linenos"> 76</span></a><span class="sd">        Example:</span>
</span><span id="TagSet-77"><a href="#TagSet-77"><span class="linenos"> 77</span></a><span class="sd">            ```python</span>
</span><span id="TagSet-78"><a href="#TagSet-78"><span class="linenos"> 78</span></a><span class="sd">            tags.add(&#39;Environment&#39;, &#39;production&#39;)</span>
</span><span id="TagSet-79"><a href="#TagSet-79"><span class="linenos"> 79</span></a><span class="sd">            tags.add(&#39;Owner&#39;, &#39;team-backend&#39;)</span>
</span><span id="TagSet-80"><a href="#TagSet-80"><span class="linenos"> 80</span></a><span class="sd">            ```</span>
</span><span id="TagSet-81"><a href="#TagSet-81"><span class="linenos"> 81</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet-82"><a href="#TagSet-82"><span class="linenos"> 82</span></a>        <span class="n">tag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
</span><span id="TagSet-83"><a href="#TagSet-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span id="TagSet-84"><a href="#TagSet-84"><span class="linenos"> 84</span></a>
</span><span id="TagSet-85"><a href="#TagSet-85"><span class="linenos"> 85</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="TagSet-86"><a href="#TagSet-86"><span class="linenos"> 86</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the value for a specific tag key.</span>
</span><span id="TagSet-87"><a href="#TagSet-87"><span class="linenos"> 87</span></a>
</span><span id="TagSet-88"><a href="#TagSet-88"><span class="linenos"> 88</span></a><span class="sd">        Args:</span>
</span><span id="TagSet-89"><a href="#TagSet-89"><span class="linenos"> 89</span></a><span class="sd">            key: Tag key to look up (string)</span>
</span><span id="TagSet-90"><a href="#TagSet-90"><span class="linenos"> 90</span></a>
</span><span id="TagSet-91"><a href="#TagSet-91"><span class="linenos"> 91</span></a><span class="sd">        Returns:</span>
</span><span id="TagSet-92"><a href="#TagSet-92"><span class="linenos"> 92</span></a><span class="sd">            str: Tag value if found, None if key doesn&#39;t exist</span>
</span><span id="TagSet-93"><a href="#TagSet-93"><span class="linenos"> 93</span></a>
</span><span id="TagSet-94"><a href="#TagSet-94"><span class="linenos"> 94</span></a><span class="sd">        Example:</span>
</span><span id="TagSet-95"><a href="#TagSet-95"><span class="linenos"> 95</span></a><span class="sd">            ```python</span>
</span><span id="TagSet-96"><a href="#TagSet-96"><span class="linenos"> 96</span></a><span class="sd">            cluster_name = tags.get(&#39;Cluster&#39;)</span>
</span><span id="TagSet-97"><a href="#TagSet-97"><span class="linenos"> 97</span></a><span class="sd">            if cluster_name:</span>
</span><span id="TagSet-98"><a href="#TagSet-98"><span class="linenos"> 98</span></a><span class="sd">                print(f&quot;Instance belongs to cluster: {cluster_name}&quot;)</span>
</span><span id="TagSet-99"><a href="#TagSet-99"><span class="linenos"> 99</span></a><span class="sd">            ```</span>
</span><span id="TagSet-100"><a href="#TagSet-100"><span class="linenos">100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet-101"><a href="#TagSet-101"><span class="linenos">101</span></a>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">:</span>
</span><span id="TagSet-102"><a href="#TagSet-102"><span class="linenos">102</span></a>            <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
</span><span id="TagSet-103"><a href="#TagSet-103"><span class="linenos">103</span></a>                <span class="k">return</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
</span><span id="TagSet-104"><a href="#TagSet-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="TagSet-105"><a href="#TagSet-105"><span class="linenos">105</span></a>
</span><span id="TagSet-106"><a href="#TagSet-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TagSet-107"><a href="#TagSet-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert tag set to AWS-compatible list format.</span>
</span><span id="TagSet-108"><a href="#TagSet-108"><span class="linenos">108</span></a>
</span><span id="TagSet-109"><a href="#TagSet-109"><span class="linenos">109</span></a><span class="sd">        Returns:</span>
</span><span id="TagSet-110"><a href="#TagSet-110"><span class="linenos">110</span></a><span class="sd">            list: List of tag dictionaries in AWS format [{&#39;Key&#39;: &#39;k&#39;, &#39;Value&#39;: &#39;v&#39;}, ...]</span>
</span><span id="TagSet-111"><a href="#TagSet-111"><span class="linenos">111</span></a>
</span><span id="TagSet-112"><a href="#TagSet-112"><span class="linenos">112</span></a><span class="sd">        Example:</span>
</span><span id="TagSet-113"><a href="#TagSet-113"><span class="linenos">113</span></a><span class="sd">            ```python</span>
</span><span id="TagSet-114"><a href="#TagSet-114"><span class="linenos">114</span></a><span class="sd">            tags = TagSet()</span>
</span><span id="TagSet-115"><a href="#TagSet-115"><span class="linenos">115</span></a><span class="sd">            tags.add(&#39;Name&#39;, &#39;web-server&#39;)</span>
</span><span id="TagSet-116"><a href="#TagSet-116"><span class="linenos">116</span></a><span class="sd">            tags.add(&#39;Environment&#39;, &#39;prod&#39;)</span>
</span><span id="TagSet-117"><a href="#TagSet-117"><span class="linenos">117</span></a>
</span><span id="TagSet-118"><a href="#TagSet-118"><span class="linenos">118</span></a><span class="sd">            # Use with AWS API</span>
</span><span id="TagSet-119"><a href="#TagSet-119"><span class="linenos">119</span></a><span class="sd">            ec2.create_tags(Resources=[instance_id], Tags=tags.to_list())</span>
</span><span id="TagSet-120"><a href="#TagSet-120"><span class="linenos">120</span></a><span class="sd">            ```</span>
</span><span id="TagSet-121"><a href="#TagSet-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet-122"><a href="#TagSet-122"><span class="linenos">122</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper class for managing AWS resource tags.</p>

<p>Provides a convenient interface for working with AWS tags, which are
typically represented as lists of Key/Value dictionaries. This class
abstracts the details of the AWS tag format and provides simple methods
for common tag operations.</p>

<p>Attributes:
    _tags: Internal list of tag dictionaries in AWS format</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Create empty tagset</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>

<span class="c1"># Create from existing tags</span>
<span class="n">tags</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">tags</span><span class="p">)</span>

<span class="c1"># Add tags</span>
<span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;web-server-01&#39;</span><span class="p">)</span>
<span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>

<span class="c1"># Retrieve values</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            <div id="TagSet.__init__" class="classattr">
                                        <input id="TagSet.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TagSet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">tags</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="TagSet.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TagSet.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TagSet.__init__-57"><a href="#TagSet.__init__-57"><span class="linenos">57</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TagSet.__init__-58"><a href="#TagSet.__init__-58"><span class="linenos">58</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize TagSet with optional existing tags.</span>
</span><span id="TagSet.__init__-59"><a href="#TagSet.__init__-59"><span class="linenos">59</span></a>
</span><span id="TagSet.__init__-60"><a href="#TagSet.__init__-60"><span class="linenos">60</span></a><span class="sd">        Args:</span>
</span><span id="TagSet.__init__-61"><a href="#TagSet.__init__-61"><span class="linenos">61</span></a><span class="sd">            tags: List of tag dictionaries in AWS format (optional).</span>
</span><span id="TagSet.__init__-62"><a href="#TagSet.__init__-62"><span class="linenos">62</span></a><span class="sd">                 If None, creates empty tag set.</span>
</span><span id="TagSet.__init__-63"><a href="#TagSet.__init__-63"><span class="linenos">63</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet.__init__-64"><a href="#TagSet.__init__-64"><span class="linenos">64</span></a>        <span class="k">if</span> <span class="n">tags</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TagSet.__init__-65"><a href="#TagSet.__init__-65"><span class="linenos">65</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="TagSet.__init__-66"><a href="#TagSet.__init__-66"><span class="linenos">66</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="TagSet.__init__-67"><a href="#TagSet.__init__-67"><span class="linenos">67</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span> <span class="o">=</span> <span class="n">tags</span>
</span></pre></div>


            <div class="docstring"><p>Initialize TagSet with optional existing tags.</p>

<p>Args:
    tags: List of tag dictionaries in AWS format (optional).
         If None, creates empty tag set.</p>
</div>


                            </div>
                            <div id="TagSet.add" class="classattr">
                                        <input id="TagSet.add-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">key</span>, </span><span class="param"><span class="n">value</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TagSet.add-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TagSet.add"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TagSet.add-69"><a href="#TagSet.add-69"><span class="linenos">69</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="TagSet.add-70"><a href="#TagSet.add-70"><span class="linenos">70</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new tag to the tag set.</span>
</span><span id="TagSet.add-71"><a href="#TagSet.add-71"><span class="linenos">71</span></a>
</span><span id="TagSet.add-72"><a href="#TagSet.add-72"><span class="linenos">72</span></a><span class="sd">        Args:</span>
</span><span id="TagSet.add-73"><a href="#TagSet.add-73"><span class="linenos">73</span></a><span class="sd">            key: Tag key (string)</span>
</span><span id="TagSet.add-74"><a href="#TagSet.add-74"><span class="linenos">74</span></a><span class="sd">            value: Tag value (string)</span>
</span><span id="TagSet.add-75"><a href="#TagSet.add-75"><span class="linenos">75</span></a>
</span><span id="TagSet.add-76"><a href="#TagSet.add-76"><span class="linenos">76</span></a><span class="sd">        Example:</span>
</span><span id="TagSet.add-77"><a href="#TagSet.add-77"><span class="linenos">77</span></a><span class="sd">            ```python</span>
</span><span id="TagSet.add-78"><a href="#TagSet.add-78"><span class="linenos">78</span></a><span class="sd">            tags.add(&#39;Environment&#39;, &#39;production&#39;)</span>
</span><span id="TagSet.add-79"><a href="#TagSet.add-79"><span class="linenos">79</span></a><span class="sd">            tags.add(&#39;Owner&#39;, &#39;team-backend&#39;)</span>
</span><span id="TagSet.add-80"><a href="#TagSet.add-80"><span class="linenos">80</span></a><span class="sd">            ```</span>
</span><span id="TagSet.add-81"><a href="#TagSet.add-81"><span class="linenos">81</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet.add-82"><a href="#TagSet.add-82"><span class="linenos">82</span></a>        <span class="n">tag</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Key&#39;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
</span><span id="TagSet.add-83"><a href="#TagSet.add-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add a new tag to the tag set.</p>

<p>Args:
    key: Tag key (string)
    value: Tag value (string)</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
<span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Owner&#39;</span><span class="p">,</span> <span class="s1">&#39;team-backend&#39;</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="TagSet.get" class="classattr">
                                        <input id="TagSet.get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">key</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TagSet.get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TagSet.get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TagSet.get-85"><a href="#TagSet.get-85"><span class="linenos"> 85</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
</span><span id="TagSet.get-86"><a href="#TagSet.get-86"><span class="linenos"> 86</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the value for a specific tag key.</span>
</span><span id="TagSet.get-87"><a href="#TagSet.get-87"><span class="linenos"> 87</span></a>
</span><span id="TagSet.get-88"><a href="#TagSet.get-88"><span class="linenos"> 88</span></a><span class="sd">        Args:</span>
</span><span id="TagSet.get-89"><a href="#TagSet.get-89"><span class="linenos"> 89</span></a><span class="sd">            key: Tag key to look up (string)</span>
</span><span id="TagSet.get-90"><a href="#TagSet.get-90"><span class="linenos"> 90</span></a>
</span><span id="TagSet.get-91"><a href="#TagSet.get-91"><span class="linenos"> 91</span></a><span class="sd">        Returns:</span>
</span><span id="TagSet.get-92"><a href="#TagSet.get-92"><span class="linenos"> 92</span></a><span class="sd">            str: Tag value if found, None if key doesn&#39;t exist</span>
</span><span id="TagSet.get-93"><a href="#TagSet.get-93"><span class="linenos"> 93</span></a>
</span><span id="TagSet.get-94"><a href="#TagSet.get-94"><span class="linenos"> 94</span></a><span class="sd">        Example:</span>
</span><span id="TagSet.get-95"><a href="#TagSet.get-95"><span class="linenos"> 95</span></a><span class="sd">            ```python</span>
</span><span id="TagSet.get-96"><a href="#TagSet.get-96"><span class="linenos"> 96</span></a><span class="sd">            cluster_name = tags.get(&#39;Cluster&#39;)</span>
</span><span id="TagSet.get-97"><a href="#TagSet.get-97"><span class="linenos"> 97</span></a><span class="sd">            if cluster_name:</span>
</span><span id="TagSet.get-98"><a href="#TagSet.get-98"><span class="linenos"> 98</span></a><span class="sd">                print(f&quot;Instance belongs to cluster: {cluster_name}&quot;)</span>
</span><span id="TagSet.get-99"><a href="#TagSet.get-99"><span class="linenos"> 99</span></a><span class="sd">            ```</span>
</span><span id="TagSet.get-100"><a href="#TagSet.get-100"><span class="linenos">100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet.get-101"><a href="#TagSet.get-101"><span class="linenos">101</span></a>        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span><span class="p">:</span>
</span><span id="TagSet.get-102"><a href="#TagSet.get-102"><span class="linenos">102</span></a>            <span class="k">if</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
</span><span id="TagSet.get-103"><a href="#TagSet.get-103"><span class="linenos">103</span></a>                <span class="k">return</span> <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">]</span>
</span><span id="TagSet.get-104"><a href="#TagSet.get-104"><span class="linenos">104</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve the value for a specific tag key.</p>

<p>Args:
    key: Tag key to look up (string)</p>

<p>Returns:
    str: Tag value if found, None if key doesn't exist</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">cluster_name</span> <span class="o">=</span> <span class="n">tags</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">cluster_name</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instance belongs to cluster: </span><span class="si">{</span><span class="n">cluster_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="TagSet.to_list" class="classattr">
                                        <input id="TagSet.to_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TagSet.to_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TagSet.to_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TagSet.to_list-106"><a href="#TagSet.to_list-106"><span class="linenos">106</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TagSet.to_list-107"><a href="#TagSet.to_list-107"><span class="linenos">107</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert tag set to AWS-compatible list format.</span>
</span><span id="TagSet.to_list-108"><a href="#TagSet.to_list-108"><span class="linenos">108</span></a>
</span><span id="TagSet.to_list-109"><a href="#TagSet.to_list-109"><span class="linenos">109</span></a><span class="sd">        Returns:</span>
</span><span id="TagSet.to_list-110"><a href="#TagSet.to_list-110"><span class="linenos">110</span></a><span class="sd">            list: List of tag dictionaries in AWS format [{&#39;Key&#39;: &#39;k&#39;, &#39;Value&#39;: &#39;v&#39;}, ...]</span>
</span><span id="TagSet.to_list-111"><a href="#TagSet.to_list-111"><span class="linenos">111</span></a>
</span><span id="TagSet.to_list-112"><a href="#TagSet.to_list-112"><span class="linenos">112</span></a><span class="sd">        Example:</span>
</span><span id="TagSet.to_list-113"><a href="#TagSet.to_list-113"><span class="linenos">113</span></a><span class="sd">            ```python</span>
</span><span id="TagSet.to_list-114"><a href="#TagSet.to_list-114"><span class="linenos">114</span></a><span class="sd">            tags = TagSet()</span>
</span><span id="TagSet.to_list-115"><a href="#TagSet.to_list-115"><span class="linenos">115</span></a><span class="sd">            tags.add(&#39;Name&#39;, &#39;web-server&#39;)</span>
</span><span id="TagSet.to_list-116"><a href="#TagSet.to_list-116"><span class="linenos">116</span></a><span class="sd">            tags.add(&#39;Environment&#39;, &#39;prod&#39;)</span>
</span><span id="TagSet.to_list-117"><a href="#TagSet.to_list-117"><span class="linenos">117</span></a>
</span><span id="TagSet.to_list-118"><a href="#TagSet.to_list-118"><span class="linenos">118</span></a><span class="sd">            # Use with AWS API</span>
</span><span id="TagSet.to_list-119"><a href="#TagSet.to_list-119"><span class="linenos">119</span></a><span class="sd">            ec2.create_tags(Resources=[instance_id], Tags=tags.to_list())</span>
</span><span id="TagSet.to_list-120"><a href="#TagSet.to_list-120"><span class="linenos">120</span></a><span class="sd">            ```</span>
</span><span id="TagSet.to_list-121"><a href="#TagSet.to_list-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TagSet.to_list-122"><a href="#TagSet.to_list-122"><span class="linenos">122</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tags</span>
</span></pre></div>


            <div class="docstring"><p>Convert tag set to AWS-compatible list format.</p>

<p>Returns:
    list: List of tag dictionaries in AWS format [{'Key': 'k', 'Value': 'v'}, ...]</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">tags</span> <span class="o">=</span> <span class="n">TagSet</span><span class="p">()</span>
<span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;web-server&#39;</span><span class="p">)</span>
<span class="n">tags</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;Environment&#39;</span><span class="p">,</span> <span class="s1">&#39;prod&#39;</span><span class="p">)</span>

<span class="c1"># Use with AWS API</span>
<span class="n">ec2</span><span class="o">.</span><span class="n">create_tags</span><span class="p">(</span><span class="n">Resources</span><span class="o">=</span><span class="p">[</span><span class="n">instance_id</span><span class="p">],</span> <span class="n">Tags</span><span class="o">=</span><span class="n">tags</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                </section>
                <section id="FilterSet">
                            <input id="FilterSet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FilterSet</span>:

                <label class="view-source-button" for="FilterSet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FilterSet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FilterSet-30"><a href="#FilterSet-30"><span class="linenos"> 30</span></a><span class="k">class</span><span class="w"> </span><span class="nc">FilterSet</span><span class="p">:</span>
</span><span id="FilterSet-31"><a href="#FilterSet-31"><span class="linenos"> 31</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper class for managing AWS resource filters.</span>
</span><span id="FilterSet-32"><a href="#FilterSet-32"><span class="linenos"> 32</span></a>
</span><span id="FilterSet-33"><a href="#FilterSet-33"><span class="linenos"> 33</span></a><span class="sd">    Provides a convenient interface for working with AWS filters, which are</span>
</span><span id="FilterSet-34"><a href="#FilterSet-34"><span class="linenos"> 34</span></a><span class="sd">    typically represented as lists of Name/Values dictionaries. This class</span>
</span><span id="FilterSet-35"><a href="#FilterSet-35"><span class="linenos"> 35</span></a><span class="sd">    abstracts the details of the AWS filter format and provides simple methods</span>
</span><span id="FilterSet-36"><a href="#FilterSet-36"><span class="linenos"> 36</span></a><span class="sd">    for building complex filter expressions.</span>
</span><span id="FilterSet-37"><a href="#FilterSet-37"><span class="linenos"> 37</span></a>
</span><span id="FilterSet-38"><a href="#FilterSet-38"><span class="linenos"> 38</span></a><span class="sd">    Attributes:</span>
</span><span id="FilterSet-39"><a href="#FilterSet-39"><span class="linenos"> 39</span></a><span class="sd">        _filters: Internal list of filter dictionaries in AWS format</span>
</span><span id="FilterSet-40"><a href="#FilterSet-40"><span class="linenos"> 40</span></a>
</span><span id="FilterSet-41"><a href="#FilterSet-41"><span class="linenos"> 41</span></a><span class="sd">    Example:</span>
</span><span id="FilterSet-42"><a href="#FilterSet-42"><span class="linenos"> 42</span></a><span class="sd">        ```python</span>
</span><span id="FilterSet-43"><a href="#FilterSet-43"><span class="linenos"> 43</span></a><span class="sd">        # Create empty filter set</span>
</span><span id="FilterSet-44"><a href="#FilterSet-44"><span class="linenos"> 44</span></a><span class="sd">        filters = FilterSet()</span>
</span><span id="FilterSet-45"><a href="#FilterSet-45"><span class="linenos"> 45</span></a>
</span><span id="FilterSet-46"><a href="#FilterSet-46"><span class="linenos"> 46</span></a><span class="sd">        # Add filters</span>
</span><span id="FilterSet-47"><a href="#FilterSet-47"><span class="linenos"> 47</span></a><span class="sd">        filters.add(&#39;tag:Environment&#39;, &#39;production&#39;)</span>
</span><span id="FilterSet-48"><a href="#FilterSet-48"><span class="linenos"> 48</span></a><span class="sd">        filters.add(&#39;instance-state-name&#39;, [&#39;running&#39;, &#39;stopped&#39;])</span>
</span><span id="FilterSet-49"><a href="#FilterSet-49"><span class="linenos"> 49</span></a>
</span><span id="FilterSet-50"><a href="#FilterSet-50"><span class="linenos"> 50</span></a><span class="sd">        # Use with AWS EC2 API</span>
</span><span id="FilterSet-51"><a href="#FilterSet-51"><span class="linenos"> 51</span></a><span class="sd">        instances = ec2.instances.filter(Filters=filters.to_list())</span>
</span><span id="FilterSet-52"><a href="#FilterSet-52"><span class="linenos"> 52</span></a><span class="sd">        ```</span>
</span><span id="FilterSet-53"><a href="#FilterSet-53"><span class="linenos"> 53</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FilterSet-54"><a href="#FilterSet-54"><span class="linenos"> 54</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="FilterSet-55"><a href="#FilterSet-55"><span class="linenos"> 55</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize FilterSet with optional existing filters.</span>
</span><span id="FilterSet-56"><a href="#FilterSet-56"><span class="linenos"> 56</span></a>
</span><span id="FilterSet-57"><a href="#FilterSet-57"><span class="linenos"> 57</span></a><span class="sd">        Args:</span>
</span><span id="FilterSet-58"><a href="#FilterSet-58"><span class="linenos"> 58</span></a><span class="sd">            filters: List of filter dictionaries in AWS format (optional).</span>
</span><span id="FilterSet-59"><a href="#FilterSet-59"><span class="linenos"> 59</span></a><span class="sd">                    If None, creates empty filter set.</span>
</span><span id="FilterSet-60"><a href="#FilterSet-60"><span class="linenos"> 60</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet-61"><a href="#FilterSet-61"><span class="linenos"> 61</span></a>        <span class="k">if</span> <span class="n">filters</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FilterSet-62"><a href="#FilterSet-62"><span class="linenos"> 62</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FilterSet-63"><a href="#FilterSet-63"><span class="linenos"> 63</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FilterSet-64"><a href="#FilterSet-64"><span class="linenos"> 64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="n">filters</span>
</span><span id="FilterSet-65"><a href="#FilterSet-65"><span class="linenos"> 65</span></a>
</span><span id="FilterSet-66"><a href="#FilterSet-66"><span class="linenos"> 66</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
</span><span id="FilterSet-67"><a href="#FilterSet-67"><span class="linenos"> 67</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new filter to the filter set.</span>
</span><span id="FilterSet-68"><a href="#FilterSet-68"><span class="linenos"> 68</span></a>
</span><span id="FilterSet-69"><a href="#FilterSet-69"><span class="linenos"> 69</span></a><span class="sd">        Args:</span>
</span><span id="FilterSet-70"><a href="#FilterSet-70"><span class="linenos"> 70</span></a><span class="sd">            name: Filter name (string) - e.g., &#39;tag:Cluster&#39;, &#39;instance-state-name&#39;</span>
</span><span id="FilterSet-71"><a href="#FilterSet-71"><span class="linenos"> 71</span></a><span class="sd">            values: Filter values (string or list of strings)</span>
</span><span id="FilterSet-72"><a href="#FilterSet-72"><span class="linenos"> 72</span></a>
</span><span id="FilterSet-73"><a href="#FilterSet-73"><span class="linenos"> 73</span></a><span class="sd">        Example:</span>
</span><span id="FilterSet-74"><a href="#FilterSet-74"><span class="linenos"> 74</span></a><span class="sd">            ```python</span>
</span><span id="FilterSet-75"><a href="#FilterSet-75"><span class="linenos"> 75</span></a><span class="sd">            filters.add(&#39;tag:Environment&#39;, &#39;production&#39;)</span>
</span><span id="FilterSet-76"><a href="#FilterSet-76"><span class="linenos"> 76</span></a><span class="sd">            filters.add(&#39;instance-state-name&#39;, [&#39;running&#39;, &#39;stopped&#39;])</span>
</span><span id="FilterSet-77"><a href="#FilterSet-77"><span class="linenos"> 77</span></a><span class="sd">            ```</span>
</span><span id="FilterSet-78"><a href="#FilterSet-78"><span class="linenos"> 78</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet-79"><a href="#FilterSet-79"><span class="linenos"> 79</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="FilterSet-80"><a href="#FilterSet-80"><span class="linenos"> 80</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
</span><span id="FilterSet-81"><a href="#FilterSet-81"><span class="linenos"> 81</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">}</span>
</span><span id="FilterSet-82"><a href="#FilterSet-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="FilterSet-83"><a href="#FilterSet-83"><span class="linenos"> 83</span></a>
</span><span id="FilterSet-84"><a href="#FilterSet-84"><span class="linenos"> 84</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="FilterSet-85"><a href="#FilterSet-85"><span class="linenos"> 85</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the values for a specific filter name.</span>
</span><span id="FilterSet-86"><a href="#FilterSet-86"><span class="linenos"> 86</span></a>
</span><span id="FilterSet-87"><a href="#FilterSet-87"><span class="linenos"> 87</span></a><span class="sd">        Args:</span>
</span><span id="FilterSet-88"><a href="#FilterSet-88"><span class="linenos"> 88</span></a><span class="sd">            name: Filter name to look up (string)</span>
</span><span id="FilterSet-89"><a href="#FilterSet-89"><span class="linenos"> 89</span></a>
</span><span id="FilterSet-90"><a href="#FilterSet-90"><span class="linenos"> 90</span></a><span class="sd">        Returns:</span>
</span><span id="FilterSet-91"><a href="#FilterSet-91"><span class="linenos"> 91</span></a><span class="sd">            list: Filter values if found, None if name doesn&#39;t exist</span>
</span><span id="FilterSet-92"><a href="#FilterSet-92"><span class="linenos"> 92</span></a>
</span><span id="FilterSet-93"><a href="#FilterSet-93"><span class="linenos"> 93</span></a><span class="sd">        Example:</span>
</span><span id="FilterSet-94"><a href="#FilterSet-94"><span class="linenos"> 94</span></a><span class="sd">            ```python</span>
</span><span id="FilterSet-95"><a href="#FilterSet-95"><span class="linenos"> 95</span></a><span class="sd">            cluster_values = filters.get(&#39;tag:Cluster&#39;)</span>
</span><span id="FilterSet-96"><a href="#FilterSet-96"><span class="linenos"> 96</span></a><span class="sd">            if cluster_values:</span>
</span><span id="FilterSet-97"><a href="#FilterSet-97"><span class="linenos"> 97</span></a><span class="sd">                print(f&quot;Filtering for clusters: {cluster_values}&quot;)</span>
</span><span id="FilterSet-98"><a href="#FilterSet-98"><span class="linenos"> 98</span></a><span class="sd">            ```</span>
</span><span id="FilterSet-99"><a href="#FilterSet-99"><span class="linenos"> 99</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet-100"><a href="#FilterSet-100"><span class="linenos">100</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">:</span>
</span><span id="FilterSet-101"><a href="#FilterSet-101"><span class="linenos">101</span></a>            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="FilterSet-102"><a href="#FilterSet-102"><span class="linenos">102</span></a>                <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Values&#39;</span><span class="p">]</span>
</span><span id="FilterSet-103"><a href="#FilterSet-103"><span class="linenos">103</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span><span id="FilterSet-104"><a href="#FilterSet-104"><span class="linenos">104</span></a>
</span><span id="FilterSet-105"><a href="#FilterSet-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="FilterSet-106"><a href="#FilterSet-106"><span class="linenos">106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert filter set to AWS-compatible list format.</span>
</span><span id="FilterSet-107"><a href="#FilterSet-107"><span class="linenos">107</span></a>
</span><span id="FilterSet-108"><a href="#FilterSet-108"><span class="linenos">108</span></a><span class="sd">        Returns:</span>
</span><span id="FilterSet-109"><a href="#FilterSet-109"><span class="linenos">109</span></a><span class="sd">            list: List of filter dictionaries in AWS format [{&#39;Name&#39;: &#39;n&#39;, &#39;Values&#39;: [&#39;v&#39;]}, ...]</span>
</span><span id="FilterSet-110"><a href="#FilterSet-110"><span class="linenos">110</span></a>
</span><span id="FilterSet-111"><a href="#FilterSet-111"><span class="linenos">111</span></a><span class="sd">        Example:</span>
</span><span id="FilterSet-112"><a href="#FilterSet-112"><span class="linenos">112</span></a><span class="sd">            ```python</span>
</span><span id="FilterSet-113"><a href="#FilterSet-113"><span class="linenos">113</span></a><span class="sd">            filters = FilterSet()</span>
</span><span id="FilterSet-114"><a href="#FilterSet-114"><span class="linenos">114</span></a><span class="sd">            filters.add(&#39;tag:Environment&#39;, &#39;production&#39;)</span>
</span><span id="FilterSet-115"><a href="#FilterSet-115"><span class="linenos">115</span></a><span class="sd">            filters.add(&#39;instance-state-name&#39;, &#39;running&#39;)</span>
</span><span id="FilterSet-116"><a href="#FilterSet-116"><span class="linenos">116</span></a>
</span><span id="FilterSet-117"><a href="#FilterSet-117"><span class="linenos">117</span></a><span class="sd">            # Use with AWS API</span>
</span><span id="FilterSet-118"><a href="#FilterSet-118"><span class="linenos">118</span></a><span class="sd">            instances = ec2.instances.filter(Filters=filters.to_list())</span>
</span><span id="FilterSet-119"><a href="#FilterSet-119"><span class="linenos">119</span></a><span class="sd">            ```</span>
</span><span id="FilterSet-120"><a href="#FilterSet-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet-121"><a href="#FilterSet-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span>
</span></pre></div>


            <div class="docstring"><p>Wrapper class for managing AWS resource filters.</p>

<p>Provides a convenient interface for working with AWS filters, which are
typically represented as lists of Name/Values dictionaries. This class
abstracts the details of the AWS filter format and provides simple methods
for building complex filter expressions.</p>

<p>Attributes:
    _filters: Internal list of filter dictionaries in AWS format</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="c1"># Create empty filter set</span>
<span class="n">filters</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">()</span>

<span class="c1"># Add filters</span>
<span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:Environment&#39;</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
<span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">])</span>

<span class="c1"># Use with AWS EC2 API</span>
<span class="n">instances</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
</code></pre>
</div>
</code></pre>
</div>


                            <div id="FilterSet.__init__" class="classattr">
                                        <input id="FilterSet.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FilterSet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filters</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="FilterSet.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FilterSet.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FilterSet.__init__-54"><a href="#FilterSet.__init__-54"><span class="linenos">54</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="FilterSet.__init__-55"><a href="#FilterSet.__init__-55"><span class="linenos">55</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize FilterSet with optional existing filters.</span>
</span><span id="FilterSet.__init__-56"><a href="#FilterSet.__init__-56"><span class="linenos">56</span></a>
</span><span id="FilterSet.__init__-57"><a href="#FilterSet.__init__-57"><span class="linenos">57</span></a><span class="sd">        Args:</span>
</span><span id="FilterSet.__init__-58"><a href="#FilterSet.__init__-58"><span class="linenos">58</span></a><span class="sd">            filters: List of filter dictionaries in AWS format (optional).</span>
</span><span id="FilterSet.__init__-59"><a href="#FilterSet.__init__-59"><span class="linenos">59</span></a><span class="sd">                    If None, creates empty filter set.</span>
</span><span id="FilterSet.__init__-60"><a href="#FilterSet.__init__-60"><span class="linenos">60</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet.__init__-61"><a href="#FilterSet.__init__-61"><span class="linenos">61</span></a>        <span class="k">if</span> <span class="n">filters</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="FilterSet.__init__-62"><a href="#FilterSet.__init__-62"><span class="linenos">62</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="FilterSet.__init__-63"><a href="#FilterSet.__init__-63"><span class="linenos">63</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="FilterSet.__init__-64"><a href="#FilterSet.__init__-64"><span class="linenos">64</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="n">filters</span>
</span></pre></div>


            <div class="docstring"><p>Initialize FilterSet with optional existing filters.</p>

<p>Args:
    filters: List of filter dictionaries in AWS format (optional).
            If None, creates empty filter set.</p>
</div>


                            </div>
                            <div id="FilterSet.add" class="classattr">
                                        <input id="FilterSet.add-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span>, </span><span class="param"><span class="n">values</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FilterSet.add-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FilterSet.add"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FilterSet.add-66"><a href="#FilterSet.add-66"><span class="linenos">66</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
</span><span id="FilterSet.add-67"><a href="#FilterSet.add-67"><span class="linenos">67</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new filter to the filter set.</span>
</span><span id="FilterSet.add-68"><a href="#FilterSet.add-68"><span class="linenos">68</span></a>
</span><span id="FilterSet.add-69"><a href="#FilterSet.add-69"><span class="linenos">69</span></a><span class="sd">        Args:</span>
</span><span id="FilterSet.add-70"><a href="#FilterSet.add-70"><span class="linenos">70</span></a><span class="sd">            name: Filter name (string) - e.g., &#39;tag:Cluster&#39;, &#39;instance-state-name&#39;</span>
</span><span id="FilterSet.add-71"><a href="#FilterSet.add-71"><span class="linenos">71</span></a><span class="sd">            values: Filter values (string or list of strings)</span>
</span><span id="FilterSet.add-72"><a href="#FilterSet.add-72"><span class="linenos">72</span></a>
</span><span id="FilterSet.add-73"><a href="#FilterSet.add-73"><span class="linenos">73</span></a><span class="sd">        Example:</span>
</span><span id="FilterSet.add-74"><a href="#FilterSet.add-74"><span class="linenos">74</span></a><span class="sd">            ```python</span>
</span><span id="FilterSet.add-75"><a href="#FilterSet.add-75"><span class="linenos">75</span></a><span class="sd">            filters.add(&#39;tag:Environment&#39;, &#39;production&#39;)</span>
</span><span id="FilterSet.add-76"><a href="#FilterSet.add-76"><span class="linenos">76</span></a><span class="sd">            filters.add(&#39;instance-state-name&#39;, [&#39;running&#39;, &#39;stopped&#39;])</span>
</span><span id="FilterSet.add-77"><a href="#FilterSet.add-77"><span class="linenos">77</span></a><span class="sd">            ```</span>
</span><span id="FilterSet.add-78"><a href="#FilterSet.add-78"><span class="linenos">78</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet.add-79"><a href="#FilterSet.add-79"><span class="linenos">79</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="FilterSet.add-80"><a href="#FilterSet.add-80"><span class="linenos">80</span></a>            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="p">]</span>
</span><span id="FilterSet.add-81"><a href="#FilterSet.add-81"><span class="linenos">81</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;Values&#39;</span><span class="p">:</span> <span class="n">values</span><span class="p">}</span>
</span><span id="FilterSet.add-82"><a href="#FilterSet.add-82"><span class="linenos">82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Add a new filter to the filter set.</p>

<p>Args:
    name: Filter name (string) - e.g., 'tag:Cluster', 'instance-state-name'
    values: Filter values (string or list of strings)</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:Environment&#39;</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
<span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">,</span> <span class="s1">&#39;stopped&#39;</span><span class="p">])</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="FilterSet.get" class="classattr">
                                        <input id="FilterSet.get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FilterSet.get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FilterSet.get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FilterSet.get-84"><a href="#FilterSet.get-84"><span class="linenos"> 84</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="FilterSet.get-85"><a href="#FilterSet.get-85"><span class="linenos"> 85</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve the values for a specific filter name.</span>
</span><span id="FilterSet.get-86"><a href="#FilterSet.get-86"><span class="linenos"> 86</span></a>
</span><span id="FilterSet.get-87"><a href="#FilterSet.get-87"><span class="linenos"> 87</span></a><span class="sd">        Args:</span>
</span><span id="FilterSet.get-88"><a href="#FilterSet.get-88"><span class="linenos"> 88</span></a><span class="sd">            name: Filter name to look up (string)</span>
</span><span id="FilterSet.get-89"><a href="#FilterSet.get-89"><span class="linenos"> 89</span></a>
</span><span id="FilterSet.get-90"><a href="#FilterSet.get-90"><span class="linenos"> 90</span></a><span class="sd">        Returns:</span>
</span><span id="FilterSet.get-91"><a href="#FilterSet.get-91"><span class="linenos"> 91</span></a><span class="sd">            list: Filter values if found, None if name doesn&#39;t exist</span>
</span><span id="FilterSet.get-92"><a href="#FilterSet.get-92"><span class="linenos"> 92</span></a>
</span><span id="FilterSet.get-93"><a href="#FilterSet.get-93"><span class="linenos"> 93</span></a><span class="sd">        Example:</span>
</span><span id="FilterSet.get-94"><a href="#FilterSet.get-94"><span class="linenos"> 94</span></a><span class="sd">            ```python</span>
</span><span id="FilterSet.get-95"><a href="#FilterSet.get-95"><span class="linenos"> 95</span></a><span class="sd">            cluster_values = filters.get(&#39;tag:Cluster&#39;)</span>
</span><span id="FilterSet.get-96"><a href="#FilterSet.get-96"><span class="linenos"> 96</span></a><span class="sd">            if cluster_values:</span>
</span><span id="FilterSet.get-97"><a href="#FilterSet.get-97"><span class="linenos"> 97</span></a><span class="sd">                print(f&quot;Filtering for clusters: {cluster_values}&quot;)</span>
</span><span id="FilterSet.get-98"><a href="#FilterSet.get-98"><span class="linenos"> 98</span></a><span class="sd">            ```</span>
</span><span id="FilterSet.get-99"><a href="#FilterSet.get-99"><span class="linenos"> 99</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet.get-100"><a href="#FilterSet.get-100"><span class="linenos">100</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">:</span>
</span><span id="FilterSet.get-101"><a href="#FilterSet.get-101"><span class="linenos">101</span></a>            <span class="k">if</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
</span><span id="FilterSet.get-102"><a href="#FilterSet.get-102"><span class="linenos">102</span></a>                <span class="k">return</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;Values&#39;</span><span class="p">]</span>
</span><span id="FilterSet.get-103"><a href="#FilterSet.get-103"><span class="linenos">103</span></a>        <span class="k">return</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Retrieve the values for a specific filter name.</p>

<p>Args:
    name: Filter name to look up (string)</p>

<p>Returns:
    list: Filter values if found, None if name doesn't exist</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">cluster_values</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tag:Cluster&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">cluster_values</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering for clusters: </span><span class="si">{</span><span class="n">cluster_values</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="FilterSet.to_list" class="classattr">
                                        <input id="FilterSet.to_list-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_list</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="FilterSet.to_list-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FilterSet.to_list"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FilterSet.to_list-105"><a href="#FilterSet.to_list-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="FilterSet.to_list-106"><a href="#FilterSet.to_list-106"><span class="linenos">106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert filter set to AWS-compatible list format.</span>
</span><span id="FilterSet.to_list-107"><a href="#FilterSet.to_list-107"><span class="linenos">107</span></a>
</span><span id="FilterSet.to_list-108"><a href="#FilterSet.to_list-108"><span class="linenos">108</span></a><span class="sd">        Returns:</span>
</span><span id="FilterSet.to_list-109"><a href="#FilterSet.to_list-109"><span class="linenos">109</span></a><span class="sd">            list: List of filter dictionaries in AWS format [{&#39;Name&#39;: &#39;n&#39;, &#39;Values&#39;: [&#39;v&#39;]}, ...]</span>
</span><span id="FilterSet.to_list-110"><a href="#FilterSet.to_list-110"><span class="linenos">110</span></a>
</span><span id="FilterSet.to_list-111"><a href="#FilterSet.to_list-111"><span class="linenos">111</span></a><span class="sd">        Example:</span>
</span><span id="FilterSet.to_list-112"><a href="#FilterSet.to_list-112"><span class="linenos">112</span></a><span class="sd">            ```python</span>
</span><span id="FilterSet.to_list-113"><a href="#FilterSet.to_list-113"><span class="linenos">113</span></a><span class="sd">            filters = FilterSet()</span>
</span><span id="FilterSet.to_list-114"><a href="#FilterSet.to_list-114"><span class="linenos">114</span></a><span class="sd">            filters.add(&#39;tag:Environment&#39;, &#39;production&#39;)</span>
</span><span id="FilterSet.to_list-115"><a href="#FilterSet.to_list-115"><span class="linenos">115</span></a><span class="sd">            filters.add(&#39;instance-state-name&#39;, &#39;running&#39;)</span>
</span><span id="FilterSet.to_list-116"><a href="#FilterSet.to_list-116"><span class="linenos">116</span></a>
</span><span id="FilterSet.to_list-117"><a href="#FilterSet.to_list-117"><span class="linenos">117</span></a><span class="sd">            # Use with AWS API</span>
</span><span id="FilterSet.to_list-118"><a href="#FilterSet.to_list-118"><span class="linenos">118</span></a><span class="sd">            instances = ec2.instances.filter(Filters=filters.to_list())</span>
</span><span id="FilterSet.to_list-119"><a href="#FilterSet.to_list-119"><span class="linenos">119</span></a><span class="sd">            ```</span>
</span><span id="FilterSet.to_list-120"><a href="#FilterSet.to_list-120"><span class="linenos">120</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FilterSet.to_list-121"><a href="#FilterSet.to_list-121"><span class="linenos">121</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span>
</span></pre></div>


            <div class="docstring"><p>Convert filter set to AWS-compatible list format.</p>

<p>Returns:
    list: List of filter dictionaries in AWS format [{'Name': 'n', 'Values': ['v']}, ...]</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">filters</span> <span class="o">=</span> <span class="n">FilterSet</span><span class="p">()</span>
<span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;tag:Environment&#39;</span><span class="p">,</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span>
<span class="n">filters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;instance-state-name&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">)</span>

<span class="c1"># Use with AWS API</span>
<span class="n">instances</span> <span class="o">=</span> <span class="n">ec2</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Filters</span><span class="o">=</span><span class="n">filters</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>